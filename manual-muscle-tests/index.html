<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MMT Trainer </title>
 <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/favicon-192.png">
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
:root{
  --bg:#f1f5f9; --panel:#ffffff; --line:#cbd5e1; --ctrl:#e2e8f0;
  --text:#0f172a; --muted:#64748b; --primary:#0d9488; --accent:#facc15;
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);overflow:hidden;font-family:system-ui,Segoe UI,Roboto}
canvas{position:fixed;inset:0;width:100%;height:100%;display:block}
.zoom-buttons{
  display:flex;
  gap:2px;
  margin-left:auto;          /* push them to the right side of header */
}

.zoom-buttons button{
  width:22px;
  height:22px;
  padding:0;
  border-radius:999px;
  border:1px solid var(--line);
  background:var(--ctrl);
  color:var(--text);
  font-size:14px;
  line-height:1;
  cursor:pointer;
}

.panel{position:fixed;left:25px;top:12px;width:380px;max-height:92vh;z-index:100;background:var(--panel);
  border:1px solid var(--line);border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.15);display:flex;flex-direction:column;overflow:hidden}
.dragbar{cursor:move;background:var(--ctrl);border-bottom:1px solid var(--line);padding:8px 12px;font-weight:700;display:flex;align-items:center;gap:8px}
.dragbar .hint{margin-left:auto;font-size:12px;color:var(--muted)}
.content{padding:12px;overflow:auto}
label{display:block;font-size:12px;margin-top:8px;color:var(--muted)}
select,button,input[type=range]{width:100%;margin:6px 0 8px 0;padding:8px 10px;border-radius:10px;background:var(--ctrl);border:1px solid var(--line);color:var(--text)}
.row{display:flex;gap:8px}.row>button,.row>select{flex:1}
.mini{padding:6px 10px;border-radius:8px;background:var(--ctrl);border:1px solid var(--line)}
.lockOn{background:#0b3a1f;border-color:#16a34a;color:#fff}

#boneTuner, #handTuner, #vectorTuner, [style*="rgba(8, 13, 26, 0.96)"] { display: none !important; }

/* --- NEW CSS for the Resistance Fill Bar --- */
#testButton {
  /* This is necessary for #resistanceFill to position relative to the button */
  position: relative; 
  overflow: hidden; /* Ensures the fill bar stays within the button edges */
}

#resistanceFill {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%; /* Must fill the button's height */
  width: 0%;   /* Starts at 0% width */
  z-index: 1;  /* Keeps the fill behind the text */
  pointer-events: none; /* Allows click events to pass through to the button */
}

#resistanceText {
  position: relative; /* Brings the text forward, above the fill bar */
  z-index: 2; 
}  
#msg{position:fixed;bottom:210px;left:12px;background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:6px 10px;font-size:12px;z-index:25;color:var(--text)}
#log{display:none;background:var(--ctrl);border:1px solid var(--line);min-height:90px;max-height:90px;overflow:auto;border-radius:8px;padding:8px;font-size:12px;white-space:pre-wrap;color:var(--text)}
.flex-btn-group { display: flex; justify-content: space-between; align-items: stretch; }
.flex-btn-group { display: flex; justify-content: space-between; align-items: stretch; gap: 4px; } .multi-line-btn { flex-grow: 1; margin-right: 0; text-align: center; font-size: 11px; line-height: 1.1; padding: 4px 6px; }  
.multi-line-btn { flex-grow: 1; margin-right: 8px; text-align: center; font-size: 14px; line-height: 1.2; padding: 8px 6px; }
.multi-line-btn:last-child { margin-right: 0; }
#notePanel{
  position:fixed;top:16px;right:16px;width:min(420px,46vw);max-height:70vh;display:none;z-index:140;
  background:#e2e8f0;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.25);
  display:flex;flex-direction:column;overflow:hidden;
}

#toggleHandsBtn.lockOn,#toggleHandsBtn:disabled{background:#cbd5e1!important;color:#475569!important;border-color:#94a3b8!important;box-shadow:none!important;filter:grayscale(1)!important;opacity:.55!important;pointer-events:none!important;}
  background:#e2e8f0;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.25);
  display:flex;flex-direction:column;overflow:hidden}
.note-head{display:flex;align-items:center;gap:8px;padding:10px 12px;background:#dbe4ee;border-bottom:1px solid var(--line)}
.note-head h3{margin:0;font-size:16px;font-weight:800;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.note-tabs{display:flex;gap:8px}
.note-tabs button{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#fff}
.note-tabs button.active{background:#0d9488;color:#fff;border-color:#0d9488}
.note-body{padding:12px;overflow:auto;background:#fff}
.note-close{border-radius:8px;border:1px solid var(--line);padding:6px 10px;background:#fff}
@media (max-width: 720px){
  #notePanel{right:8px;left:8px;width:auto;max-height:60vh}
}
.hide{display:none !important;}
</style>
</head>
<body>

<div class="panel" id="panel">
  <div class="dragbar" id="dragbar" style="display: flex; align-items: center; padding: 5px 12px;">
    <a href="/" aria-label="Return to home">
      <img src="/rometrics-logo.png" style="height:44px; width:auto; vertical-align:middle; margin-right:10px;" alt="ROMetrics">
    </a>MMT Trainer
    <div class="zoom-buttons">
      <button id="zoomInBtn" type="button">+</button>
      <button id="zoomOutBtn" type="button">‚àí</button>
    </div>
  </div>


  <div class="content">
    <label>MMT Test & Muscle</label>
    <select id="actionSel">
      <option value="">(Select a test to begin‚Ä¶)</option>
      <optgroup label="Cervical & Capital">
        <option value="Capital_Extension">Capital Extension (Rectus Capitis Posterior Major, Obliquus Capitis Superior, Splenius Capitis)</option>
        <option value="Cervical_Extension">Cervical Extension (Semispinalis Cervicis, Splenius Cervicis, Longissimus Cervicis)</option>
        <option value="Capital_Flexion">Capital Flexion ‚Äî Chin Tuck (Longus Capitis, Rectus Capitis Anterior, Anterior Scalene)</option>
        <option value="Cervical_Flexion">Cervical Flexion (Sternocleidomastoid, Longus Colli, Anterior Scalene)</option>
        <option value="Single_SCM">Single SCM ‚Äî Anterolateral Flexion (SCM, Longus Capitis, Longus Colli)</option>
        <option value="Cervical_Rotation">Cervical Rotation (SCM‚Äîcontralateral; Splenius Capitis‚Äîipsilateral; Longissimus Capitis‚Äîipsilateral)</option>
      </optgroup>
      <optgroup label="Scapula">
        <option value="Serratus_Anterior">Scapular Abduction & Upward Rotation (Serratus Anterior)</option>
        <option value="Upper_Trapezius">Scapular Elevation (Upper Trapezius, Levator Scapulae)</option>
        <option value="Middle_Trapezius">Scapular Adduction / Retraction (Middle Trapezius)</option>
        <option value="Scap_Depression_Adduction">Scapular Depression + Adduction (Lower Trapezius)</option>
        <option value="Rhomboids">Scapular Adduction + Downward Rotation (Rhomboids)</option>
        <option value="Latissimus_Dorsi">Latissimus Dorsi (shoulder depression/extension pattern)</option>
      </optgroup>
      <optgroup label="Shoulder">
        <option value="Anterior_Deltoid">Shoulder Flexion (Anterior Deltoid, Coracobrachialis)</option>
        <option value="Posterior_Deltoid">Shoulder Extension (Posterior Deltoid, Lat, Teres Major)</option>
        <option value="Middle_Deltoid">Shoulder Abduction (Middle Deltoid, Supraspinatus)</option>
        <option value="Shoulder_Horiz_Abd">Shoulder Horizontal Abduction (Posterior Deltoid)</option>
        <option value="Shoulder_Horiz_Add">Shoulder Horizontal Adduction (Pectoralis Major)</option>
        <option value="Infraspinatus">Shoulder External Rotation (Infraspinatus, Teres Minor)</option>
        <option value="Subscapularis">Shoulder Internal Rotation (Subscapularis, Teres Major, Pec Major, Lat)</option>
      </optgroup>
      <optgroup label="Trunk & Pelvis - Grading Exception">
        <option value="Trunk_Ext_Lumbar">Trunk Extension ‚Äî Lumbar (Erector Spinae)</option>
        <option value="Trunk_Ext_Thoracic">Trunk Extension ‚Äî Thoracic (Erector Spinae)</option>
        <option value="Trunk_Flexion">Trunk Flexion ‚Äî Rectus Abdominis</option>
        <option value="Trunk_Rotation">Trunk Rotation ‚Äî External & Internal Obliques</option>
        <option value="Pelvic_Elevation">Pelvic Elevation (Hip Hike) ‚Äî Quadratus Lumborum</option>
      </optgroup>
      <optgroup label="Elbow">
        <option value="Biceps_Brachii">Elbow Flexion ‚Äî Biceps Brachii (supinated)</option>
        <option value="Brachialis">Elbow Flexion ‚Äî Brachialis (pronated)</option>
        <option value="Brachioradialis">Elbow Flexion ‚Äî Brachioradialis (neutral)</option>
        <option value="Triceps_Brachii">Elbow Extension ‚Äî Triceps Brachii</option>
      </optgroup>
      <optgroup label="Wrist">
        <option value="ECRL">Wrist Extension ‚Äî All Extensors</option>
        <option value="ECRB">Wrist Extension ‚Äî Extensor Carpi Radialis (ECRB/ECRL)</option>
        <option value="ECU">Wrist Extension ‚Äî Extensor Carpi Ulnaris (ECU)</option>
        <option value="FCR">Wrist Flexion ‚Äî Flexor Carpi Radialis (FCR)</option>
        <option value="FCU">Wrist Flexion ‚Äî Flexor Carpi Ulnaris (FCU)</option>
      </optgroup>
         <optgroup label="Hip">
        <option value="Iliopsoas">Hip Flexion (Iliopsoas)</option>
        <option value="Glute_Max">Hip Extension ‚Äî Gluteus Maximus</option>
        <option value="Glute_Med">Hip Abduction ‚Äî Gluteus Medius/Minimus</option>
        <option value="TFL">Hip Abduction from Flexed Position ‚Äî Tensor Fasciae Latae (TFL)</option>
        <option value="Hip_Adduction">Hip Adduction ‚Äî Adductor Group</option>
        <option value="Sartorius">Hip Flexion, Abduction, External Rotation with Knee Flexion ‚Äî Sartorius</option>
        <option value="Hip_ER">Hip External Rotation</option>
        <option value="Hip_IR">Hip Internal Rotation</option>
      </optgroup>
      <optgroup label="Knee">
        <option value="Hamstrings">Knee Flexion (Hamstrings)</option>
        <option value="Quadriceps">Knee Extension (Quadriceps)</option>
      </optgroup>
      <optgroup label="Ankle & Foot -  Grading Exception for Gastroc">
        <option value="Tibialis_Anterior">Dorsiflexion + Inversion (Tibialis Anterior)</option>
        <option value="Foot_Eversion_PF"> Plantarflexion + Eversion(Fibularis Longus, Fibularis Brevis)</option>
        <option value="Gastrocnemius">Plantar Flexion (Gastrocnemius, Soleus)</option>
      </optgroup>
    </select>

    <div class="row" style="margin-top:10px;">
      <button id="vectorOverlayBtn" class="mini">‚åñ Vector Overlay</button>
      <button id="showMMT" class="mini">üìå MMT Placement</button>
    </div>

    <div class="row" style="align-items:center; margin-top:10px;">
      <div style="flex:1;">
        <label>Test Grade Selection</label>
        <select id="grade-main" name="grade-main">
          <option value="3">Grade 3 - 5 (Full ROM Against Gravity)</option>
          <option value="2">Grades 0‚Äì2 (Gravity Eliminated)</option>
        </select>
      </div>
      <div style="flex:1;">
        <label>Grading Exceptions</label>
        <select id="GradingExceptions" name="GradingExceptions">
          <option value="5">Grade 5 (Full ROM / Maximum Resistance)</option>
          <option value="4">Grade 4 (Full ROM / Moderate Resistance)</option>
          <option value="3">Grade 3 (Full ROM / No Resistance)</option>
          <option value="2">Grade 2 (Partial/Full ROM - Gravity Eliminated)</option>
          <option value="1">Grade 1 (Trace Contraction)</option>
        </select>
      </div>
    </div>

<div class="row" style="margin-top:10px;">
¬† ¬† ¬† <button id="testButton" disabled>
¬† ¬† ¬† ¬† <div id="resistanceFill"></div> 
¬† ¬† ¬† ¬† <span id="resistanceText">Hold to Apply Resistance</span>
¬† ¬† ¬† </button>
¬† ¬† </div>
<p id="instructionText" style="font-size:8px; line-height:1.3; color:var(--muted);">
  <strong>‚Äú+ / ‚Äì‚Äù in MMT</strong> ‚Äî ‚Äú+‚Äù = closer to the next higher grade; ‚Äú‚àí‚Äù = closer to the next lower grade; <strong>3‚àí / 3 / 3+</strong> = less than full ROM ‚Üí full ROM (no resistance) ‚Üí full ROM with slight resistance; <strong>2 / 2‚àí</strong> = full vs partial ROM in gravity-eliminated position.
</p>


<div class="flex-btn-group" style="margin-top: 10px;">
  <button id="lockRoomBtn" class="mini multi-line-btn" title="Lock/Unlock the room environment">
    <span style="display: block;">Lock <br> Roomüîí</span>
  </button>

  <button id="toggleHandsBtn" class="mini multi-line-btn" title="Toggle therapist‚Äôs resistance and stabilizing hands">
    <span style="display: block;">Toggle <br> Hands</span>
  </button>
</div>
</div>
</div>

<div id="msg">Loading‚Ä¶</div>
<canvas id="c"></canvas>

<!-- Right-side notes panel -->
<div id="notePanel" class="hide">
  <div class="note-head">
    <h3 id="noteTitle">MMT Instructions</h3>
    <div class="note-tabs">
      <button id="tabHigh" class="active">Grades 3‚Äì5</button>
      <button id="tabLow">Grades 0‚Äì2</button>
    </div>
    <button class="note-close" id="closeNote">Close ‚úï</button>
  </div>
  <div class="note-body" id="noteBody">Loading‚Ä¶</div>
</div>
<script>
  // Use your live model path (uploaded in your repo)
window.ROMETRICS_MODEL_URL = "/assets/Roma_ROMetrics.glb";
</script>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { TransformControls } from "three/addons/controls/TransformControls.js"; // <-- Add the 3D Manipulation Widget  
import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
import { KTX2Loader } from "three/addons/loaders/KTX2Loader.js";
import { MeshoptDecoder } from "three/addons/libs/meshopt_decoder.module.js";
// <--- PLACE TOKEN DEFINITIONS HERE ADDING FOR TOKEN BEGINS---

const MMT_CASE_TOKENS = {
  // =========================
  // CASE 1
  // =========================
  "MMT-CERVICAL-001": {
    caseId: "case_mmt_001",
    label: "Cervical Impairment",

    // Define ALL regions available in the UI (if you use this)
    allRegions: [
      "Cervical & Capital",
      "Scapula",
      "Shoulder",
      "Trunk & Pelvis - Grading Exception",
      "Elbow",
      "Wrist",
      "Hip",
      "Knee",
      "Ankle & Foot - Grading Exception for Gastroc"
    ],

    // Define ONLY the regions allowed for this case
    allowedRegions: ["Cervical & Capital"],

    impairments: {
      Cervical_Rotation: { max_hold_time: 4.5 },
      Single_SCM:        { max_hold_time: 4.5 },

      default_unrestricted: { max_hold_time: 99.0 }
    }
  },

  // =========================
  // CASE 2  (HIP)
  // =========================
  "MMT-HIP-002": {
    caseId: "case_mmt_002",
    label: "Hip Case",

    // MUST match your <optgroup label="..."> text in the Action/Test dropdown
    allowedRegions: ["Hip", "Knee"],

 impairments: {
  Iliopsoas: { max_hold_time: 3.0 },  // ~3/5
  Glute_Med: { max_hold_time: 3.5 },  // ~3+/5 (still grades 3 with your thresholds)
  Glute_Max: { max_hold_time: 4.0 },  // ~4-/5

  default_unrestricted: { max_hold_time: 99.0 }
},


requiredTests: ["Iliopsoas", "Glute_Med", "Glute_Max", "Quadriceps", "Hamstrings"],


    resultsText: `
MMT Case Summary ‚Äî Hip

RIGHT:
- Hip Flexors (Iliopsoas, seated): 3/5 ‚Äî Full AG to ~50¬∞, breaks with resistance
- Hip Abductors (sidelying): 3+/5 ‚Äî Holds light resistance, fatigues quickly
- Hip Extensors (prone): 4-/5 ‚Äî Mild weakness, no major pain
- Quadriceps (seated): 5/5
- Hamstrings (prone): 5/5

LEFT:
- All listed muscle groups: 5/5
`.trim()
  }

  // =========================
  // DROP MORE CASES BELOW
  // Keep the comma rules:
  // - Add a comma AFTER each case object
  // - EXCEPT the very last case before the closing }
  // =========================

  // "MMT-CLUSTER-003": {
  //   caseId: "case_mmt_003",
  //   label: "Cluster Case",
  //   allowedRegions: ["..."],
  //   impairments: {
  //     // Your keys here...
  //     default_unrestricted: { max_hold_time: 99.0 }
  //   },
  //   requiredTests: ["..."],
  //   resultsText: `...`.trim()
  // }
};


  
// --- NEW: Global Tracker for Impaired MMT Tests ---
window.IMPAIRMENT_TRACKER = {
  // CASE 1
  "Single_SCM": false,
  "Cervical_Rotation": false,

  // CASE 2 (HIP)
  "Iliopsoas": false,
  "Hip_Abductors": false,
  "Hip_Extensors": false

  // DROP MORE TRACKED TEST KEYS BELOW (add comma above if you add new lines)
  // "CASE3_TEST_KEY_1": false,
  // "CASE3_TEST_KEY_2": false
};


// --- NEW: DETAILED CASE RESULTS TEXT (PER-CASE; NO BLEED) ---
const MMT_FULL_RESULTS = {
  "MMT-CERVICAL-001": `
MMT Case Summary: Right-Sided Cervical Deficit

‚úÖ Impaired Results (4/5 Strength):
- Right Cervical Rotators (Tested by: Cervical_Rotation)
- Right Lateral Flexion (Tested by: Single_SCM)

‚úÖ Unimpaired Results (5/5 Strength):
- Cervical Flexors (Full strength)
- Cervical Extensors (Full strength)
- All other groups (Full strength)
`.trim(),

  "MMT-HIP-002": `
MMT Case Summary ‚Äî Hip

RIGHT:
- Hip Flexors (Iliopsoas, seated): 3/5 ‚Äî Full AG to ~50¬∞, breaks with resistance
- Hip Abductors (sidelying): 3+/5 ‚Äî Holds light resistance, fatigues quickly
- Hip Extensors (prone): 4-/5 ‚Äî Mild weakness, no major pain
- Quadriceps (seated): 5/5
- Hamstrings (prone): 5/5

LEFT:
- All listed muscle groups: 5/5
`.trim(),

  // ---------- SLOT FOR NEW CASES ----------
  // "MMT-_____-___": `
  // MMT Case Summary ‚Äî ______
  // ‚úÖ Impaired:
  // - ...
  // ‚úÖ Unimpaired:
  // - ...
  // `.trim(),
};

// ---------------------------------------------------
function initMMTCaseMode() {
  const token = new URLSearchParams(window.location.search).get("caseToken");
  const cfg = token && MMT_CASE_TOKENS[token];

  // ---------- RESET (prevents bleed between cases / refreshes) ----------
  window.MMT_CASE_MODE = { active:false, token:null, impairments:{} };

  // OPTIONAL: reset tracker completely each load (safe)
  // window.IMPAIRMENT_TRACKER = {};

  if (!cfg) return;

  // ---------- ACTIVATE CASE MODE ----------
  window.MMT_CASE_MODE.active = true;
  window.MMT_CASE_MODE.token = token;
  window.MMT_CASE_MODE.impairments = cfg.impairments || {};

  // ---------- CASE BANNER (replace if already exists) ----------
  const existing = document.getElementById("mmtCaseBanner");
  if (existing) existing.remove();

  const banner = document.createElement("div");
  banner.id = "mmtCaseBanner";
  banner.textContent = `MMT Case Mode Active: ${cfg.label} (Token: ${token})`;
  banner.style.cssText =
    "position:fixed;top:0;left:0;right:0;z-index:9999;padding:6px;font-size:14px;font-weight:600;background:#dc2626;color:#fff;text-align:center;";
  document.body.appendChild(banner);

  // ---------- FILTER MENU OPTIONS ----------
  // Supports:
  // - cfg.allowedRegions (recommended)
  // - cfg.allRegions (optional; not required)
  const allowed = new Set(cfg.allowedRegions || []);
  const actionSel = document.getElementById("actionSel");

  if (actionSel && allowed.size) {
    // If you ever need to restore the full dropdown later (switching cases without reload),
    // you can save the original HTML once:
    if (!actionSel.dataset.originalHtml) {
      actionSel.dataset.originalHtml = actionSel.innerHTML;
    } else {
      // restore baseline before filtering again (prevents cumulative removals)
      actionSel.innerHTML = actionSel.dataset.originalHtml;
    }

    Array.from(actionSel.querySelectorAll("optgroup")).forEach((optgroup) => {
      const label = (optgroup.label || "").trim();
      if (!allowed.has(label)) optgroup.remove();
    });

    // If the current selection got removed, reset safely
    if (!actionSel.querySelector('option[value="' + actionSel.value + '"]')) {
      actionSel.value = "";
    }
  }

       // REQUIRED TESTS (fallback to impairments if requiredTests not defined)
      let req = window.MMT_CASE_MODE.requiredTests || [];

      // If a case didn‚Äôt define requiredTests (your Cervical case), auto-build from impairments
      if (!Array.isArray(req) || req.length === 0) {
        const imps = window.MMT_CASE_MODE.impairments || {};
        req = Object.keys(imps).filter(k => k !== "default_unrestricted");
        window.MMT_CASE_MODE.requiredTests = req; // lock it in so it‚Äôs consistent
      }

      const allDone = req.length > 0 && req.every(k => window.IMPAIRMENT_TRACKER[k] === true);

      // ‚úÖ POP THE SUMMARY NOTE WHEN ALL REQUIRED TESTS ARE DONE
      if (allDone && !window.MMT_CASE_MODE._resultsShown) {
        window.MMT_CASE_MODE._resultsShown = true;

        const md = window.MMT_CASE_MODE.resultsText || "Case complete.";
        $("noteTitle").textContent = "MMT Case Summary";
        $("noteBody").innerHTML =
          (typeof mdToHtml === "function") ? mdToHtml(md) : md.replace(/\n/g, "<br>");

        $("notePanel").classList.remove("hide");
        $("notePanel").style.display = "flex";
      }


  // ---------- RESULTS TEXT (PER-CASE, USING YOUR MMT_FULL_RESULTS MAP) ----------
  window.MMT_CASE_MODE.resultsText =
    (typeof MMT_FULL_RESULTS === "object" && MMT_FULL_RESULTS[token]) ? MMT_FULL_RESULTS[token] : (cfg.resultsText || "");
}

initMMTCaseMode();
/* ==== Hard-wired numeric pose (edit these) ==== */
const POSE = {
  x: -0.10,   // left(-) / right(+)
  y: 0.00,   // down(-) / up(+)
  z: 0.70,  // back(-) / front(+)
  ryDeg: 30,  // rotation 0‚Äì360
  s: 1.15,   // scale
  seated: false // true = sit legs
};

/* ==== Error surfacing ==== */
window.addEventListener('error', (e) => {
  const m = document.getElementById("msg");
  if (m) m.textContent = `‚ö†Ô∏è ${e.message}`;
});

/* ==== UI refs ==== */
const $ = (id)=>document.getElementById(id);
const canvas = $("c");
const logEl = $("log");
const log = (t) => { if(logEl){ logEl.textContent += t + "\\n"; logEl.scrollTop = logEl.scrollHeight; } };

const actionSel = $("actionSel");
const vectorOverlayBtn = $("vectorOverlayBtn");
const showMMT = $("showMMT");
const testButton = $("testButton");
const resistanceFill = $("resistanceFill");
const resistanceText = $("resistanceText");
const instructionText = $("instructionText");
const gradeMain = $("grade-main");
const gradeExceptions = $("GradingExceptions");  

/* ==== NEW: Lock Room Toggle Logic ==== */
const lockRoomBtn = $("lockRoomBtn");
let isRoomLocked = false;

/* ==== MMT Resistance Timing & Vector State Variables ==== */
let resistanceTimer = null;
let pressStartTime = 0;
let currentGrade = 0;
let isMMTMoving = false; // Tracks if the patient model is performing voluntary movement

let areVectorsVisible = false;
let effortVectorMesh = null; // Blue Effort Tunnel
let resistanceVectorMesh = null; // Green Resistance Tunnel

/* ==== VECTOR GUIDES: Origin (Pos) and Direction (Dir) for Effort (E) and Resistance (R) ==== */
const VECTOR_GUIDES = {

Capital_Extension: { E_startPos: { x: 0.040, y: 1.550, z: 0.780 }, E_direction: { x: 0.000, y: 0.000, z: -0.700 },  R_startPos: { x: -0.030, y: 1.610, z: -0.660 }, R_direction: { x: 0.023, y: -0.031, z: 0.706 } },
Cervical_Extension: { E_startPos: { x: 0.040, y: 1.550, z: 0.780 }, E_direction: { x: 0.000, y: 0.000, z: -0.700 },  R_startPos: { x: -0.030, y: 1.610, z: -0.660 }, R_direction: { x: 0.023, y: -0.031, z: 0.706 } },
Capital_Flexion: { E_startPos: { x: 0.000, y: 2.270, z: 0.060 }, E_direction: { x: -0.019, y: -0.699, z: -0.012 }, R_startPos: { x: 0.010, y: 0.810, z: 0.180 }, R_direction: { x: 0.023, y: 0.706, z: 0.010 } },
Cervical_Flexion: { E_startPos: { x: 0.000, y: 1.590, z: 0.020 }, E_direction: { x: 0.000, y: 0.003, z: 0.660 }, R_startPos: { x: 0.010, y: 1.410, z: 0.740 }, R_direction: { x: 0.000, y: 0.023, z: -0.707 } },
Single_SCM: { E_startPos: { x: 0.680, y: 1.550, z: -0.180 }, E_direction: { x: -0.606, y: -0.015, z: 0.349 }, R_startPos: { x: -0.430, y: 1.490, z: 0.580 }, R_direction: { x: 0.496, y: 0.090, z: -0.497 } },
Cervical_Rotation: { E_startPos: { x: 0.680, y: 1.550, z: 0.060 }, E_direction: { x: -0.700, y: -0.001, z: -0.014 }, R_startPos: { x: -0.670, y: 1.570, z: 0.060 }, R_direction: { x: 0.705, y: -0.050, z: 0.015 }},
  
Serratus_Anterior: { E_startPos: { x: -0.200, y: 0.830, z: -0.260 }, E_direction: { x: 0.000, y: 0.536, z: 0.450 }, R_startPos: { x: -0.150, y: 1.850, z: 0.620 }, R_direction: { x: 0.010, y: -0.528, z: -0.470 } },
Upper_Trapezius: {  E_startPos: { x: 0.080, y: 1.070, z: -0.140 }, E_direction: { x: 0.011, y: 0.700, z: -0.023 },  R_startPos: { x: -0.110, y: 2.050, z: -0.020 },  R_direction: { x: 0.008, y: -0.707, z: -0.022 } },
Middle_Trapezius: { E_startPos: { x: -0.360, y: 1.390, z: 0.740 }, E_direction: { x: 0.000, y: 0.000, z: -0.700 }, R_startPos: { x: -0.390, y: 1.410, z: -0.660 }, R_direction: { x: 0.004, y: -0.023, z: 0.707 } },
Scap_Depression_Adduction: { E_startPos: { x: -0.400, y: 1.870, z: 0.500 }, E_direction: { x: 0.000, y: 0.000, z: -0.700 }, R_startPos: { x: -0.430, y: 1.730, z: -0.620 },  R_direction: { x: 0.000, y: 0.006, z: 0.269 } },
Rhomboids: { E_startPos: { x: -0.880, y: 1.230, z: 0.020 }, E_direction: { x: 0.702, y: 0.003, z: -0.008 }, R_startPos: { x: 0.410, y: 1.170, z: -0.100 }, R_direction: { x: -0.706, y: 0.037, z: 0.008 } },
Latissimus_Dorsi: { E_startPos: { x: -0.640, y: 0.550, z: 0.180 }, E_direction: { x: 0.487, y: 0.372, z: -0.338 },  R_startPos: { x: 0.250, y: 1.210, z: -0.220 }, R_direction: { x: -0.574, y: -0.333, z: 0.247 } },
  
Anterior_Deltoid: {E_startPos: { x: -0.200, y: 0.670, z: 0.180 }, E_direction: { x: 0.000, y: 0.700, z: -0.000 },R_startPos: { x: -0.150, y: 2.010, z: 0.220 }, R_direction: { x: 0.000, y: -0.707, z: -0.023 }  },
Posterior_Deltoid: { E_startPos: { x: -0.200, y: 1.270, z: 0.060 }, E_direction: { x: 0.000, y: 0.000, z: -0.700 }, R_startPos: { x: -0.230, y: 1.170, z: -0.660 }, R_direction: { x: 0.023, y: 0.020, z: 0.707 } },
Middle_Deltoid: {  E_startPos: { x: -0.040, y: 0.830, z: 0.060 },  E_direction: { x: -0.590, y: 0.376, z: -0.011 }, R_startPos: { x: -0.350, y: 2.010, z: -0.140 },   R_direction: { x: 0.002, y: -0.706, z: 0.039 }  },
Shoulder_Horiz_Abd: { E_startPos: { x: -0.360, y: 1.350, z: 0.700 },  E_direction: { x: 0.000, y: 0.000, z: -0.700 }, R_startPos: { x: -0.350, y: 1.410, z: -0.700 },  R_direction: { x: 0.013, y: -0.046, z: 0.706 } },
Shoulder_Horiz_Add: { E_startPos: { x: -0.920, y: 1.390, z: 0.060 }, E_direction: { x: 0.694, y: -0.060, z: 0.061 }, R_startPos: { x: 0.410, y: 1.330, z: 0.180 },  R_direction: { x: -0.744, y: 0.035, z: -0.022 }  },
Infraspinatus: { E_startPos: { x: 0.520, y: 1.110, z: 0.260 }, E_direction: { x: -0.699, y: -0.018, z: -0.042 },  R_startPos: { x: -0.830, y: 1.130, z: 0.140 },  R_direction: { x: 1.316, y: -0.032, z: 0.151 }   },
Subscapularis: { E_startPos: { x: -1.000, y: 1.110, z: 0.100 }, E_direction: { x: 1.377, y: -0.029, z: 0.301 },  R_startPos: { x: 0.250, y: 1.010, z: 0.220 }, R_direction: { x: -0.689, y: 0.125, z: 0.100 } },
    
Trunk_Ext_Lumbar: { E_startPos:{x:0.040,y:1.550,z:0.780}, E_direction:{x:0.000,y:0.000,z:-0.700}, R_startPos:{x:0.810,y:1.530,z:-0.260}, R_direction:{x:0.000,y:-0.707,z:-0.023} },
Trunk_Ext_Thoracic: { E_startPos:{x:0.040,y:1.550,z:0.780}, E_direction:{x:0.000,y:0.000,z:-0.700}, R_startPos:{x:0.810,y:1.530,z:-0.260}, R_direction:{x:0.000,y:-0.707,z:-0.023} },
Trunk_Flexion: { E_startPos:{x:0.040,y:1.550,z:0.780}, E_direction:{x:0.000,y:0.000,z:-0.700}, R_startPos:{x:0.810,y:1.530,z:-0.260}, R_direction:{x:0.000,y:-0.707,z:-0.023} },
Trunk_Rotation: { E_startPos:{x:0.040,y:1.550,z:0.780}, E_direction:{x:0.000,y:0.000,z:-0.700}, R_startPos:{x:0.810,y:1.530,z:-0.260}, R_direction:{x:0.000,y:-0.707,z:-0.023} },
Pelvic_Elevation: { E_startPos:{x:0.040,y:1.550,z:0.780}, E_direction:{x:0.000,y:0.000,z:-0.700}, R_startPos:{x:0.810,y:1.530,z:-0.260}, R_direction:{x:0.000,y:-0.707,z:-0.023} },
  
Biceps_Brachii: { E_startPos: { x: 0.280, y: 0.870, z: 1.060 }, E_direction: { x: 0.000, y: 0.402, z: -0.573 }, R_startPos: { x: 0.250, y: 1.770, z: 0.020 },  R_direction: { x: 0.000, y: -0.472, z: 0.527 }},
Brachialis: { E_startPos: { x: 0.280, y: 0.870, z: 1.060 }, E_direction: { x: 0.000, y: 0.402, z: -0.573 }, R_startPos: { x: 0.250, y: 1.770, z: 0.020 },  R_direction: { x: 0.000, y: -0.472, z: 0.527 }},
Brachioradialis: { E_startPos: { x: 0.280, y: 0.870, z: 1.060 }, E_direction: { x: 0.000, y: 0.402, z: -0.573 }, R_startPos: { x: 0.250, y: 1.770, z: 0.020 },  R_direction: { x: 0.000, y: -0.472, z: 0.527 }},
Triceps_Brachii: { E_startPos: { x: -0.480, y: 1.630, z: 0.580 },E_direction: { x: -0.033, y: -0.447, z: -0.538 },R_startPos: { x: -0.470, y: 0.610, z: -0.500 }, R_direction: { x: 0.000, y: 0.484, z: 0.516 } },
  
ECRL: {  E_startPos: { x: -0.240, y: 1.030, z: 0.660 },  E_direction: { x: 0.061, y: 0.448, z: -0.534 }, R_startPos: { x: -0.390, y: 1.770, z: -0.140 },  R_direction: { x: 0.000, y: -0.424, z: 0.566 } },
ECRB: {  E_startPos: { x: -0.760, y: 1.590, z: -0.020 }, E_direction: { x: 0.574, y: -0.319, z: 0.243 },  R_startPos: { x: 0.130, y: 1.090, z: 0.500 },  R_direction: { x: -0.561, y: 0.309, z: -0.300 }  },
ECU: { E_startPos: { x: 0.080, y: 1.070, z: 0.420 }, E_direction: { x: -0.518, y: 0.435, z: -0.181 }, R_startPos: { x: -0.750, y: 1.650, z: -0.140 }, R_direction: { x: 0.584, y: -0.479, z: 0.538 }  },
FCR: { E_startPos: { x: -0.160, y: 1.310, z: 0.620 }, E_direction: { x: -0.324, y: 0.172, z: -0.596 },  R_startPos: { x: -0.950, y: 1.210, z: 0.140 },  R_direction: { x: 0.859, y: 0.446, z: -0.023 } },
FCU: {  E_startPos: { x: -0.960, y: 1.550, z: -0.100 },  E_direction: { x: 0.593, y: -0.219, z: 0.321 },  R_startPos: { x: 0.050, y: 1.170, z: 0.620 }, R_direction: { x: -0.493, y: 0.391, z: -0.470 }  },

Iliopsoas: { E_startPos: { x: -0.000, y: 0.430, z: 0.380 }, E_direction: { x: -0.033, y: 0.699, z: 0.003 }, R_startPos: { x: -0.110, y: 1.690, z: 0.260 },  R_direction: { x: -0.040, y: -0.702, z: 0.076 }  },  
Glute_Max: { E_startPos: { x: 0.400, y: -0.170, z: 0.460 }, E_direction: { x: 0.006, y: 0.801, z: -2.283 },  R_startPos: { x: 0.050, y: 0.610, z: -0.660 },  R_direction: { x: 0.134, y: -0.484, z: 0.498 }},
Glute_Med: { E_startPos: { x: 0.160, y: -0.090, z: -0.260 },  E_direction: { x: -0.252, y: 0.566, z: 0.350 }, R_startPos: { x: -0.510, y: 0.690, z: 0.300 }, R_direction: { x: 0.331, y: -0.568, z: -0.197 }  },
TFL: { E_startPos: { x: 0.520, y: 0.350, z: 0.620 }, E_direction: { x: -0.629, y: -0.042, z: -0.407 }, R_startPos: { x: -0.830, y: 0.330, z: 0.020 },  R_direction: { x: 1.100, y: -0.049, z: -0.181 } },
Hip_Adduction: { E_startPos: { x: 0.440, y: 0.150, z: -0.100 }, E_direction: { x: -0.639, y: 0.034, z: 0.278 }, R_startPos: { x: -0.630, y: 0.530, z: 0.340 }, R_direction: { x: 0.261, y: 0.013, z: -0.104 } },
Sartorius: {  E_startPos: { x: -0.560, y: 1.030, z: 0.460 }, E_direction: { x: 0.416, y: -0.495, z: -0.148 },  R_startPos: { x: 0.450, y: 0.530, z: 0.580 },  R_direction: { x: -0.346, y: 0.256, z: 0.041 } },
Hip_ER: {  E_startPos: { x: -0.560, y: 1.030, z: 0.460 }, E_direction: { x: 0.416, y: -0.495, z: -0.148 },  R_startPos: { x: 0.450, y: 0.530, z: 0.580 },  R_direction: { x: -0.346, y: 0.256, z: 0.041 } },
Hip_IR: { E_startPos: { x: 0.280, y: 0.270, z: 0.660 }, E_direction: { x: -0.729, y: 0.403, z: -0.293 },  R_startPos: { x: -0.910, y: 0.850, z: 0.420 },  R_direction: { x: 2.541, y: -1.385, z: 0.116 } },   

Hamstrings: { E_startPos: { x: 0.400, y: -0.170, z: 0.460 }, E_direction: { x: 0.006, y: 0.801, z: -2.283 },  R_startPos: { x: 0.050, y: 0.610, z: -0.660 },  R_direction: { x: 0.134, y: -0.484, z: 0.498 }},
Quadriceps: { E_startPos: { x: -0.120, y: 0.150, z: 0.100 }, E_direction: { x: 0.006, y: 1.731, z: 1.691 },  R_startPos: { x: -0.230, y: 1.170, z: 1.220 },  R_direction: { x: 0.134, y: -0.454, z: -0.526 }  },


    // Tibialis_Anterior: (Aligned Vectors)
    Tibialis_Anterior: { E_startPos: { x: -0.560, y: -0.090, z: -0.300 }, E_direction: { x: 0.980, y: 0.191, z: 2.324 },R_startPos: { x: 0.050, y: 0.610, z: 0.340 },  R_direction: { x: -1.066, y: -2.370, z: -1.151 } },
    Foot_Eversion_PF: { E_startPos: { x: 0.240, y: 0.670, z: 0.100 }, E_direction: { x: -1.263, y: -1.038, z: 1.064 },  R_startPos: { x: -0.750, y: 0.170, z: 0.460 }, R_direction: { x: 1.054, y: 0.567, z: -0.221 } },   
};   
  
 
const practicePlacementBtn = $("practicePlacementBtn");  

function toggleRoomLock() {
    isRoomLocked = !isRoomLocked;

    if (isRoomLocked) {
        // Lock the room: disable OrbitControls and update button visual/text
        controls.enabled = false;
        lockRoomBtn.classList.add('lockOn');
        lockRoomBtn.innerHTML = '‚úÖ Room Locked'; // or use üîì/üîí emoji logic

    } else {
        // Unlock the room: enable OrbitControls and update button visual/text
        controls.enabled = true;
        lockRoomBtn.classList.remove('lockOn');
        lockRoomBtn.innerHTML = 'üîí Lock Room';
    }
}

// Wire the new button
if (lockRoomBtn) lockRoomBtn.addEventListener('click', toggleRoomLock);

/* ==== Vector Overlay and 3D Tunnel Logic (MMT Guidance) ==== */
function createEnergyTunnel(color) {
  const TUNNEL_LENGTH = 0.35;
  const TUNNEL_RADIUS = 0.02;

  const geometry = new THREE.CylinderGeometry(TUNNEL_RADIUS, TUNNEL_RADIUS, TUNNEL_LENGTH, 16);
  const material = new THREE.MeshBasicMaterial({
    color,
    transparent: true,
    opacity: 0.6,
    side: THREE.DoubleSide
  });

  const mesh = new THREE.Mesh(geometry, material);

  const coneGeom = new THREE.ConeGeometry(TUNNEL_RADIUS * 1.8, 0.1, 16);
  const coneMesh = new THREE.Mesh(coneGeom, material);
  coneMesh.position.y = TUNNEL_LENGTH / 2;

  const group = new THREE.Group();
  group.add(mesh);
  group.add(coneMesh);

  group.matrixAutoUpdate = false;
  group.visible = false;
  scene.add(group);
  return group;
}

const _up = new THREE.Vector3(0, 1, 0);
function positionVector(mesh, startPos, direction) {
  const dir = new THREE.Vector3().set(direction.x, direction.y, direction.z).normalize();
  const midPoint = new THREE.Vector3()
    .set(startPos.x, startPos.y, startPos.z)
    .addScaledVector(dir, 0.7 / 2);

  mesh.position.copy(midPoint);

  const rotationQuaternion = new THREE.Quaternion().setFromUnitVectors(_up, dir);
  mesh.rotation.setFromQuaternion(rotationQuaternion);
  mesh.updateMatrix();
}

function showVectorsForTest(testKey) {
  if (!testKey) {
    $("msg").textContent = "Select a test, then tap Vector Overlay.";
    return;
  }

  const guide = VECTOR_GUIDES[testKey];
  if (!guide) {
    $("msg").textContent = `No Vector Guide data found for ${testKey}.`;
    // If we can't draw for this test, hide anything old
    hideVectors();
    return;
  }

  if (!effortVectorMesh) effortVectorMesh = createEnergyTunnel(0x0066FF); // Blue
  if (!resistanceVectorMesh) resistanceVectorMesh = createEnergyTunnel(0x00AA00); // Green

  // Effort: patient force
  positionVector(effortVectorMesh, guide.E_startPos, guide.E_direction);
  if (model && effortVectorMesh.parent !== model) model.add(effortVectorMesh);
  effortVectorMesh.visible = true;

  // Resistance: therapist force
  // Resistance: therapist force
  positionVector(resistanceVectorMesh, guide.R_startPos, guide.R_direction);
  if (model && resistanceVectorMesh.parent !== model) model.add(resistanceVectorMesh);
  resistanceVectorMesh.scale.set(1, 1, 1); // keep green vector from shrinking
  resistanceVectorMesh.visible = true;

  areVectorsVisible = true;
  vectorOverlayBtn.classList.add("lockOn");
  $("msg").textContent = "Vectors: Blue = Patient Effort, Green = Therapist Resistance.";
}

function hideVectors() {
  if (effortVectorMesh) effortVectorMesh.visible = false;
  if (resistanceVectorMesh) resistanceVectorMesh.visible = false;
  areVectorsVisible = false;
  if (vectorOverlayBtn) vectorOverlayBtn.classList.remove("lockOn");
}

function toggleVectorOverlay() {
  // Only ever change state when the button is clicked
  if (areVectorsVisible) {
    hideVectors();
    $("msg").textContent = "Vector Overlay Off.";
  } else {
    showVectorsForTest(actionSel.value);
  }
}

// When the user changes the MMT test:
if (actionSel) {
  actionSel.addEventListener("change", () => {
    const testKey = actionSel.value;

    // If overlay is OFF, just make sure nothing stale is on-screen
    if (!areVectorsVisible) {
      hideVectors();
      return;
    }

    // Overlay is ON ‚Üí either update to the new test or clear it
    if (!testKey || !VECTOR_GUIDES[testKey]) {
      hideVectors();
      $("msg").textContent = "Vector Overlay Off (no guide for this test).";
    } else {
      showVectorsForTest(testKey); // switch to the new test‚Äôs vectors
    }
  });
}

// Wire the toggle to the button
if (vectorOverlayBtn) {
  vectorOverlayBtn.addEventListener("click", toggleVectorOverlay);
}


/* ==== MMT Resistance Timing & Execution Logic (Core Test Loop) ==== */
function getGradeStatus(elapsedSeconds) {
    if (elapsedSeconds >= 7.0) { 
        return { grade: 5, color: '#10b981', text: 'Grade 5 (Max Resistance)' };
    } else if (elapsedSeconds >= 4.0) { 
        return { grade: 4, color: '#f97316', text: 'Grade 4 (Moderate Resistance)' };
    } else if (elapsedSeconds >= 2.0) { 
        return { grade: 3, color: '#facc15', text: 'Grade 3 (Slight Resistance Hold)' };
    }
    return { grade: 0, color: 'transparent', text: 'Hold to Apply Resistance (Grade 3, 4, 5)' };
}
function updateResistanceFill() {
  if (!resistanceTimer) return;

  const elapsed = (Date.now() - pressStartTime) / 1000;
  const maxTime = 7.0;

  // --- CASE MODE CLAMPING (caps hold time per test) ---
  let maxAllowedTime = maxTime;

  if (window.MMT_CASE_MODE && window.MMT_CASE_MODE.active) {
    const testKey = actionSel.value;
    const imp =
      (window.MMT_CASE_MODE.impairments && window.MMT_CASE_MODE.impairments[testKey]) ||
      (window.MMT_CASE_MODE.impairments && window.MMT_CASE_MODE.impairments.default_unrestricted);

    if (imp && typeof imp.max_hold_time === "number") {
      maxAllowedTime = Math.max(0.1, Math.min(maxTime, imp.max_hold_time));
    }
  }

  // Use the capped time for UI + grade calculation
  const effective = Math.min(elapsed, maxAllowedTime);
  const status = getGradeStatus(effective);

  resistanceFill.style.transition = "width 0.1s linear, background-color 0.4s";
  resistanceFill.style.backgroundColor = status.color;

  const denom = Math.max(0.1, maxAllowedTime);
// Fill maps to the 0‚ÜíGrade3‚ÜíGrade4‚ÜíGrade5 timing scale (2s, 4s, 7s)
// so a Grade 4 cap shows ~80% (not 100%).
let fillPct = 0;
if (effective <= 2) fillPct = (effective / 2) * 60;                 // 0‚Äì2s  ‚Üí 0‚Äì60%
else if (effective <= 4) fillPct = 60 + ((effective - 2) / 2) * 20; // 2‚Äì4s  ‚Üí 60‚Äì80%
else fillPct = 80 + ((effective - 4) / 3) * 20;                     // 4‚Äì7s  ‚Üí 80‚Äì100%

resistanceFill.style.width = `${Math.min(100, Math.max(0, fillPct))}%`;

  if (status.grade > 0) {
    resistanceText.textContent = status.text;
    currentGrade = status.grade;
  }

  applyHoldMovement();

  // Stop exactly at the cap (this is the clamp)
  if (elapsed >= maxAllowedTime) {
    clearInterval(resistanceTimer);
    resistanceTimer = null;

    applyBodyPositionFromSelection();

    // Track completion (requiredTests)
    if (window.MMT_CASE_MODE && window.MMT_CASE_MODE.active) {
      const testKey = actionSel.value;
      window.IMPAIRMENT_TRACKER = window.IMPAIRMENT_TRACKER || {};
      window.IMPAIRMENT_TRACKER[testKey] = true;

      const req = window.MMT_CASE_MODE.requiredTests || [];
      const allDone = req.length > 0 && req.every(k => window.IMPAIRMENT_TRACKER[k] === true);

      if (allDone && !window.MMT_CASE_MODE._resultsShown) {
        window.MMT_CASE_MODE._resultsShown = true;
        alert(window.MMT_CASE_MODE.resultsText || "Case complete.");
      }
    }

    // ‚úÖ Message that will NOT get overwritten
    if (maxAllowedTime < maxTime) {
      $("msg").textContent = `Case Mode: Grade ${currentGrade}/5 (capped at ${maxAllowedTime.toFixed(1)}s).`;
    } else {
      $("msg").textContent = `Test finished. Recorded score: Grade ${currentGrade}!`;
    }

    testButton.disabled = false;
    vectorOverlayBtn.disabled = false;
  }
}


// index (80).html - Replace the entire existing function
function executeVoluntaryMovement() {
    // 1. Define tests that should SKIP the voluntary movement phase
    const NO_VOLUNTARY_MOVEMENT_TESTS = [
      'Capital_Extension', 
      'Cervical_Extension',
      'Capital_Flexion',
      'Cervical_Flexion',
      'Single_SCM', // <-- Added to list
      'Cervical_Rotation'
    ];

    const testKey = actionSel.value;

    if (NO_VOLUNTARY_MOVEMENT_TESTS.includes(testKey)) {
        // Skip the 0.5s movement delay and jump straight to the resistance phase.
        isMMTMoving = false;
        testButton.disabled = false;
        $("msg").textContent = "Movement skipped. Hold the resistance button to apply pressure (Tremor Active).";
        return; // EXIT THE FUNCTION EARLY
    }

    // Existing Voluntary Movement Logic (for limb movements, etc.)
    isMMTMoving = true;
    testButton.disabled = true; 
    $("msg").textContent = "Patient is executing voluntary movement (0.5s)...";
    
    setTimeout(() => {
        isMMTMoving = false;
        testButton.disabled = false; 
        $("msg").textContent = "Movement complete. Hold the resistance button to apply pressure.";
    }, 500); 
}

function startResistanceTest(event) {
    if (testButton.disabled || resistanceTimer) return;
        // Only allow resistance when therapist hands are ON
    if (!handsModel || !handsModel.visible) {
        $("msg").textContent = "Turn Therapist Hands ON before applying resistance.";
        return;
    }

    executeVoluntaryMovement();
    currentHoldAngle = 0;
  
    currentGrade = 0;
    pressStartTime = Date.now();
    resistanceFill.style.width = '0%';
    resistanceFill.style.transition = 'none'; 

    resistanceTimer = setInterval(updateResistanceFill, 100);
  // ‚≠ê CRITICAL FIX: Force model to update to END POSE now that resistance is active (resistanceTimer is set).
    applyBodyPositionFromSelection();
    event.preventDefault(); 
}

function stopResistanceTest() {
    if (!resistanceTimer) return;
    
    clearInterval(resistanceTimer);
    resistanceTimer = null;
    
    // ‚≠ê NEW: Stop Hand Trembling by forcing hand models to reset their position.
    // We call forceApplyHandOverrideOnce() to instantly snap the hands 
    // back to the stationary, pre-tuned position.
    forceApplyHandOverrideOnce(); 

    // Reset patient pose and bone rotation
    applyBodyPositionFromSelection(); 
    
    resistanceFill.style.transition = 'width 0.3s ease-in, background-color 0.3s';
    resistanceFill.style.width = '0%'; 
    
    const finalGradeText = currentGrade > 0 ? `Grade ${currentGrade} achieved.` : "Hold was too short - Grade 3.";
    $("msg").textContent = `Test finished. Recorded score: ${finalGradeText}`;
    resistanceText.textContent = 'Hold to Apply Resistance (Grade 3, 4, 5)';
}

// Wire the Resistance Button for Press-and-Hold (robust hold; ignores stray ups)
if (testButton) {
  let activePointerId = null;

  const onDown = (e) => {
    e.preventDefault(); e.stopPropagation();
    activePointerId = e.pointerId;

    // keep receiving events even if cursor drifts
    try { testButton.setPointerCapture(activePointerId); } catch (_) {}

    startResistanceTest(e);
  };

  const onUp = (e) => {
    // ignore "up" events that aren‚Äôt from the active press
    if (activePointerId !== null && e.pointerId !== activePointerId) return;

    e.preventDefault(); e.stopPropagation();
    activePointerId = null;

    stopResistanceTest(e);
  };

  testButton.addEventListener("pointerdown", onDown, { capture: true, passive: false });
  testButton.addEventListener("pointerup", onUp, { capture: true, passive: false });
  testButton.addEventListener("pointercancel", onUp, { capture: true, passive: false });
  testButton.addEventListener("lostpointercapture", onUp, { capture: true });

  // IMPORTANT: remove pointerleave stop (it causes ‚Äúends while holding‚Äù)
  // testButton.addEventListener('pointerleave', stopResistanceTest);

  // also block click bubbling (prevents ‚Äúcopy test‚Äù)
  testButton.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); }, true);
}

/* ==================================== */  

// Enable only the relevant grading menu for the selected test:
// - EXCEPTION_TESTS (trunk + gastroc): use Grading Exceptions (5‚Äì1) only
// - everything else: use normal Grade menu (3‚Äì0) only
function updateGradeDropdownsForSelection(){
  const testKey = actionSel?.value;

 /* ==== MMT Grading Rules Logic (Corrected for Trunk/Gastroc Exclusion) ==== */
function shouldResistanceBeDisabled() {
    const testKey = actionSel.value;

    // RULE 1: If no test is selected, resistance is always disabled.
    if (!testKey) return true;

    const isExceptionTest = EXCEPTION_TESTS.has(testKey);

    // =================================================================
    // A) EXCEPTION TESTS (TRUNK & GASTROC) LOGIC
    // =================================================================
    if (isExceptionTest) {
        const exceptionGrade = gradeExceptions.value;

        // Trunk tests (Trunk_Ext_Lumbar, Trunk_Ext_Thoracic, Trunk_Flexion, Trunk_Rotation)
        // These tests use the lift/rotation scale, NOT manual resistance for Grades 3-5.
        if (testKey.startsWith('Trunk')) {
            return true; // ALWAYS disable resistance for all Trunk MMTs.
        }

        // Gastrocnemius (Plantar Flexion) Logic:
        if (testKey === 'Gastrocnemius') {
            // Gastroc Grade 2 (partial ROM in standing) usually doesn't use resistance, 
            // but for simulation, you requested Grade 2 uses resistance:
            // Let's stick to textbook: Grades 5, 4, 3, 1/0 are graded differently.
            // If the user selects Grade 2, 1, or 0, we disable resistance.
            if (exceptionGrade === '2' || exceptionGrade === '1' || exceptionGrade === '0') {
                 return true; // Disable resistance for low grades
            }
            // Grades 5, 4, 3 remain ENABLED for the hold test.
            return false;
        }

        // Default for any other unknown exception test at low grade: disable
        if (exceptionGrade === '2' || exceptionGrade === '1' || exceptionGrade === '0') {
            return true;
        }
    } 
    
    // =================================================================
    // B) MAIN GRADE MENU (All other limb tests)
    // =================================================================
    else {
        const mainGradeBucket = gradeMain.value;

        // RULE 3: If the 'Grades 0‚Äì2 (Gravity Eliminated)' bucket is selected, disable resistance.
        if (mainGradeBucket === '2') {
            return true;
        }
    }

    // Default: Grades 3, 4, 5 (in the main menu) use manual resistance/hold time.
    return false; 
} 
  // No test selected ‚Üí default: normal menu active, exceptions off
  if (!testKey){
    if (gradeMain) gradeMain.disabled = false;
    if (gradeExceptions) gradeExceptions.disabled = true;
    return;
  }

  const isException = EXCEPTION_TESTS.has(testKey);

  if (isException){
    // Trunk + Gastroc: ONLY Grading Exceptions menu is active
    if (gradeMain) gradeMain.disabled = true;
    if (gradeExceptions){
      gradeExceptions.disabled = false;
      if (!gradeExceptions.value) gradeExceptions.value = "5";
    }
  } else {
    // All other tests: ONLY normal 3‚Äì0 Grade menu is active
    if (gradeMain){
      gradeMain.disabled = false;
      if (!gradeMain.value) gradeMain.value = "3";
    }
    if (gradeExceptions) gradeExceptions.disabled = true;
  }
}
  

/* ==== THREE setup ==== */
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf1f5f9);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.01, 200);
camera.position.set(1.8,1.6,3.2);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = .08;
controls.minDistance=.6; controls.maxDistance=20;
controls.target.set(0,1.05,0);¬†
// --- UI zoom buttons control camera distance, not page zoom ---
const ZOOM_IN_FACTOR  = 0.85;  // smaller factor = closer
const ZOOM_OUT_FACTOR = 1.15;  // larger factor = farther

function zoomCamera(factor){
  const dir = new THREE.Vector3();
  dir.subVectors(camera.position, controls.target);      // from target to camera
  const currentDist = dir.length();
  let newDist = currentDist * factor;

  // clamp to OrbitControls limits
  newDist = Math.max(controls.minDistance, Math.min(controls.maxDistance, newDist));
  dir.setLength(newDist);
  camera.position.copy(controls.target).add(dir);
  camera.updateProjectionMatrix();
}

const zoomInBtn  = document.getElementById('zoomInBtn');
const zoomOutBtn = document.getElementById('zoomOutBtn');

if (zoomInBtn) {
  zoomInBtn.addEventListener('click', () => zoomCamera(ZOOM_IN_FACTOR));
}
if (zoomOutBtn) {
  zoomOutBtn.addEventListener('click', () => zoomCamera(ZOOM_OUT_FACTOR));
}


// --- END: 3D Manipulation Widget Setup ---
/* Lights */
scene.add(new THREE.HemisphereLight(0xffffff, 0x8ca0b3, 0.8));
const key = new THREE.DirectionalLight(0xffffff, 1.1);
key.position.set(3.5,5,3.5);
key.castShadow = true;
key.shadow.mapSize.set(2048,2048);
key.shadow.camera.near=0.1; key.shadow.camera.far=50;
key.shadow.camera.left=-10; key.shadow.camera.right=10;
key.shadow.camera.top=10; key.shadow.camera.bottom=-10;
scene.add(key);

/* ==== ROOM GEOMETRY (simple eval room) ==== */
const room = new THREE.Group();
scene.add(room);

// Floor (vinyl)
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(12, 12),
  new THREE.MeshStandardMaterial({ color: 0xe2e8f0, roughness:0.9, metalness:0 })
);
floor.rotation.x = -Math.PI/2;
floor.receiveShadow = true;
room.add(floor);

// Walls
const wallMat = new THREE.MeshStandardMaterial({ color: 0xf8fafc, roughness: 1, metalness: 0 });
const backWall = new THREE.Mesh(new THREE.PlaneGeometry(12, 3), wallMat);
backWall.position.set(0, 1.5, -6);
room.add(backWall);
const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(12, 3), wallMat);
leftWall.rotation.y = Math.PI/2;
leftWall.position.set(-6, 1.5, 0);
room.add(leftWall);

// Long blue table (extended)
const TABLE_HEIGHT = 0.65;
const TABLE_THICK = 0.08;
const TABLE_W = 0.7;
const TABLE_D = 2.2; // Long enough
const tableTop = new THREE.Mesh(
  new THREE.BoxGeometry(TABLE_W, TABLE_THICK, TABLE_D),
  new THREE.MeshStandardMaterial({ color: 0x1e3a8a, roughness:0.85, metalness:0.05 }) // deep blue
);
tableTop.position.set(0, TABLE_HEIGHT, 0.35);
tableTop.castShadow = true; tableTop.receiveShadow = true;
room.add(tableTop);

// Face cutout (visual only, centered on midline near head end)
const faceCutout = new THREE.Mesh(
  new THREE.CylinderGeometry(0.16, 0.16, 0.01, 32),
  new THREE.MeshStandardMaterial({ color: 0x111827, roughness:0.9, metalness:0 })
);
// no rotation ‚Äì lies flat on table
faceCutout.position.set(
  0,                                              // midline (left/right)
  TABLE_HEIGHT + TABLE_THICK / 2 + 0.003,        // just on top surface
  tableTop.position.z - TABLE_D / 2 + 0.30       // opposite end of table
);
faceCutout.receiveShadow = true;
room.add(faceCutout);


// Table base (simple box legs)
const base = new THREE.Mesh(
  new THREE.BoxGeometry(TABLE_W*0.6, TABLE_HEIGHT, TABLE_D*0.8),
  new THREE.MeshStandardMaterial({ color: 0x374151, roughness:0.9, metalness:0.05 })
);
base.position.set(0, TABLE_HEIGHT/2, 0.35);
base.castShadow = true; base.receiveShadow = true;
room.add(base);

// Cabinet
const cabinet = new THREE.Mesh(
  new THREE.BoxGeometry(1.0, 0.96, 0.33),
  new THREE.MeshStandardMaterial({ color: 0x9ca3af, roughness:0.8 })
);
cabinet.position.set(-1.6, 0.45, -0.6);
cabinet.castShadow = true; cabinet.receiveShadow = true;
room.add(cabinet);
  
// High-back chair ~0.25m (~10 in) in front of the cabinet
const chair = new THREE.Group();
chair.position.set(
  cabinet.position.x,        // side-to-side aligned with cabinet
  0,                         // on floor
  cabinet.position.z - 0.51  // in front of cabinet
);
room.add(chair);

const chairSeat = new THREE.Mesh(
  new THREE.BoxGeometry(0.5, 0.05, 0.5),
  new THREE.MeshStandardMaterial({ color: 0x6b7280, roughness: 0.8 })
);
// LOCAL to chair
chairSeat.position.set(0, 0.45, 0);
chairSeat.castShadow = true;
chairSeat.receiveShadow = true;
chair.add(chairSeat);

// Simple legs (LOCAL offsets around the seat center)
const chairLegMat = new THREE.MeshStandardMaterial({ color: 0x4b5563, roughness: 0.9 });
const legGeom = new THREE.CylinderGeometry(0.03, 0.03, 0.45, 12);
[
  [-0.20, -0.20],
  [ 0.20, -0.20],
  [-0.20,  0.20],
  [ 0.20,  0.20],
].forEach(([dx, dz]) => {
  const leg = new THREE.Mesh(legGeom, chairLegMat);
  leg.position.set(
    dx,
    0.45 / 2,   // half seat height ‚Üí on floor
    dz
  );
  leg.castShadow = true;
  leg.receiveShadow = true;
  chair.add(leg);
});

// High backrest (LOCAL to chair)
const chairBack = new THREE.Mesh(
  new THREE.BoxGeometry(0.5, 0.9, 0.06), // width, height, thickness
  new THREE.MeshStandardMaterial({ color: 0x4b5563, roughness: 0.9 })
);
chairBack.position.set(
  0,
  0.45 + 0.9 / 2 + 0.03,  // centered above seat
  -0.22                   // behind seat
);
chairBack.castShadow = true;
chairBack.receiveShadow = true;
chair.add(chairBack);

// Rotate whole chair around its own center
chair.rotation.y = THREE.MathUtils.degToRad(90);


// Stool
const stoolSeat = new THREE.Mesh(
  new THREE.CylinderGeometry(0.18, 0.18, 0.06, 24),
  new THREE.MeshStandardMaterial({ color: 0x6b7280, roughness:0.8 })
);
stoolSeat.position.set(0.95, 0.52, -0.2);
stoolSeat.castShadow = true; stoolSeat.receiveShadow = true;
room.add(stoolSeat);
const stoolLeg = new THREE.Mesh(
  new THREE.CylinderGeometry(0.03, 0.03, 0.5, 16),
  new THREE.MeshStandardMaterial({ color: 0x4b5563, roughness:0.8 })
);
stoolLeg.position.set(0.95, 0.25, -0.2);
stoolLeg.castShadow = true; stoolLeg.receiveShadow = true;
room.add(stoolLeg);

// Shadow catcher slightly above floor to enhance contact shadows
const shadowCatch = new THREE.Mesh(new THREE.PlaneGeometry(6,6), new THREE.ShadowMaterial({ opacity:0.4 }));
shadowCatch.rotation.x = -Math.PI/2;
shadowCatch.position.y = 0.001;
shadowCatch.receiveShadow = true;
room.add(shadowCatch);
 // ---- View preset: room yaw + camera distance (ONE BLOCK) ----
(() => {
  // Turn the whole room left/right (negative = left, positive = right)
  const ROOM_YAW_DEG = -70;
  room.rotation.y = degToRad(ROOM_YAW_DEG);

  // Zoom preset: set camera distance from the controls target
  function setCameraDistance(d){
    const dir = new THREE.Vector3()
      .subVectors(camera.position, controls.target)
      .normalize();
    camera.position.copy(controls.target).addScaledVector(dir, d);
  }
  setCameraDistance(4.8); // bigger = farther, smaller = closer
})();

/* === Anatomic preset ‚Äî simple like goniometer index === */
const ANAT = { add:-42, ps:-2, wps:-73 };
const AXIS_MAP = {
  sh_fe_l:      'x',  sh_fe_r:      'x',
  sh_aa_l:      'z',  sh_aa_r:     '-z',
  sh_irer_l:    'y',  sh_irer_r:    'y',
  el_fe_l:      'x',  el_fe_r:      'x',
  fa_ps_l:      'y',  fa_ps_r:      'y',
  wr_ps_l:      'y',  wr_ps_r:      'y',
  wr_fe_l:      'x',  wr_fe_r:      'x',
  wr_ru_l:      'z',  wr_ru_r:      'z',
  hip_fe_l:     'x',  hip_fe_r:     'x',
  hip_aa_l:     'z',  hip_aa_r:     'z',
  hip_irer_l:   'y',  hip_irer_r:   'y',
  knee_fe_l:    'x',  knee_fe_r:    'x',
  ankle_dfpf_l: 'x',  ankle_dfpf_r: 'x',
  foot_invev_l: 'z',  foot_invev_r: 'z',
  trunk_fe:     'x',
  trunk_lat:    'z',
  trunk_rot:    'y',
  cerv_fe:      'x',
  cerv_lat:     'z',
  cerv_rot:     'y',
  clavicle_L:   'z',
  clavicle_R:  '-z'
};
  

function getBone(name){
  return skeleton?.bones.find(b => b.name === name) || null;
}
// Function to reset bone to baseline and apply new rotation
function setDegAxis(bone, axis, deg){
  if(!bone) return;
  const q0 = initialBoneRot.get(bone);
  if(q0) bone.quaternion.copy(q0);        // reset to baseline
  const r = THREE.MathUtils.degToRad(deg);
  
  // Use a temporary Euler to apply rotation for consistency
  const euler = new THREE.Euler(0, 0, 0, 'XYZ');
  if(axis==='x') euler.x = r;
  else if(axis==='y') euler.y = r;
  else euler.z = r;

  // Create delta quaternion and multiply with base
  const qDelta = new THREE.Quaternion().setFromEuler(euler);
  if(q0) bone.quaternion.copy(q0).multiply(qDelta);
  else bone.quaternion.copy(qDelta); // fallback if no initial rot
}

// ONE simple function that sets both sides (like your gonio index)
// NOTE: this assumes arm bone names like "upperarm_L/R", "forearm_L/R", "hand_L/R".

// NEW: MAPPING MMT TEST KEYS to BONE, AXIS, and DIRECTION
// [ Bone Name, Axis ('x', 'y', 'z'), Direction (1 or -1) ]
const CERVICAL_MMT_MAP = {
  // Movement direction: 1 = Flexion/Left/Internal; -1 = Extension/Right/External (General)
  Capital_Extension:   ['head', 'x', -1],   // Prone: Extends head (Pitch down)
  Cervical_Extension:  ['neck', 'x', -1],   // Prone: Extends neck (Pitch down)
  Capital_Flexion:     ['head', 'x', 1],    // Supine: Flexes head (Pitch up)
  Cervical_Flexion:    ['neck', 'x', 1],    // Supine: Flexes neck (Pitch up)
  Single_SCM:          ['neck', 'ry', 0],    // Single SCM (Rotation)
  Cervical_Rotation:   ['head', 'y', -1]     // Rotation (Y is rotation)
};  
 
// If your rig uses "wrist_L/R" instead of "hand_L/R", change those two names below.
function applyAnatomicBaseline(){
  const shL = getBone('upperarm_L'), shR = getBone('upperarm_R'); // shoulder ab/ad on Z
  const faL = getBone('forearm_L'),  faR = getBone('forearm_R');  // forearm PS on Y
  const wrL = getBone('hand_L'),     wrR = getBone('hand_R');     // wrist PS on Y (use 'wrist_*' if needed)

  setDegAxis(shL, 'z', ANAT.add);
  setDegAxis(shR, 'z', -ANAT.add);

  setDegAxis(wrL, 'y', ANAT.wps);
  setDegAxis(wrR, 'y', -ANAT.wps);   
}
/**
 * Applies a small, slow, incremental movement to the bone being tested.
 * Simulates the patient straining against resistance.Checkspot
 */
function applyHoldMovement() {
  const testKey = actionSel.value;
    if (!testKey) return;

  const mapping = CERVICAL_MMT_MAP[testKey];

  const MAX_HOLD_ANGLE = 5;               // Maximum visible movement (degrees)
  const STEP_INCREMENT = 0.10;            // Speed (degrees per tick/100ms)
  const MAX_TREMOR_DISPLACEMENT = 0.003;  // 3 mm max random shift for hand tremor (meters)

  // 1) Cervical-only hold movement + head tremor
  if (mapping) {
    const [boneName, axis, direction] = mapping;
    const bone = getBone(boneName);

    if (bone) {
      // Increment the hold angle slowly
      currentHoldAngle = Math.min(MAX_HOLD_ANGLE, currentHoldAngle + STEP_INCREMENT);

      // Total rotation
      const totalRotation = currentHoldAngle * direction;

      // Apply the rotation to the tested cervical bone
      setDegAxis(bone, axis, totalRotation);

      // ‚≠ê Head tremor only for cervical tests
      const head = getBone('head');
      if (head) {
        const AMP_DEG = 0.35; // max ~0.35¬∞ each axis per tick
        const jx = (Math.random() * 2 - 1) * AMP_DEG;
        const jy = (Math.random() * 2 - 1) * AMP_DEG;
        const jz = (Math.random() * 2 - 1) * AMP_DEG;
        head.rotateX(degToRad(jx));
        head.rotateY(degToRad(jy));
        head.rotateZ(degToRad(jz));
      }
    }
  }

  // 2) Body tremor for scapula / shoulder tests (non-cervical)
  if (!mapping) {
    const UPPERCHAIN_TREMOR_TESTS = new Set([
      // Scapula
      "Serratus_Anterior",
      "Upper_Trapezius",
      "Middle_Trapezius",
      "Scap_Depression_Adduction",
      "Rhomboids",
      "Latissimus_Dorsi",
      // Shoulder
      "Anterior_Deltoid",
      "Posterior_Deltoid",
      "Middle_Deltoid",
      "Shoulder_Horiz_Abd",
      "Shoulder_Horiz_Add"
    ]);

    const ROTATOR_TREMOR_TESTS = new Set([
      "Infraspinatus",
      "Subscapularis"
    ]);

    const ELBOW_BICEPS_TESTS = new Set([
      "Biceps_Brachii",
      "Brachialis",
      "Brachioradialis"
    ]);

    const ELBOW_TRICEPS_TESTS = new Set([
      "Triceps_Brachii"
    ]);
      // Wrist tests ‚Äì all use hand_R for tremor
    const WRIST_TREMOR_TESTS = new Set([
      "ECRL",
      "ECRB",
      "ECU",
      "FCR",
      "FCU"
    ]);

    // Hip tests
    const HIP_FLEX_TESTS = new Set([
      "Iliopsoas"
    ]);
    const HIP_EXT_TESTS = new Set([
      "Glute_Max"
    ]);
    const HIP_ABD_TESTS = new Set([
      "Glute_Med",
      "TFL"
    ]);
    const HIP_ADD_TESTS = new Set([
      "Hip_Adduction"
    ]);
    const HIP_ER_TESTS = new Set([
      "Sartorius",
      "Hip_ER"
    ]);
    const HIP_IR_TESTS = new Set([
      "Hip_IR"
    ]);

    // Knee tests
    const KNEE_FLEX_TESTS = new Set([
      "Hamstrings"
    ]);
    const KNEE_EXT_TESTS = new Set([
      "Quadriceps"
    ]);
  
    const bonesToJitter = [];

    // ‚≠ê Scapular elevation: tremor at clavicles only
    if (testKey === "Upper_Trapezius") {
      const clavL = getBone("clavicle_L");
      const clavR = getBone("clavicle_R");
      if (clavL) bonesToJitter.push(clavL);
      if (clavR) bonesToJitter.push(clavR);

    // Other scapula / shoulder tests: upper arm + forearm + hand (right)
    } else if (UPPERCHAIN_TREMOR_TESTS.has(testKey)) {
      const upper = getBone("upperarm_R");
      const lower = getBone("lowerarm_R");
      const hand  = getBone("hand_R");
      if (upper) bonesToJitter.push(upper);
      if (lower) bonesToJitter.push(lower);
      if (hand)  bonesToJitter.push(hand);
   // Elbow flexors (3 biceps tests): LEFT lower arm + LEFT hand
    } else if (ELBOW_BICEPS_TESTS.has(testKey)) {
      const lowerL = getBone("lowerarm_L");
      const handL  = getBone("hand_L");
      if (lowerL) bonesToJitter.push(lowerL);
      if (handL)  bonesToJitter.push(handL);

    // Triceps: RIGHT lower arm only
    } else if (ELBOW_TRICEPS_TESTS.has(testKey)) {
      const lowerR = getBone("lowerarm_R");
      if (lowerR) bonesToJitter.push(lowerR);

      
    // Rotator tests: forearm + hand (right)
    } else if (ROTATOR_TREMOR_TESTS.has(testKey)) {
      const lower = getBone("lowerarm_R");
      const hand  = getBone("hand_R");
      if (lower) bonesToJitter.push(lower);
      if (hand)  bonesToJitter.push(hand);
    }
    // Wrist: all use hand_R for tremor
    else if (WRIST_TREMOR_TESTS.has(testKey)) {
      const handR = getBone("hand_R");
      if (handR) bonesToJitter.push(handR);

    // Hip ‚Äì Iliopsoas: thigh_R
    } else if (HIP_FLEX_TESTS.has(testKey)) {
      const thighR = getBone("thigh_R");
      if (thighR) bonesToJitter.push(thighR);

    // Hip ‚Äì Glute Max: calf_L
    } else if (HIP_EXT_TESTS.has(testKey)) {
      const calfL = getBone("calf_L");
      if (calfL) bonesToJitter.push(calfL);

    // Hip ‚Äì Glute Med & TFL: calf_R and thigh_R
    } else if (HIP_ABD_TESTS.has(testKey)) {
      const calfR  = getBone("calf_R");
      const thighR = getBone("thigh_R");
      if (calfR)  bonesToJitter.push(calfR);
      if (thighR) bonesToJitter.push(thighR);

    // Hip ‚Äì Adductors: calf_L, thigh_L, foot_L
    } else if (HIP_ADD_TESTS.has(testKey)) {
      const calfL  = getBone("calf_L");
      const thighL = getBone("thigh_L");
      const footL  = getBone("foot_L");
      if (calfL)  bonesToJitter.push(calfL);
      if (thighL) bonesToJitter.push(thighL);
      if (footL)  bonesToJitter.push(footL);

    // Hip ‚Äì Sartorius / ER: calf_R and thigh_R
    } else if (HIP_ER_TESTS.has(testKey)) {
      const calfR  = getBone("calf_R");
      const thighR = getBone("thigh_R");
      if (calfR)  bonesToJitter.push(calfR);
      if (thighR) bonesToJitter.push(thighR);

    // Hip ‚Äì IR: calf_R and thigh_R
    } else if (HIP_IR_TESTS.has(testKey)) {
      const calfR  = getBone("calf_R");
      const thighR = getBone("thigh_R");
      if (calfR)  bonesToJitter.push(calfR);
      if (thighR) bonesToJitter.push(thighR);

    // Knee ‚Äì Hamstrings: calf_L
    } else if (KNEE_FLEX_TESTS.has(testKey)) {
      const calfL = getBone("calf_L");
      if (calfL) bonesToJitter.push(calfL);

    // Knee ‚Äì Quadriceps: calf_R
    } else if (KNEE_EXT_TESTS.has(testKey)) {
      const calfR = getBone("calf_R");
      if (calfR) bonesToJitter.push(calfR);
    }

    if (bonesToJitter.length) {
      const AMP_DEG_BODY = 0.3; // small visible jitter
      bonesToJitter.forEach(bone => {
        const jx = (Math.random() * 2 - 1) * AMP_DEG_BODY;
        const jy = (Math.random() * 2 - 1) * AMP_DEG_BODY;
        const jz = (Math.random() * 2 - 1) * AMP_DEG_BODY;
        bone.rotateX(degToRad(jx));
        bone.rotateY(degToRad(jy));
        bone.rotateZ(degToRad(jz));
      });
    }
  }


  // 3) Global hand tremor while resistance is held (ANY test)
  if (leftHandModel && handsModel?.visible) {
    const d = MAX_TREMOR_DISPLACEMENT;

    const tremorX = (Math.random() * 2 * d) - d;
    const tremorY = (Math.random() * 2 * d) - d;
    const tremorZ = (Math.random() * 2 * d) - d;

    leftHandModel.position.x += tremorX;
    leftHandModel.position.y += tremorY;
    leftHandModel.position.z += tremorZ;
  }
}

/* ==== Loader ==== */
const loader = new GLTFLoader();
loader.setMeshoptDecoder(MeshoptDecoder);
const draco = new DRACOLoader(); draco.setDecoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/"); loader.setDRACOLoader(draco);
const ktx2  = new KTX2Loader();  ktx2.setTranscoderPath("https://unpkg.com/three@0.160.0/examples/jsm/libs/basis/"); ktx2.detectSupport(renderer); loader.setKTX2Loader(ktx2);

let model=null, skeleton=null;
const initialBoneRot = new Map();
let GLOBAL_PF_DEG = 0; // shared plantarflex angle for both feet
let currentHoldAngle = 0; // NEW: Tracks rotation during MMT resistance hold
  
// ADDED: Hands model loading variables
const HANDS_MODEL_URL = "/assets/Hands.glb";
let handsModel = null;
  
// Reset all bones back to stored baseline
function resetAllBones(){
  if (!skeleton) return;
  skeleton.bones.forEach(b=>{
    const q0 = initialBoneRot.get(b);
    if (q0) b.quaternion.copy(q0);
  });
}

// Tests that use the GradingExceptions dropdown (5‚Äì1) instead of the normal 3‚Äì0 scale.
// NOTE: Pelvic_Elevation is NOT an exception.
const EXCEPTION_TESTS = new Set([
  "Trunk_Ext_Lumbar",
  "Trunk_Ext_Thoracic",
  "Trunk_Flexion",
  "Trunk_Rotation",
  "Gastrocnemius"
]);


// For each test: which coarse body position to use for high (3‚Äì5) vs low (0‚Äì2) grades
// Modes: 'anatomic', 'seated', 'supine', 'prone', 'side_lying', 'gastroc'
const TEST_POSITION = {
  // Cervical & Capital
  Capital_Extension:   { high: "prone",      low: "supine"      },
  Cervical_Extension:  { high: "prone",      low: "supine"      },
  Capital_Flexion:     { high: "supine",     low: "supine"      },
  Cervical_Flexion:    { high: "supine",     low: "supine"  },
  Single_SCM:          { high: "supine",     low: "supine"      },
  Cervical_Rotation:   { high: "supine",     low: "seated"      },

  // Scapula
  Serratus_Anterior:   { high: "seated",     low: "seated"      },
  Upper_Trapezius:     { high: "seated",     low: "prone"       },
  Middle_Trapezius:    { high: "prone",      low: "prone"       },
  Scap_Depression_Adduction: { high: "prone", low: "prone" },
  Rhomboids:           { high: "prone",      low: "seated"       },
  Latissimus_Dorsi:    { high: "prone",      low: "prone"  },

  // Shoulder
  Anterior_Deltoid:    { high: "seated",     low: "side_lying"  },
  Posterior_Deltoid:   { high: "prone",      low: "prone"  },
  Middle_Deltoid:      { high: "seated",     low: "supine"      },
  Shoulder_Horiz_Abd: { high: "prone",  low: "seated" }, 
  Shoulder_Horiz_Add: { high: "supine", low: "seated" }, 
  Infraspinatus:       { high: "seated",     low: "seated"      }, // table-supported NG
  Subscapularis:       { high: "seated",     low: "seated"      },

// --- Trunk & Pelvis (Updated for Grade Independence) ---
Trunk_Ext_Lumbar:   { high: "prone",  3: "prone", low: "prone" },
Trunk_Ext_Thoracic: { high: "prone",  3: "prone", low: "prone" },
Trunk_Flexion:      { 5: "supine", 4: "supine", 3: "supine", low: "supine" },
Trunk_Rotation:     { 5: "supine", 4: "supine", 3: "supine", low: "supine" },
Pelvic_Elevation:   { high: "supine", low: "supine" },

  // Elbow
  Biceps_Brachii:      { high: "seated",     low: "seated"  },  // seatednogravity
  Brachialis:          { high: "seated",     low: "seated"  },
  Brachioradialis:     { high: "seated",     low: "seated"  },
  Triceps_Brachii:     { high: "prone",     low: "seated"      },

  // Wrist
  ECRL:                { high: "seated",  low: "seated" },
  ECRB:                { high: "seated",  low: "seated" },
  ECU:                 { high: "seated",  low: "seated" },
  FCR:                 { high: "seated",  low: "seated" },
  FCU:                 { high: "seated",  low: "seated" },

   // Hip
  Iliopsoas:           { high: "seated",     low: "side_lying"  },
  Glute_Max:           { high: "prone",      low: "side_lying"  },
  Glute_Med:           { high: "side_lying", low: "supine"      },
  TFL:                 { high: "side_lying", low: "long_sit"    },
  Hip_Adduction:       { high: "side_lying", low: "supine"      },
  Sartorius:           { high: "seated",     low: "supine"      },
  Hip_ER:              { high: "seated",     low: "supine"      },
  Hip_IR:              { high: "seated",     low: "supine"      },

  // Knee
  Hamstrings:          { high: "prone",      low: "side_lying"  },
  Quadriceps:          { high: "seated",     low: "side_lying"  },

  // Ankle & Foot
  Tibialis_Anterior:   { high: "supine",     low: "supine"      }, // dorsiflex+inv
  Foot_Eversion_PF:    { high: "seated",     low: "seated"      }, //platar+ev
  Gastrocnemius:       { high: "gastroc",    low: "gastroc"  }  //table stand
};

// Decide if we're in the high (3‚Äì5) or low (0‚Äì2) family for a given test
// Per-test pose overrides (absolute position + rotation) keyed by "TestKey:high" / "TestKey:low"
const POSE_OVERRIDES = {};
POSE_OVERRIDES["Capital_Extension:high"] = { x:-0.800, y:0.820, z:0.330, rx:-1.571, ry:3.142, rz:1.222 }; //prone head off
POSE_OVERRIDES["Capital_Extension:low"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 }; //supine
POSE_OVERRIDES["Cervical_Extension:high"]  = { x:-0.800, y:0.820, z:0.330, rx:-1.571, ry:3.142, rz:1.222 };
POSE_OVERRIDES["Cervical_Extension:low"]   = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };
POSE_OVERRIDES["Capital_Flexion:high"] = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };  
POSE_OVERRIDES["Capital_Flexion:low"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };
POSE_OVERRIDES["Cervical_Flexion:high"] = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };
POSE_OVERRIDES["Cervical_Flexion:low"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };
POSE_OVERRIDES["Single_SCM:high"] = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };
POSE_OVERRIDES["Single_SCM:low"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };
POSE_OVERRIDES["Cervical_Rotation:high"] = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };
POSE_OVERRIDES["Cervical_Rotation:low"] = { x:0.440, y:-0.460, z:-2.020, rx:0.000, ry:0.349, rz:0.000 };  //seated on chair arm ZX
POSE_OVERRIDES["Serratus_Anterior:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  //seated on bed
POSE_OVERRIDES["Serratus_Anterior:low"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Upper_Trapezius:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Upper_Trapezius:low"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 }; //normal prone
POSE_OVERRIDES["Middle_Trapezius:high"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };
POSE_OVERRIDES["Middle_Trapezius:low"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };
POSE_OVERRIDES["Scap_Depression_Adduction:high"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };  //prone
POSE_OVERRIDES["Scap_Depression_Adduction:low"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };  //prone
POSE_OVERRIDES["Rhomboids:high"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };  
POSE_OVERRIDES["Rhomboids:low"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000,  };  // seated on bed
POSE_OVERRIDES["Latissimus_Dorsi:high"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };  
POSE_OVERRIDES["Latissimus_Dorsi:low"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };  
POSE_OVERRIDES["Anterior_Deltoid:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000  }; //seated
POSE_OVERRIDES["Anterior_Deltoid:low"] = { x:-1.280, y:0.800, z:0.490, rx:2.705, ry:-3.491, rz:1.745 }; //side lying  
POSE_OVERRIDES["Posterior_Deltoid:high"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920  };
POSE_OVERRIDES["Posterior_Deltoid:low"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 }; //normal prone
POSE_OVERRIDES["Middle_Deltoid:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000,  };  // seated on bed
POSE_OVERRIDES["Middle_Deltoid:low"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };  //supine
POSE_OVERRIDES["Shoulder_Horiz_Abd:high"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };  //prone
POSE_OVERRIDES["Shoulder_Horiz_Abd:low"] = { x:0.350, y:-0.480, z:-1.860, rx:-0.087, ry:0.349, rz:0.000 }; ///non gravity table
POSE_OVERRIDES["Shoulder_Horiz_Add:high"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };  //supine
POSE_OVERRIDES["Shoulder_Horiz_Add:low"] = { x:0.340, y:-0.480, z:-1.860, rx:-0.087, ry:0.349, rz:0.000 }; ///non gravity table
POSE_OVERRIDES["Infraspinatus:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Infraspinatus:low"] = { x:0.540, y:-0.480, z:-1.860, rx:-0.087, ry:0.349, rz:0.000  };  
POSE_OVERRIDES["Subscapularis:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Subscapularis:low"] = { x:0.360, y:-0.480, z:-1.860, rx:-0.087, ry:0.349, rz:0.000  };

POSE_OVERRIDES["Trunk_Ext_Lumbar:high"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };  //prone
POSE_OVERRIDES["Trunk_Ext_Lumbar:3"] = { x:-0.580, y:0.820, z:0.250, rx:1.571, ry:0.000, rz:-1.920 };
POSE_OVERRIDES["Trunk_Ext_Lumbar:low"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };  //prone

POSE_OVERRIDES["Trunk_Ext_Thoracic:high"] = { x:-0.600, y:0.800, z:0.250, rx:1.571, ry:0.000, rz:-1.920 };
POSE_OVERRIDES["Trunk_Ext_Thoracic:3"] = { x:-0.580, y:0.820, z:0.250, rx:1.571, ry:0.000, rz:-1.920 };
POSE_OVERRIDES["Trunk_Ext_Thoracic:low"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };  //prone

// Renamed to match independent grade strings 5, 4, and 3
POSE_OVERRIDES["Trunk_Flexion:5"] = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };
POSE_OVERRIDES["Trunk_Flexion:4"] = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };
POSE_OVERRIDES["Trunk_Flexion:3"] = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };

// Remains as 'low' for Grades 1-2 
POSE_OVERRIDES["Trunk_Flexion:low"] = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };

// Renamed to match independent grade strings 5, 4, and 3
POSE_OVERRIDES["Trunk_Rotation:5"] = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };
POSE_OVERRIDES["Trunk_Rotation:4"] = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };
POSE_OVERRIDES["Trunk_Rotation:3"] = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };

// Remains as 'low' for Grades 1-2
POSE_OVERRIDES["Trunk_Rotation:low"] = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };

POSE_OVERRIDES["Pelvic_Elevation:high"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };  //supine
POSE_OVERRIDES["Pelvic_Elevation:low"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };  //supine 3-1 low






POSE_OVERRIDES["Biceps_Brachii:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Biceps_Brachii:low"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Brachialis:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Brachialis:low"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Brachioradialis:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Brachioradialis:low"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Triceps_Brachii:high"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };  //prone
POSE_OVERRIDES["Triceps_Brachii:low"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["FCR:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["FCR:low"] = { x:0.620, y:-0.460, z:-2.080, rx:0.000, ry:0.349, rz:0.000 };  //seated on chair 
POSE_OVERRIDES["FCU:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["FCU:low"] = { x:0.620, y:-0.460, z:-2.080, rx:0.000, ry:0.349, rz:0.000 };  //seated on chair 
POSE_OVERRIDES["ECRL:high"] = { x:0.420, y:-0.480, z:-2.000, rx:0.000, ry:0.349, rz:0.000 }; // gravity table
POSE_OVERRIDES["ECRL:low"] = { x:0.480, y:-0.480, z:-1.860, rx:-0.087, ry:0.349, rz:0.000 }; ///non gravity table
POSE_OVERRIDES["ECRB:high"] = { x:0.420, y:-0.480, z:-2.000, rx:0.000, ry:0.349, rz:0.000  };
POSE_OVERRIDES["ECRB:low"] = { x:0.480, y:-0.480, z:-1.860, rx:-0.087, ry:0.349, rz:0.000 };  
POSE_OVERRIDES["ECU:high"] = { x:0.420, y:-0.480, z:-2.000, rx:0.000, ry:0.349, rz:0.000 };
POSE_OVERRIDES["ECU:low"] = { x:0.480, y:-0.480, z:-1.860, rx:-0.087, ry:0.349, rz:0.000 };  
POSE_OVERRIDES["FCR:high"] = { x:0.420, y:-0.480, z:-2.000, rx:0.000, ry:0.349, rz:0.000 };
POSE_OVERRIDES["FCR:low"] = { x:0.480, y:-0.480, z:-1.860, rx:-0.087, ry:0.349, rz:0.000 };  
POSE_OVERRIDES["FCU:high"] = { x:0.420, y:-0.480, z:-2.000, rx:0.000, ry:0.349, rz:0.000 };  
POSE_OVERRIDES["FCU:low"] = { x:0.480, y:-0.480, z:-1.860, rx:-0.087, ry:0.349, rz:0.000 };  
POSE_OVERRIDES["Iliopsoas:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Iliopsoas:low"] = { x:-1.280, y:0.813, z:0.490, rx:2.705, ry:-3.491, rz:1.745 }; //side lying  
POSE_OVERRIDES["Glute_Max:high"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };  //prone
POSE_OVERRIDES["Glute_Max:low"] = { x:-1.280, y:0.813, z:0.490, rx:2.705, ry:-3.491, rz:1.745 }; //side lying  
POSE_OVERRIDES["Glute_Med:high"] = { x:-1.280, y:0.813, z:0.490, rx:2.705, ry:-3.491, rz:1.745 }; //side lying  
POSE_OVERRIDES["Glute_Med:low"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };  //supine 
POSE_OVERRIDES["TFL:high"] = { x:-1.280, y:0.815, z:0.490, rx:2.705, ry:-3.491, rz:1.745 }; //side lying  
POSE_OVERRIDES["TFL:low"] = { x:-0.280, y:-0.260, z:0.110, rx:-0.524, ry:-1.222, rz:-0.524 }; //long sit
POSE_OVERRIDES["Hip_Adduction:high"] = { x:-1.280, y:0.815, z:0.490, rx:2.705, ry:-3.491, rz:1.745 }; //side lying  
POSE_OVERRIDES["Hip_Adduction:low"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };  //supine 
POSE_OVERRIDES["Sartorius:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Sartorius:low"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };  //supine 
POSE_OVERRIDES["Hip_ER:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Hip_ER:low"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };  //supine 
POSE_OVERRIDES["Hip_IR:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Hip_IR:low"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };  //supine 
POSE_OVERRIDES["Hamstrings:high"] = { x:-1.200, y:0.820, z:0.470, rx:1.571, ry:0.000, rz:-1.920 };   //prone  special
POSE_OVERRIDES["Hamstrings:low"] = { x:-1.280, y:0.815, z:0.490, rx:2.705, ry:-3.491, rz:1.745 }; //side lying  
POSE_OVERRIDES["Quadriceps:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Quadriceps:low"] = { x:-1.280, y:0.815, z:0.490, rx:2.705, ry:-3.491, rz:1.745 }; //side lying  
POSE_OVERRIDES["Tibialis_Anterior:high"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };  //supine 
POSE_OVERRIDES["Tibialis_Anterior:low"]  = { x:-1.220, y:0.740, z:0.470, rx:-1.571, ry:-0.000, rz:-1.222 };  //supine 
POSE_OVERRIDES["Foot_Eversion_PF:high"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Foot_Eversion_PF:low"] = { x:-0.620, y:-0.280, z:0.260, rx:0.000, ry:0.349, rz:0.000 };  // seated on bed
POSE_OVERRIDES["Gastrocnemius:high"] = { x:-0.480, y:0.060, z:-1.620, rx:0.000, ry:1.920, rz:0.000 };
POSE_OVERRIDES["Gastrocnemius:low"] = { x:-1.520, y:0.800, z:0.550, rx:1.571, ry:0.000, rz:-1.920 };  //prone

/* ==== NEW: Starting Pose Bone Overrides (Applied when resistance is NOT active) ==== */
const BONE_OVERRIDES_START = {};
BONE_OVERRIDES_START["TFL:high"] = { calf_L:{ x:-48.4, y:-3.8, z:-3.8 }, hand_R:{ x:65.0, y:-50.4, z:44.7 }, lowerarm_L:{ x:100.0, y:6.5, z:7.2 }, lowerarm_R:{ x:97.4, y:-10.4, z:47.0 }, neck:{ x:45.4, y:6.0, z:-29.8 }, thigh_L:{ x:4.1, y:19.9, z:179.6 }, thigh_R:{ x:-1.9, y:8.1, z:-160.7 }, upperarm_L:{ x:-14.1, y:-24.9, z:-77.4 }, upperarm_R:{ x:-1.5, y:8.3, z:78.3 } };

////Bone Overrides Normal///

  
const BONE_OVERRIDES = {};
BONE_OVERRIDES["Capital_Extension:high"] = { foot_L:{ x:15.5, y:-4.4, z:-7.2 }, foot_R:{ x:15.5, y:4.4, z:7.2 } };
BONE_OVERRIDES["Cervical_Extension:high"] = { foot_L:{ x:15.5, y:-4.4, z:-7.2 }, foot_R:{ x:15.5, y:4.4, z:7.2 } };  
BONE_OVERRIDES["Single_SCM:high"] = { head:{ x:-8.9, y:59.8, z:9.0 } };  
  
BONE_OVERRIDES["Serratus_Anterior:high"] = { lowerarm_L:{ x:54.4, y:4.0, z:-0.1 }, upperarm_R:{ x:64.2, y:57.2, z:16.3 } };
BONE_OVERRIDES["Upper_Trapezius:high"] = { clavicle_L:{ x:-0.9, y:-5.1, z:-72.9 }, clavicle_R:{ x:-0.9, y:5.1, z:72.9 }, hand_L:{ x:-85.1, y:8.3, z:13.4 }, hand_R:{ x:-85.0, y:-8.3, z:-13.1 }, lowerarm_L:{ x:39.3, y:3.9, z:0.9 }, lowerarm_R:{ x:39.3, y:-3.8, z:-1.1 }, upperarm_L:{ x:-12.1, y:8.3, z:-93.2 }, upperarm_R:{ x:-12.0, y:-8.8, z:93.2 } };
BONE_OVERRIDES["Middle_Trapezius:high"] = { clavicle_R:{ x:-0.9, y:5.1, z:87.9 }, foot_L:{ x:14.1, y:-11.4, z:-14.5 }, foot_R:{ x:15.5, y:4.4, z:7.2 }, lowerarm_R:{ x:97.3, y:-17.7, z:22.4 }, upperarm_R:{ x:-1.9, y:-8.1, z:4.7 } };  
BONE_OVERRIDES["Scap_Depression_Adduction:high"] = { hand_R:{ x:-6.5, y:15.6, z:6.1 }, foot_L:{ x:14.1, y:-11.4, z:-14.5 }, foot_R:{ x:15.5, y:4.4, z:7.2 }, lowerarm_R:{ x:16.4, y:37.0, z:-3.3 }, upperarm_R:{ x:10.6, y:6.7, z:-66.4 } };
BONE_OVERRIDES["Rhomboids:high"] = { clavicle_R:{ x:-0.9, y:5.1, z:82.9 }, foot_L:{ x:14.1, y:-11.4, z:-14.5 }, foot_R:{ x:15.5, y:4.4, z:7.2 }, lowerarm_R:{ x:118.7, y:-66.0, z:22.7 }, upperarm_R:{ x:105.4, y:-25.9, z:100.9 } };
BONE_OVERRIDES["Latissimus_Dorsi:high"] = { clavicle_R:{ x:-0.9, y:5.1, z:97.9 }, foot_L:{ x:14.1, y:-11.4, z:-14.5 }, foot_R:{ x:15.5, y:4.4, z:7.2 }, upperarm_R:{ x:65.8, y:-32.8, z:90.9 } };  

BONE_OVERRIDES["Anterior_Deltoid:high"] = { spine01:{ x:6.0, y:-0.0, z:0.0 }, upperarm_L:{ x:-1.6, y:-8.8, z:-58.2 }, upperarm_R:{ x:54.8, y:62.1, z:27.5 } };
BONE_OVERRIDES["Posterior_Deltoid:high"] = { clavicle_R:{ x:1.8, y:16.0, z:92.0 }, foot_L:{ x:14.1, y:-11.4, z:-14.5 }, foot_R:{ x:15.5, y:4.4, z:7.2 }, lowerarm_R:{ x:12.0, y:-42.9, z:-3.6 }, upperarm_R:{ x:72.7, y:-23.0, z:104.9 } };
BONE_OVERRIDES["Middle_Deltoid:high"] = { clavicle_L:{ x:-0.4, y:4.8, z:-97.9 }, hand_L:{ x:-104.3, y:22.4, z:143.2 }, lowerarm_L:{ x:17.1, y:14.6, z:-10.6 }, upperarm_L:{ x:30.7, y:5.8, z:-68.9 }, upperarm_R:{ x:-12.0, y:-8.8, z:-6.8 } };
BONE_OVERRIDES["Shoulder_Horiz_Abd:high"] = { hand_R:{ x:-5.9, y:10.7, z:6.0 }, upperarm_R:{ x:-12.0, y:-8.8, z:-11.8}, foot_L:{ x:14.1, y:-11.4, z:-14.5 }, foot_R:{ x:15.5, y:4.4, z:7.2 }, lowerarm_R:{ x:94.4, y:-3.1, z:2.5 } };
BONE_OVERRIDES["Shoulder_Horiz_Add:high"] = { clavicle_R:{ x:-0.9, y:5.1, z:87.9 }, lowerarm_R:{ x:124.4, y:-1.4, z:3.7 }, upperarm_R:{ x:47.1, y:2.6, z:11.7 } };
BONE_OVERRIDES["Infraspinatus:high"] = { lowerarm_L:{ x:54.4, y:4.0, z:-0.1 }, lowerarm_R:{ x:117.4, y:-39.1, z:20.4 } };
BONE_OVERRIDES["Subscapularis:high"] = { lowerarm_L:{ x:54.4, y:4.0, z:-0.1 }, lowerarm_R:{ x:68.9, y:-43.4, z:-31.0 } };


// TRUNK EXTENSION - LUMBAR (Grades 5 & 4 share High Family)
BONE_OVERRIDES["Trunk_Ext_Lumbar:high"] = { clavicle_L:{ x:-0.6, y:-15.1, z:-77.8 }, clavicle_R:{ x:24.0, y:11.9, z:86.3 }, foot_L:{ x:20.4, y:-5.0, z:-6.8 }, foot_R:{ x:10.5, y:3.8, z:7.6 }, hand_L:{ x:12.2, y:40.0, z:-0.0 }, hand_R:{ x:10.8, y:-32.7, z:-16.5 }, lowerarm_L:{ x:53.5, y:27.2, z:119.1 }, lowerarm_R:{ x:51.1, y:-20.0, z:-116.6 }, spine01:{ x:-29.0, y:-0.0, z:0.0 }, spine03:{ x:-4.9, y:0.0, z:-0.0 }, thigh_L:{ x:3.9, y:-0.1, z:174.6 }, thigh_R:{ x:3.9, y:0.1, z:-174.6 }, upperarm_L:{ x:-4.8, y:4.5, z:36.3 }, upperarm_R:{ x:-17.5, y:27.5, z:-38.9 } };  
// TRUNK EXTENSION - THORACIC (Grades 5 & 4 share High Family)
BONE_OVERRIDES["Trunk_Ext_Thoracic:high"] = { clavicle_L:{ x:-0.6, y:-15.1, z:-77.8 }, clavicle_R:{ x:24.0, y:11.9, z:86.3 }, foot_L:{ x:20.4, y:-5.0, z:-6.8 }, foot_R:{ x:10.5, y:3.8, z:7.6 }, hand_L:{ x:12.2, y:40.0, z:-0.0 }, hand_R:{ x:10.8, y:-32.7, z:-16.5 }, lowerarm_L:{ x:53.5, y:27.2, z:119.1 }, lowerarm_R:{ x:51.1, y:-20.0, z:-116.6 }, spine01:{ x:-29.0, y:-0.0, z:0.0 }, spine03:{ x:-4.9, y:0.0, z:-0.0 }, thigh_L:{ x:3.9, y:-0.1, z:174.6 }, thigh_R:{ x:3.9, y:0.1, z:-174.6 }, upperarm_L:{ x:-4.8, y:4.5, z:36.3 }, upperarm_R:{ x:-17.5, y:27.5, z:-38.9 } };  

// TRUNK FLEXION (Independent Grade 4)
BONE_OVERRIDES["Trunk_Flexion:4"] = {  hand_L: { x: 6.9, y: 13.3, z: -8.5 },  lowerarm_L: { x: 130.1, y: -19.9, z: -45.1 }, lowerarm_R: { x: 126.4, y: 16.1, z: 51.1 }, spine01: { x: 41.0, y: -0.0, z: 0.0 }, thigh_L: { x: 3.9, y: -0.1, z: 179.6 }, thigh_R: { x: 3.9, y: 0.1, z: -179.6 }, upperarm_L: { x: -5.7, y: -5.5, z: -53.7 }, upperarm_R: { x: 7.3, y: 20.7, z: 51.0 } };


// TRUNK EXTENSION - LUMBAR (Independent Grade 3)
BONE_OVERRIDES["Trunk_Ext_Lumbar:3"] = {  foot_L:{ x:15.5, y:-4.4, z:-7.2 }, foot_R:{ x:15.5, y:4.4, z:7.2 }, hand_L:{ x:14.4, y:-5.7, z:-14.8 }, hand_R:{ x:1.2, y:-8.7, z:7.2 }, lowerarm_L:{ x:16.8, y:-21.6, z:127.9 },  lowerarm_R:{ x:30.3, y:4.6, z:-127.1 }, spine01:{ x:-14.0, y:0.0, z:0.0 }, upperarm_L:{ x:-12.1, y:8.3, z:56.8 }, upperarm_R:{ x:-12.0, y:-8.8, z:-66.8 } };

// TRUNK EXTENSION - THORACIC (Independent Grade 3)
BONE_OVERRIDES["Trunk_Ext_Thoracic:3"] = { foot_L:{ x:15.5, y:-4.4, z:-7.2 }, foot_R:{ x:15.5, y:4.4, z:7.2 }, hand_L:{ x:14.4, y:-5.7, z:-14.8 }, hand_R:{ x:1.2, y:-8.7, z:7.2 }, lowerarm_L:{ x:16.8, y:-21.6, z:127.9 }, lowerarm_R:{ x:30.3, y:4.6, z:-127.1 }, spine01:{ x:-14.0, y:0.0, z:0.0 }, 
 upperarm_L:{ x:-12.1, y:8.3, z:56.8 }, upperarm_R:{ x:-12.0, y:-8.8, z:-66.8 } };

// TRUNK ROTATION (Independent Grade 5)
BONE_OVERRIDES["Trunk_Rotation:5"] = { clavicle_L: { x: -0.9, y: -5.1, z: -72.9 }, clavicle_R: { x: -0.9, y: 5.1, z: 82.9 }, hand_L: { x: 4.1, y: -12.1,z: -14.0 }, hand_R: { x: -18.8, y: 18.5, z: 15.1 }, lowerarm_L: { x: 12.5, y: 10.7, z: 133.0 },lowerarm_R: { x: 3.0, y: -19.7, z: -134.9 }, 
  spine01: { x: 11.9, y: 48.8, z: 9.4 }, spine02: { x: 10.6, y: 24.2, z: -0.2 }, spine03: { x: 2.6, y: -33.9, z: -2.0 }, thigh_L: { x: 3.9, y: -0.1, z: 174.6 }, thigh_R: { x: 3.9, y: 0.1, z: -174.6 }, upperarm_L: { x: -12.4, y: -10.4, z: 35.5 }, upperarm_R: { x: 60.6, y: -0.5, z: -8.6 } };
BONE_OVERRIDES["Trunk_Rotation:4"] = { hand_L:{ x:17.1, y:37.1, z:-11.8 }, hand_R:{ x:-6.1, y:-34.5, z:7.5 }, lowerarm_L:{ x:131.0, y:-9.2, z:-50.3 }, lowerarm_R:{ x:117.1, y:33.6, z:49.0 }, upperarm_L:{ x:6.8, y:-21.4, z:-55.9 }, upperarm_R:{ x:4.6, y:10.0, z:48.1 }, spine01:{ x:33.1, y:34.5, z:-6.0 } };
BONE_OVERRIDES["Trunk_Rotation:3"] = { spine01:{ x:28.9, y:44.8, z:5.0 }, upperarm_L:{ x:35.2, y:0.0, z:-70.5 }, upperarm_R:{ x:29.0, y:4.4, z:70.0 } };


BONE_OVERRIDES["Trunk_Flexion:5"] = { clavicle_L:{ x:-0.9, y:-5.1, z:-77.9 }, clavicle_R:{ x:-0.9, y:5.1, z:67.9 }, hand_L:{ x:-5.9, y:-10.3, z:-6.0 }, lowerarm_L:{ x:13.8, y:9.7, z:132.4 }, lowerarm_R:{ x:17.6, y:-6.2, z:-138.1 }, spine01:{ x:41.0, y:-0.0, z:0.0 }, spine03:{ x:20.1, y:0.0, z:-0.0 }, thigh_L:{ x:3.9, y:-0.1, z:174.6 }, thigh_R:{ x:3.9, y:0.1, z:-174.6 }, upperarm_L:{ x:6.8, y:5.1, z:20.0 }, upperarm_R:{ x:-12.0, y:-8.8, z:-11.8 } };

BONE_OVERRIDES["Trunk_Flexion:3"] = { spine01:{ x:31.0, y:-0.0, z:0.0 }, upperarm_L:{ x:43.4, y:3.2, z:-62.9 }, upperarm_R:{ x:45.2, y:-10.4, z:54.2 } };


// PELVIC ELEVATION (Grades 5 & 4 share High Family)
BONE_OVERRIDES["Pelvic_Elevation:high"] = { foot_R:{ x:40.5, y:7.1, z:4.7 }, lowerarm_L:{ x:4.6, y:1.4, z:-6.5 }, lowerarm_R:{ x:9.3, y:-2.7, z:-2.9 }, thigh_L:{ x:-1.1, y:-0.5, z:-175.4 }, thigh_R:{ x:3.9, y:0.1, z:175.4 }, upperarm_L:{ x:-19.3, y:10.2, z:-61.8 }, upperarm_R:{ x:-15.1, y:-12.8, z:62.6 } };


BONE_OVERRIDES["Biceps_Brachii:high"] = { clavicle_R:{ x:12.2, y:14.2, z:115.0 }, hand_R:{ x:54.7, y:8.7, z:-3.1 }, lowerarm_L:{ x:34.3, y:3.8, z:1.3 }, lowerarm_R:{ x:49.3, y:-3.9, z:-0.4 }, upperarm_L:{ x:-0.7, y:-63.1, z:-69.4 }, upperarm_R:{ x:-20.4, y:-3.4, z:56.5 } };
BONE_OVERRIDES["Brachialis:high"] = { clavicle_L:{ x:-30.6, y:1.7, z:-93.4 }, clavicle_R:{ x:0.8, y:16.2, z:93.4 }, hand_L:{ x:-0.0, y:39.4, z:-7.6 }, lowerarm_L:{ x:-2.7, y:49.2, z:80.0 }, upperarm_L:{ x:53.5, y:32.2, z:-83.9 }, hand_R:{ x:54.7, y:8.7, z:-3.1 }, lowerarm_R:{ x:4.3, y:-2.5, z:-3.0 }, upperarm_R:{ x:-14.9, y:4.9, z:71.5 }  };  
BONE_OVERRIDES["Brachioradialis:high"] = { lowerarm_L:{ x:18.8, y:28.3, z:30.1 }, upperarm_L:{ x:42.0, y:-13.9, z:-40.5 }, lowerarm_R:{ x:34.3, y:-3.7, z:-1.4 }, upperarm_R:{ x:-15.1, y:-12.8, z:62.6 }, hand_R:{ x:54.7, y:8.7, z:-3.1 } };
BONE_OVERRIDES["Triceps_Brachii:high"] = { clavicle_L:{ x:-0.9, y:-5.1, z:-102.9 }, clavicle_R:{ x:-0.8, y:10.1, z:87.9 }, foot_L:{ x:15.5, y:-4.4, z:-7.2 }, foot_R:{ x:20.4, y:5.0, z:6.8 }, upperarm_R:{ x:-12.0, y:-8.8, z:-1.8 }, clavicle_R:{ x:12.2, y:14.2, z:115.0 } };

BONE_OVERRIDES["ECRL:high"] = { hand_R:{ x:-75.3, y:-15.3, z:-59.5 }, index01_R:{ x:-12.2, y:11.6, z:-5.1 }, index02_R:{ x:-9.5, y:-5.3, z:-4.6 }, index03_R:{ x:2.1, y:5.1, z:-1.3 }, lowerarm_R:{ x:66.5, y:-44.3, z:-4.1 }, upperarm_R:{ x:20.4, y:-2.9, z:2.4 }, foot_L:{ x:70.7, y:-8.4, z:-0.5 }, foot_R:{ x:70.7, y:8.4, z:0.5 } };
BONE_OVERRIDES["ECRB:high"] = { hand_R:{ x:-97.8, y:-14.5, z:-74.4 }, lowerarm_R:{ x:64.1, y:-54.0, z:-37.0 }, upperarm_R:{ x:-14.6, y:-28.6, z:-7.6 }, foot_L:{ x:70.7, y:-8.4, z:-0.5 }, foot_R:{ x:70.7, y:8.4, z:0.5 } };  
BONE_OVERRIDES["ECU:high"] = { hand_R:{ x:-86.1, y:-10.6, z:-17.9 }, lowerarm_R:{ x:40.6, y:-31.1, z:-78.2 }, upperarm_R:{ x:-3.0, y:-57.3, z:8.1 },foot_L:{ x:70.7, y:-8.4, z:-0.5 }, foot_R:{ x:70.7, y:8.4, z:0.5 } };
BONE_OVERRIDES["FCR:high"] = { clavicle_R:{ x:4.1, y:4.9, z:87.5 }, hand_R:{ x:65.6, y:-15.1, z:-11.2 }, lowerarm_R:{ x:55.3, y:25.3, z:60.9 }, upperarm_R:{ x:-57.6, y:54.2, z:54.9 },foot_L:{ x:70.7, y:-8.4, z:-0.5 }, foot_R:{ x:70.7, y:8.4, z:0.5 } };
BONE_OVERRIDES["FCU:high"] = { clavicle_R:{ x:4.1, y:4.9, z:87.5 }, hand_R:{ x:65.6, y:-15.1, z:45.2  }, lowerarm_R:{ x:16.4, y:37.0, z:81.7 }, upperarm_R:{ x:-57.6, y:54.2, z:54.9 },foot_L:{ x:70.7, y:-8.4, z:-0.5 }, foot_R:{ x:70.7, y:8.4, z:0.5 } };

BONE_OVERRIDES["Iliopsoas:high"] = { hand_L:{ x:-83.3, y:15.8, z:58.6 }, hand_R:{ x:-82.7, y:-19.5, z:-81.1 }, thigh_R:{ x:-96.1, y:4.5, z:-179.1 } };
BONE_OVERRIDES["Glute_Max:high"] = { foot_L:{ x:15.5, y:-4.4, z:-7.2 }, foot_R:{ x:20.4, y:5.6, z:7.3 }, thigh_L:{ x:13.9, y:0.7, z:-175.5 } };
BONE_OVERRIDES["Glute_Med:high"] = { calf_L:{ x:-32.9, y:6.7, z:7.1 }, foot_L:{ x:60.7, y:-1.9, z:3.0 }, hand_L:{ x:41.3, y:14.7, z:-25.6 }, hand_R:{ x:26.9, y:-9.3, z:12.4 }, lowerarm_L:{ x:119.1, y:33.4, z:-40.0 }, lowerarm_R:{ x:114.4, y:-40.4, z:33.9 }, neck:{ x:27.6, y:-0.0, z:0.0 }, spine03:{ x:10.7, y:7.8, z:4.5 }, thigh_L:{ x:-16.1, y:27.7, z:-175.3 }, thigh_R:{ x:6.1, y:25.0, z:174.9 }, upperarm_L:{ x:47.2, y:-2.8, z:-60.5 }, upperarm_R:{ x:-4.8, y:-17.2, z:60.4 } };
BONE_OVERRIDES["TFL:high"] = { calf_L:{ x:-48.4, y:-3.8, z:-3.8 }, hand_R:{ x:65.0, y:-50.4, z:44.7 }, lowerarm_L:{ x:100.0, y:6.5, z:7.2 }, lowerarm_R:{ x:97.4, y:-10.4, z:47.0 }, neck:{ x:45.4, y:6.0, z:-29.8 }, thigh_L:{ x:4.1, y:19.9, z:179.6 }, thigh_R:{ x:18.2, y:7.4, z:171.5 }, upperarm_L:{ x:-14.1, y:-24.9, z:-77.4 }, upperarm_R:{ x:-1.5, y:8.3, z:78.3 } };                                                                                              
BONE_OVERRIDES["Hip_Adduction:high"] = { lowerarm_L:{ x:-2.7, y:2.6, z:-9.5 }, neck:{ x:46.2, y:-6.3, z:-29.2 }, thigh_L:{ x:3.9, y:-0.1, z:164.6 }, upperarm_L:{ x:40.6, y:3.9, z:-65.0 }, upperarm_R:{ x:-13.9, y:-13.4, z:67.9 } };
BONE_OVERRIDES["Sartorius:high"] = { hand_L:{ x:-100.3, y:10.3, z:4.3 }, hand_R:{ x:-108.4, y:-17.8, z:-14.5 }, lowerarm_L:{ x:9.3, y:2.9, z:2.7 }, lowerarm_R:{ x:25.2, y:-8.3, z:6.7 }, thigh_R:{ x:-90.8, y:-25.4, z:175.6 }, upperarm_L:{ x:-1.6, y:-8.8, z:-58.2 }, upperarm_R:{ x:-4.1, y:4.0, z:58.6 } };
BONE_OVERRIDES["Hip_ER:high"] = { hand_L:{ x:-99.5, y:4.5, z:16.8 }, hand_R:{ x:-99.3, y:-2.1, z:0.1 }, thigh_R:{ x:-81.2, y:-15.4, z:179.7 }, upperarm_L:{ x:-12.1, y:8.3, z:-58.2 }, upperarm_R:{ x:-4.1, y:4.0, z:58.6 } };
BONE_OVERRIDES["Hip_IR:high"] = { hand_L:{ x:-101.0, y:9.4, z:15.2 }, hand_R:{ x:-101.4, y:-9.3, z:-19.9 }, thigh_R:{ x:-81.0, y:24.6, z:179.7 }, upperarm_L:{ x:-12.1, y:8.3, z:-58.2 } };

BONE_OVERRIDES["Hamstrings:high"] = { calf_L:{ x:-43.4, y:-3.6, z:1.6 }, calf_R:{ x:-3.4, y:1.8, z:-3.5 }, foot_R:{ x:15.5, y:4.4, z:7.2 }, hand_L:{ x:-5.8, y:-10.6, z:-5.7 }, hand_R:{ x:6.9, y:-12.9, z:8.5 }, lowerarm_L:{ x:9.3, y:2.9, z:2.7 }, thigh_L:{ x:3.9, y:-0.1, z:-175.4 }, thigh_R:{ x:3.9, y:0.1, z:175.4 }, upperarm_L:{ x:-9.5, y:4.0, z:-63.5 }, upperarm_R:{ x:-12.0, y:-8.8, z:68.2 } };
BONE_OVERRIDES["Quadriceps:high"] = { calf_R:{ x:-43.4, y:3.6, z:-1.6 }, hand_L:{ x:-101.0, y:9.4, z:15.2 }, hand_R:{ x:-100.9, y:-9.4, z:-15.8 }, thigh_R:{ x:-81.1, y:4.6, z:179.7 }, upperarm_L:{ x:-12.1, y:8.3, z:-58.2 } };

BONE_OVERRIDES["Tibialis_Anterior:high"] = { foot_R:{ x:60.6, y:8.2, z:2.0 } };
BONE_OVERRIDES["Foot_Eversion_PF:high"] = { foot_R:{ x:35.4, y:7.5, z:-14.7 }, hand_L:{ x:-94.8, y:5.9, z:14.6 }, hand_R:{ x:-101.0, y:-9.5, z:-14.9 } };
BONE_OVERRIDES["Gastrocnemius:high"] = { calf_L:{ x:-3.4, y:-1.8, z:3.5 }, calf_R:{ x:-99.0, y:2.5, z:-2.2 }, foot_L:{ x:30.4, y:-6.1, z:-5.8 }, hand_L:{ x:175.8, y:30.7, z:-173.0 }, index03_L:{ x:27.1, y:0.1, z:1.3 }, index03_R:{ x:-18.0, y:5.3, z:0.5 }, lowerarm_L:{ x:13.5, y:10.7, z:9.0 }, lowerarm_R:{ x:18.7, y:-23.1, z:-0.7 }, middle03_L:{ x:39.1, y:-0.2, z:-0.5 }, ring03_L:{ x:12.8, y:-1.5, z:-2.5 }, thigh_L:{ x:3.9, y:-0.1, z:179.6 }, thigh_R:{ x:3.9, y:0.1, z:-179.6 }, toes_L:{ x:60.7, y:6.1, z:-4.8 }, toes_R:{ x:35.3, y:-1.8, z:-0.9 }, upperarm_L:{ x:9.4, y:-3.1, z:-66.5 }, upperarm_R:{ x:20.6, y:-25.1, z:68.0 } };

//LOW//

BONE_OVERRIDES["Capital_Extension:low"] = { neck:{ x:47.6, y:-0.0, z:0.0 } };
BONE_OVERRIDES["Serratus_Anterior:low"] = { lowerarm_L:{ x:54.4, y:4.0, z:-0.1 }, upperarm_R:{ x:64.2, y:57.2, z:16.3 } };
BONE_OVERRIDES["Cervical_Rotation:low"] = { foot_L:{ x:65.7, y:-8.4, z:-1.2 }, foot_R:{ x:65.7, y:8.4, z:1.2 }, upperarm_R:{ x:7.5, y:20.7, z:67.4 } };
BONE_OVERRIDES["Upper_Trapezius:low"] = { foot_L:{ x:20.4, y:-5.0, z:-6.8 }, foot_R:{ x:20.4, y:5.0, z:6.8 } };
BONE_OVERRIDES["Middle_Trapezius:low"] = { lowerarm_R:{ x:89.4, y:-3.3, z:2.2 }, upperarm_R:{ x:-9.3, y:-4.5, z:18.5 },foot_L:{ x:20.4, y:-5.0, z:-6.8 }, foot_R:{ x:20.4, y:5.0, z:6.8 } };
BONE_OVERRIDES["Scap_Depression_Adduction:low"] = { hand_R:{ x:-6.5, y:15.6, z:6.1 }, foot_L:{ x:14.1, y:-11.4, z:-14.5 }, foot_R:{ x:15.5, y:4.4, z:7.2 }, lowerarm_R:{ x:16.4, y:37.0, z:-3.3 }, upperarm_R:{ x:10.6, y:6.7, z:-66.4 } };
BONE_OVERRIDES["Rhomboids:low"] = { clavicle_R:{ x:-0.9, y:5.1, z:82.9 }, foot_L:{ x:14.1, y:-11.4, z:-14.5 }, foot_R:{ x:15.5, y:4.4, z:7.2 }, lowerarm_R:{ x:118.7, y:-66.0, z:22.7 }, upperarm_R:{ x:105.4, y:-25.9, z:100.9 },upperarm_L:{ x:-5.4, y:-16.3, z:-63.4 } };
BONE_OVERRIDES["Latissimus_Dorsi:low"] = { clavicle_R:{ x:-0.9, y:5.1, z:97.9 }, foot_L:{ x:14.1, y:-11.4, z:-14.5 }, foot_R:{ x:15.5, y:4.4, z:7.2 }, upperarm_R:{ x:65.8, y:-32.8, z:90.9 } };  

BONE_OVERRIDES["Anterior_Deltoid:low"] = { calf_L:{ x:-73.5, y:-3.9, z:-15.5 }, hand_L:{ x:-8.5, y:15.0, z:-4.7 }, lowerarm_L:{ x:2.6, y:22.3, z:6.9 }, lowerarm_R:{ x:13.0, y:-27.9, z:-3.0 }, neck:{ x:37.6, y:-0.0, z:-25.0 }, spine01:{ x:6.0, y:-0.0, z:10.0 }, spine03:{ x:-4.9, y:0.0, z:-10.0 }, thigh_L:{ x:-21.0, y:-2.0, z:179.1 }, thigh_R:{ x:-1.1, y:0.5, z:-169.6 }, upperarm_L:{ x:15.2, y:-12.0, z:-68.5 }, upperarm_R:{ x:55.1, y:21.0, z:57.8 } };
BONE_OVERRIDES["Posterior_Deltoid:low"] = { foot_L:{ x:15.5, y:-4.4, z:-7.2 }, foot_R:{ x:20.4, y:5.0, z:6.8 }, lowerarm_L:{ x:12.2, y:-25.8, z:-14.2 }, lowerarm_R:{ x:24.3, y:-3.4, z:2.9 }, upperarm_R:{ x:-12.0, y:-8.8, z:58.2 } };
BONE_OVERRIDES["Middle_Deltoid:low"] = { calf_L:{ x:-8.4, y:-2.1, z:3.4 }, calf_R:{ x:-8.4, y:2.1, z:-3.4 }, lowerarm_L:{ x:4.3, y:2.7, z:3.0 }, lowerarm_R:{ x:9.3, y:-2.7, z:-2.9 }, thigh_L:{ x:3.9, y:-0.1, z:174.6 }, thigh_R:{ x:3.9, y:0.1, z:-174.6 }, upperarm_L:{ x:-33.3, y:4.4, z:-70.0 }, upperarm_R:{ x:-14.7, y:-13.0, z:57.7 } };
BONE_OVERRIDES["Shoulder_Horiz_Abd:low"] = { lowerarm_R:{ x:14.8, y:7.8, z:6.4 }, spine03:{ x:-4.9, y:0.0, z:5.0 }, upperarm_R:{ x:11.5, y:65.3, z:46.6 }, spine01:{ x:16.0, y:-0.0, z:0.0 } };
BONE_OVERRIDES["Shoulder_Horiz_Add:low"] = { clavicle_R:{ x:4.0, y:6.2, z:102.4 }, hand_R:{ x:6.9, y:-12.9, z:8.5 }, lowerarm_L:{ x:14.3, y:3.2, z:12.5 }, lowerarm_R:{ x:22.0, y:17.2, z:12.2 }, spine01:{ x:16.0, y:-0.0, z:0.0 }, spine03:{ x:-4.9, y:10.0, z:-0.0 }, upperarm_R:{ x:-1.7, y:57.1, z:25.6 } };
BONE_OVERRIDES["Infraspinatus:low"] = { clavicle_R:{ x:8.9, y:7.3, z:101.8 }, lowerarm_R:{ x:49.2, y:3.4, z:8.2 }, upperarm_L:{ x:-9.5, y:4.0, z:-58.5 }, upperarm_R:{ x:12.8, y:24.1, z:10.4 } };
BONE_OVERRIDES["Subscapularis:low"] = { clavicle_R:{ x:-0.9, y:5.1, z:102.9 }, hand_R:{ x:-8.4, y:-14.7, z:-0.2 }, lowerarm_R:{ x:79.1, y:-5.6, z:14.2 }, spine01:{ x:16.0, y:5.0, z:0.0 }, spine03:{ x:5.1, y:0.0, z:-0.0 }, upperarm_L:{ x:-12.1, y:8.3, z:-53.2 }, upperarm_R:{ x:1.3, y:23.6, z:7.4 } };


BONE_OVERRIDES["Biceps_Brachii:low"] = { clavicle_R:{ x:1.3, y:-4.6, z:107.9 }, hand_R:{ x:37.8, y:21.1, z:1.9 }, lowerarm_L:{ x:49.3, y:4.0, z:0.2 }, lowerarm_R:{ x:44.3, y:-3.9, z:-0.8 }, upperarm_L:{ x:38.6, y:-35.2, z:-27.7 }, upperarm_R:{ x:-12.0, y:-8.8, z:58.2 } };
BONE_OVERRIDES["Brachialis:low"] = { clavicle_R:{ x:1.3, y:-4.6, z:107.9 }, hand_R:{ x:37.8, y:21.1, z:1.9 }, lowerarm_L:{ x:49.3, y:4.0, z:0.2 }, lowerarm_R:{ x:44.3, y:-3.9, z:-0.8 }, upperarm_L:{ x:38.6, y:-35.2, z:-27.7 }, upperarm_R:{ x:-12.0, y:-8.8, z:58.2 } };
BONE_OVERRIDES["Brachioradialis:low"] = { clavicle_R:{ x:1.3, y:-4.6, z:107.9 }, hand_R:{ x:37.8, y:21.1, z:1.9 }, lowerarm_L:{ x:49.3, y:4.0, z:0.2 }, lowerarm_R:{ x:44.3, y:-3.9, z:-0.8 }, upperarm_L:{ x:38.6, y:-35.2, z:-27.7 }, upperarm_R:{ x:-12.0, y:-8.8, z:58.2 } };
BONE_OVERRIDES["Triceps_Brachii:low"] = { clavicle_L:{ x:-5.7, y:-3.6, z:-108.3 }, lowerarm_L:{ x:49.3, y:4.0, z:0.2 }, lowerarm_R:{ x:114.3, y:3.3, z:34.1 }, upperarm_R:{ x:21.8, y:28.5, z:45.4 } };


BONE_OVERRIDES["ECRL:low"] = { clavicle_R:{ x:5.0, y:1.4, z:102.8 }, index01_R:{ x:-58.2, y:6.8, z:-4.0 }, index02_R:{ x:-78.8, y:5.0, z:-10.9 }, index03_R:{ x:-33.0, y:5.0, z:1.9 }, lowerarm_R:{ x:46.0, y:-12.9, z:7.3 }, middle01_R:{ x:-79.0, y:10.3, z:-7.2 }, middle02_L:{ x:7.7, y:17.5, z:-15.8 }, middle02_R:{ x:-66.4, y:1.3, z:3.8 }, middle03_R:{ x:-88.4, y:-9.8, z:-21.6 }, pinky01_R:{ x:-68.1, y:1.8, z:1.7 }, pinky02_R:{ x:-33.9, y:-4.5, z:1.2 }, pinky03_R:{ x:-85.6, y:0.8, z:3.7 }, ring01_R:{ x:-72.7, y:2.2, z:0.7 }, ring02_R:{ x:-60.0, y:-0.3, z:-0.5 }, ring03_R:{ x:-62.2, y:-2.1, z:1.6 }, thumb01_R:{ x:104.9, y:75.6, z:-68.1 }, thumb02_R:{ x:4.5, y:5.9, z:-14.6 }, thumb03_R:{ x:-85.8, y:-5.7, z:-1.6 }, upperarm_R:{ x:23.7, y:21.6, z:12.4 } };
BONE_OVERRIDES["ECRB:low"] = { clavicle_R:{ x:5.0, y:1.4, z:102.8 }, index01_R:{ x:-58.2, y:6.8, z:-4.0 }, index02_R:{ x:-78.8, y:5.0, z:-10.9 }, index03_R:{ x:-33.0, y:5.0, z:1.9 }, middle01_R:{ x:-79.0, y:10.3, z:-7.2 }, middle02_L:{ x:7.7, y:17.5, z:-15.8 }, middle02_R:{ x:-66.4, y:1.3, z:3.8 }, middle03_R:{ x:-88.4, y:-9.8, z:-21.6 }, pinky01_R:{ x:-68.1, y:1.8, z:1.7 }, pinky02_R:{ x:-33.9, y:-4.5, z:1.2 }, pinky03_R:{ x:-85.6, y:0.8, z:3.7 }, ring01_R:{ x:-72.7, y:2.2, z:0.7 }, ring02_R:{ x:-60.0, y:-0.3, z:-0.5 }, ring03_R:{ x:-62.2, y:-2.1, z:1.6 }, thumb01_R:{ x:104.9, y:75.6, z:-68.1 }, thumb02_R:{ x:4.5, y:5.9, z:-14.6 }, thumb03_R:{ x:-85.8, y:-5.7, z:-1.6 }, hand_R:{ x:-24.0, y:-58.5, z:-13.5 }, lowerarm_R:{ x:48.1, y:-27.8, z:-22.0 }, upperarm_R:{ x:31.0, y:-12.7, z:11.8 } };
BONE_OVERRIDES["ECU:low"] = { clavicle_R:{ x:5.0, y:1.4, z:102.8 }, index01_R:{ x:-58.2, y:6.8, z:-4.0 }, index02_R:{ x:-78.8, y:5.0, z:-10.9 }, index03_R:{ x:-33.0, y:5.0, z:1.9 }, middle01_R:{ x:-79.0, y:10.3, z:-7.2 }, middle02_L:{ x:7.7, y:17.5, z:-15.8 }, middle02_R:{ x:-66.4, y:1.3, z:3.8 }, middle03_R:{ x:-88.4, y:-9.8, z:-21.6 }, pinky01_R:{ x:-68.1, y:1.8, z:1.7 }, pinky02_R:{ x:-33.9, y:-4.5, z:1.2 }, pinky03_R:{ x:-85.6, y:0.8, z:3.7 }, ring01_R:{ x:-72.7, y:2.2, z:0.7 }, ring02_R:{ x:-60.0, y:-0.3, z:-0.5 }, ring03_R:{ x:-62.2, y:-2.1, z:1.6 }, thumb01_R:{ x:104.9, y:75.6, z:-68.1 }, thumb02_R:{ x:4.5, y:5.9, z:-14.6 }, thumb03_R:{ x:-85.8, y:-5.7, z:-1.6 }, hand_R:{ x:-24.0, y:-58.5, z:-13.5 }, lowerarm_R:{ x:48.1, y:-27.8, z:-22.0 }, upperarm_R:{ x:31.0, y:-12.7, z:11.8 } };
BONE_OVERRIDES["FCR:low"] = { clavicle_R:{ x:4.1, y:4.9, z:87.5 }, hand_R:{ x:32.5, y:-17.8, z:-1.0 }, lowerarm_R:{ x:43.4, y:14.1, z:65.6 }, upperarm_R:{ x:-45.4, y:47.8, z:45.4 }, foot_L:{ x:70.7, y:-8.4, z:-0.5 }, foot_R:{ x:70.7, y:8.4, z:0.5 } };
BONE_OVERRIDES["FCU:low"] = { clavicle_R:{ x:5.0, y:1.4, z:102.8 }, index01_R:{ x:-58.2, y:6.8, z:-4.0 }, index02_R:{ x:-78.8, y:5.0, z:-10.9 }, index03_R:{ x:-33.0, y:5.0, z:1.9 }, lowerarm_R:{ x:46.0, y:-12.9, z:7.3 }, middle01_R:{ x:-79.0, y:10.3, z:-7.2 }, middle02_L:{ x:7.7, y:17.5, z:-15.8 }, middle02_R:{ x:-66.4, y:1.3, z:3.8 }, middle03_R:{ x:-88.4, y:-9.8, z:-21.6 }, pinky01_R:{ x:-68.1, y:1.8, z:1.7 }, pinky02_R:{ x:-33.9, y:-4.5, z:1.2 }, pinky03_R:{ x:-85.6, y:0.8, z:3.7 }, ring01_R:{ x:-72.7, y:2.2, z:0.7 }, ring02_R:{ x:-60.0, y:-0.3, z:-0.5 }, ring03_R:{ x:-62.2, y:-2.1, z:1.6 }, thumb01_R:{ x:104.9, y:75.6, z:-68.1 }, thumb02_R:{ x:4.5, y:5.9, z:-14.6 }, thumb03_R:{ x:-85.8, y:-5.7, z:-1.6 }, upperarm_R:{ x:23.7, y:21.6, z:12.4 } };



BONE_OVERRIDES["Iliopsoas:low"] = { calf_L:{ x:-38.4, y:-3.5, z:-8.1 }, head:{ x:-13.3, y:-0.9, z:-4.9 }, neck:{ x:37.1, y:-2.1, z:-24.9 }, spine01:{ x:16.0, y:-0.0, z:0.0 }, thigh_L:{ x:-1.1, y:-0.5, z:179.6 }, upperarm_L:{ x:-7.8, y:-6.1, z:-73.3 } };
BONE_OVERRIDES["Glute_Max:low"] = { calf_L:{ x:-38.4, y:-3.5, z:-8.1 }, head:{ x:-13.3, y:-0.9, z:-4.9 }, neck:{ x:37.1, y:-2.1, z:-24.9 }, spine01:{ x:16.0, y:-0.0, z:0.0 }, thigh_L:{ x:-1.1, y:-0.5, z:179.6 }, upperarm_L:{ x:-7.8, y:-6.1, z:-73.3 } };
BONE_OVERRIDES["Glute_Med:low"] = { thigh_L:{ x:3.9, y:-0.1, z:174.6 } };
BONE_OVERRIDES["TFL:low"] = { clavicle_L:{ x:-0.9, y:-5.1, z:-102.9 }, clavicle_R:{ x:-0.9, y:5.1, z:107.9 }, hand_L:{ x:5.7, y:36.5, z:-6.7 }, hand_R:{ x:-46.3, y:-57.2, z:-20.1 }, lowerarm_L:{ x:32.5, y:42.2, z:-10.5 }, lowerarm_R:{ x:33.0, y:-43.7, z:-2.0 }, thigh_L:{ x:-76.1, y:4.9, z:174.0 }, upperarm_L:{ x:-3.4, y:13.4, z:-54.9 }, upperarm_R:{ x:8.2, y:-14.6, z:56.5 } };
BONE_OVERRIDES["Sartorius:low"] = { calf_R:{ x:-48.3, y:2.5, z:13.7 }, thigh_R:{ x:-25.8, y:-0.2, z:-164.1 } };

BONE_OVERRIDES["Hamstrings:low"] = { calf_L:{ x:-38.4, y:-3.5, z:-8.1 }, head:{ x:-13.3, y:-0.9, z:-4.9 }, neck:{ x:37.1, y:-2.1, z:-24.9 }, spine01:{ x:16.0, y:-0.0, z:0.0 }, thigh_L:{ x:-1.1, y:-0.5, z:179.6 }, upperarm_L:{ x:-7.8, y:-6.1, z:-73.3 } };
BONE_OVERRIDES["Quadriceps:low"] = { calf_L:{ x:-38.4, y:-3.5, z:-8.1 }, head:{ x:-13.3, y:-0.9, z:-4.9 }, neck:{ x:37.1, y:-2.1, z:-24.9 }, spine01:{ x:16.0, y:-0.0, z:0.0 }, thigh_L:{ x:-1.1, y:-0.5, z:179.6 }, upperarm_L:{ x:-7.8, y:-6.1, z:-73.3 } };
BONE_OVERRIDES["Foot_Eversion_PF:low"] = { lowerarm_L:{ x:49.5, y:-30.9, z:-0.2 }, lowerarm_R:{ x:49.7, y:30.2, z:9.4 } };

BONE_OVERRIDES["Trunk_Ext_Lumbar:low"] = { 
    foot_L: { x: 20.4, y: -5.0, z: -6.8 }, 
    foot_R: { x: 20.4, y: 5.0, z: 6.8 } 
};
BONE_OVERRIDES["Trunk_Ext_Thoracic:low"] = { 
    foot_L: { x: 20.4, y: -5.0, z: -6.8 }, 
    foot_R: { x: 20.4, y: 5.0, z: 6.8 } 
};
BONE_OVERRIDES["Trunk_Flexion:low"] = { calf_L:{ x:-103.5, y:-3.2, z:2.6 }, calf_R:{ x:-98.5, y:3.4, z:2.1 }, foot_L:{ x:25.4, y:-5.6, z:-6.3 }, foot_R:{ x:30.4, y:6.1, z:5.8 }, thigh_L:{ x:-45.9, y:4.1, z:176.4 }, thigh_R:{ x:-41.1, y:-0.2, z:-179.6 }, upperarm_L:{ x:-17.2, y:16.9, z:-62.1 }, upperarm_R:{ x:-15.9, y:-18.0, z:62.3 } };
BONE_OVERRIDES["Trunk_Rotation:low"] = { calf_L:{ x:-103.5, y:-3.2, z:2.6 }, calf_R:{ x:-98.5, y:3.4, z:2.1 }, foot_L:{ x:25.4, y:-5.6, z:-6.3 }, foot_R:{ x:30.4, y:6.1, z:5.8 }, thigh_L:{ x:-45.9, y:4.1, z:176.4 }, thigh_R:{ x:-41.1, y:-0.2, z:-179.6 }, upperarm_L:{ x:-17.2, y:16.9, z:-62.1 }, upperarm_R:{ x:-15.9, y:-18.0, z:62.3 } };
BONE_OVERRIDES["Gastrocnemius:low"] = { foot_L:{ x:30.4, y:-6.1, z:-5.8 } };
  


/* ==== HAND OVERRIDES (new, separate from pose) ==== */
const HAND_OVERRIDES = {};
HAND_OVERRIDES["Capital_Extension:high"] = {"handRX":3.7084705208004003,"handRY":-5.1987606148409595,"handRZ":-4.6035542788667625,"handRRX":3.1683205406154173,"handRRY":-3.344445299653452,"handRRZ":-0.9229091699147043,"handLX":3.733414292335506,"handLY":-4.3146496593952115,"handLZ":-4.526662611961357,"handLRX":-0.23128912206036426,"handLRY":0.2226189086851196,"handLRZ":0.5238038715507627};
HAND_OVERRIDES["Cervical_Extension:high"] = {"handRX":3.7084705208004003,"handRY":-5.1987606148409595,"handRZ":-4.6035542788667625,"handRRX":3.1683205406154173,"handRRY":-3.344445299653452,"handRRZ":-0.9229091699147043,"handLX":4.333414292335504,"handLY":-3.7646496593952135,"handLZ":-4.576662611961357,"handLRX":0.21871087793963573,"handLRY":0.2226189086851196,"handLRZ":-0.37619612844923733};
HAND_OVERRIDES["Cervical_Flexion:high"] = {"handRX":1.542455826563102,"handRY":-4.060853327271754,"handRZ":-3.828326641731136,"handRRX":-0.15,"handRRY":0.3,"handRRZ":0,"handLX":0.37205048748288905,"handLY":-3.8157838904081656,"handLZ":-3.747229123439061,"handLRX":0.15,"handLRY":0.15,"handLRZ":-0.29999999999999993};
HAND_OVERRIDES["Capital_Flexion:high"] = {"handRX":2.3000000000000003,"handRY":-4.149999999999994,"handRZ":-2.1000000000000005,"handRRX":-5.551115123125783e-17,"handRRY":-2.5499999999999994,"handRRZ":-1.2,"handLX":1.3000000000000005,"handLY":-4.549999999999993,"handLZ":-4.099999999999993,"handLRX":0,"handLRY":0.3,"handLRZ":1.2};
HAND_OVERRIDES["Cervical_Flexion:high"] = {"handRX":1.5644328107860903,"handRY":-4.056607836412491,"handRZ":-3.8144924081652487,"handRRX":-0.15,"handRRY":0.3,"handRRZ":0,"handLX":0.37205048748288905,"handLY":-3.8157838904081656,"handLZ":-3.747229123439061,"handLRX":0.15,"handLRY":0.15,"handLRZ":-0.29999999999999993};
HAND_OVERRIDES["Single_SCM:high"] = {"handRX":3.2835587966634714,"handRY":-4.825346688143314,"handRZ":-3.6887990472163033,"handRRX":-0.15000000000000005,"handRRY":-0.75,"handRRZ":-2.5499999999999994,"handLX":1.9792747331228238,"handLY":-4.228476485371765,"handLZ":-3.8499999999999943,"handLRX":-0.15000000000000005,"handLRY":6.450000000000005,"handLRZ":7.050000000000006};
HAND_OVERRIDES["Cervical_Rotation:high"] = {"handRX":3.3950177016911813,"handRY":-4.228815656717408,"handRZ":-3.154092946149615,"handRRX":0,"handRRY":-1.2,"handRRZ":-1.4999999999999998,"handLX":2.7287945899747084,"handLY":-4.821804376030871,"handLZ":-3.8761825812379165,"handLRX":-0.9,"handLRY":-0.9,"handLRZ":0.6};


HAND_OVERRIDES["Serratus_Anterior:high"] = {"handRX":-4.442741543517701,"handRY":-2.742981837727001,"handRZ":-1.2588276110193035,"handRRX":5.551115123125783e-17,"handRRY":1.7999999999999998,"handRRZ":-1.9499999999999997,"handLX":-3.058416811942804,"handLY":-1.7946303374835402,"handLZ":0.5915965675603173,"handLRX":-0.15,"handLRY":-2.849999999999999,"handLRZ":-5.551115123125783e-17};
HAND_OVERRIDES["Upper_Trapezius:high"] = {"handRX":-2.5763380952032966,"handRY":-1.480551759906813,"handRZ":-1.9847937403107905,"handRRX":0,"handRRY":0.44999999999999996,"handRRZ":-0.15,"handLX":-4.337293361994533,"handLY":-1.625356637488423,"handLZ":-1.5373439425562927,"handLRX":0,"handLRY":0.29999999999999993,"handLRZ":0.14999999999999994};
HAND_OVERRIDES["Middle_Trapezius:high"] = {"handRX":0.5569781232474104,"handRY":-3.8660588669042086,"handRZ":-2.1216394227611883,"handRRX":0.06934454188661507,"handRRY":1.8693696440051888,"handRRZ":0.09579317124981133,"handLX":1.5195068194254806,"handLY":-4.422605334381742,"handLZ":-0.3058618515609669,"handLRX":0,"handLRY":1.9499999999999995,"handLRZ":0.44999999999999996};

HAND_OVERRIDES["Scap_Depression_Adduction:high"] = {"handRX":0.35000000000000003,"handRY":-4.0675115277035765,"handRZ":-1.7366544106717154,"handRRX":0.15,"handRRY":2.0999999999999996,"handRRZ":0,"handLX":4.465554477266186,"handLY":-4.50586857847631,"handLZ":-0.30159938606613457,"handLRX":0.0035720322085804335,"handLRY":-3.3031450874162585,"handLRZ":0.4486656021362936};
HAND_OVERRIDES["Rhomboids:high"] = {"handRX":0.5190131130197497,"handRY":-3.9340075365206717,"handRZ":-1.9922118873148675,"handRRX":0,"handRRY":2.0999999999999996,"handRRZ":-0.15,"handLX":1.4850027706553315,"handLY":-3.7100347664462756,"handLZ":-1.09475356699199,"handLRX":-0.75,"handLRY":-2.8499999999999996,"handLRZ":-0.6};
HAND_OVERRIDES["Latissimus_Dorsi:high"] = {"handRX":-1.7591083525165192,"handRY":-4.86954673124393,"handRZ":-0.266738805716018,"handRRX":0,"handRRY":2.0999999999999996,"handRRZ":-0.15,"handLX":0.15,"handLY":-3.976074862089879,"handLZ":-0.8282353374471345,"handLRX":-1.7999999999999996,"handLRY":3.7499999999999987,"handLRZ":-0.6000000000000002};
  
HAND_OVERRIDES["Anterior_Deltoid:high"] = {"handRX":-4.092514253841237,"handRY":-1.6511624721219198,"handRZ":-1.8628712151296891,"handRRX":0,"handRRY":0.6,"handRRZ":0,"handLX":-4.360517805926354,"handLY":-1.989816350340847,"handLZ":0.4827111158866561,"handLRX":-0.15,"handLRY":1.4999999999999998,"handLRZ":0.6};
HAND_OVERRIDES["Posterior_Deltoid:high"] = {"handRX":0.4600801398396655,"handRY":-4.0020186162517914,"handRZ":-1.8429242361498783,"handRRX":0,"handRRY":1.9499999999999995,"handRRZ":0.15,"handLX":1.1385832461237204,"handLY":-4.2544627806031245,"handLZ":-0.49230648481587896,"handLRX":0,"handLRY":3.149999999999999,"handLRZ":0.44999999999999996};
HAND_OVERRIDES["Middle_Deltoid:high"] = {"handRX":-3.966793959670711,"handRY":-1.718937103886422,"handRZ":-1.645414325328554,"handRRX":0,"handRRY":0.3,"handRRZ":-0.3,"handLX":-5.351985832068992,"handLY":-2.1811405583496883,"handLZ":-1.1738530530855538,"handLRX":0,"handLRY":0.15,"handLRZ":0.44999999999999996};
HAND_OVERRIDES["Shoulder_Horiz_Abd:high"] = {"handRX":0.4415814299580666,"handRY":-3.8951729282914886,"handRZ":-2.085235498585376,"handRRX":0,"handRRY":1.9499999999999995,"handRRZ":0,"handLX":1.3643662504272245,"handLY":-4.289365848939238,"handLZ":-0.3740318249127394,"handLRX":0.15,"handLRY":1.7999999999999998,"handLRZ":0.3};
HAND_OVERRIDES["Shoulder_Horiz_Add:high"] = {"handRX":1.9144683161404066,"handRY":-4.261779907331425,"handRZ":-3.7291770262159663,"handRRX":-0.15,"handRRY":-0.9,"handRRZ":-0.14999999999999994,"handLX":1.7511933737591898,"handLY":-3.4779433534087376,"handLZ":-4.398823682140143,"handLRX":-0.15,"handLRY":-1.3499999999999999,"handLRZ":-0.9};
HAND_OVERRIDES["Infraspinatus:high"] = {"handRX":-4.470454474920205,"handRY":-3.7466506449009866,"handRZ":0.04621958045922736,"handRRX":0,"handRRY":-2.999999999999999,"handRRZ":-2.0999999999999996,"handLX":-4.021498294246471,"handLY":-3.9106200538376115,"handLZ":0.15000000000000005,"handLRX":0,"handLRY":0.75,"handLRZ":1.6499999999999997};  
HAND_OVERRIDES["Subscapularis:high"] = {"handRX":-4.5106049024023775,"handRY":-3.9325141234075627,"handRZ":-0.18394014458030156,"handRRX":0.3,"handRRY":-3.149999999999999,"handRRZ":-2.5499999999999994,"handLX":-4.3143112102062355,"handLY":-4.021768724531525,"handLZ":0.3505413137087234,"handLRX":2.2499999999999996,"handLRY":-3.1499999999999995,"handLRZ":1.3499999999999999};

HAND_OVERRIDES["Biceps_Brachii:high"] = {"handRX":-0.08868832034615463,"handRY":-2.1750377032282726,"handRZ":0.32703605585309936,"handRRX":0,"handRRY":5.250000000000002,"handRRZ":-0.15,"handLX":-1.7711251666750605,"handLY":-2.1587728179382797,"handLZ":-2.06089845048844,"handLRX":2.5415926535897935,"handLRY":-2.2425831658915896,"handLRZ":2.6915926535897934};
HAND_OVERRIDES["Brachialis:high"] = {"handRX":-2.0886883203461557,"handRY":-1.6750377032282728,"handRZ":-0.8229639441469009,"handRRX":0,"handRRY":3.449999999999999,"handRRZ":0,"handLX":-0.6211251666750596,"handLY":-3.158772817938276,"handLZ":-0.6608984504884389,"handLRX":2.991592653589793,"handLRY":-1.7925831658915896,"handLRZ":3.291592653589793};
HAND_OVERRIDES["Brachioradialis:high"] = {"handRX":-2.038688320346156,"handRY":-2.075037703228273,"handRZ":-0.7729639441469008,"handRRX":0.6,"handRRY":3.449999999999999,"handRRZ":0,"handLX":-0.4211251666750595,"handLY":-3.0087728179382767,"handLZ":0.03910154951156128,"handLRX":2.991592653589793,"handLRY":-1.7925831658915896,"handLRZ":3.441592653589793};
HAND_OVERRIDES["Triceps_Brachii:high"] = {"handRX":0.8251259870240402,"handRY":-4.9988265907475755,"handRZ":-1.4921180269685714,"handRRX":0.15000000000000005,"handRRY":1.9499999999999997,"handRRZ":2.6999999999999997,"handLX":0.5081854201466252,"handLY":-4.487076828945899,"handLZ":1.2324362448777697,"handLRX":-0.6,"handLRY":1.9499999999999995,"handLRZ":0.75};

HAND_OVERRIDES["ECRL:high"] = {"handRX":1.1663705726272138,"handRY":-3.376278174093446,"handRZ":-9.14447782869151,"handRRX":-3.299999999999999,"handRRY":-0.3,"handRRZ":1.6653345369377348e-16,"handLX":1.514316618272456,"handLY":-3.284877427166206,"handLZ":-9.932397122089952,"handLRX":-0.15,"handLRY":-1.2,"handLRZ":1.6499999999999997};  
HAND_OVERRIDES["ECRB:high"] = {"handRX":0.79477037979376,"handRY":-3.528981758596401,"handRZ":-9.721829477542716,"handRRX":-0.15,"handRRY":-2.6999999999999993,"handRRZ":2.999999999999999,"handLX":1.3546100296704024,"handLY":-3.4174082694576366,"handLZ":-9.848449053527343,"handLRX":-0.15,"handLRY":-2.2499999999999996,"handLRZ":1.4999999999999998};
HAND_OVERRIDES["ECU:high"] = {"handRX":0.5321217929483433,"handRY":-3.455030783598274,"handRZ":-9.873827616950102,"handRRX":-0.15,"handRRY":-3.299999999999999,"handRRZ":2.3999999999999995,"handLX":-0.6102419067828225,"handLY":-2.778748113372595,"handLZ":-10.250010469265842,"handLRX":0.29999999999999993,"handLRY":-4.5,"handLRZ":-1.7999999999999998};
HAND_OVERRIDES["FCR:high"] = {"handRX":0.55,"handRY":-3.259541602190672,"handRZ":-9.89638627408414,"handRRX":-0.3,"handRRY":-2.849999999999999,"handRRZ":2.3999999999999995,"handLX":-0.9000000000000004,"handLY":-2.3124502200164567,"handLZ":-10.27369333347275,"handLRX":-0.44999999999999996,"handLRY":1.7999999999999996,"handLRZ":-1.05};  
HAND_OVERRIDES["FCU:high"] = {"handRX":0.44291869119899585,"handRY":-3.290188954308885,"handRZ":-9.638541131892374,"handRRX":-0.3,"handRRY":-2.999999999999999,"handRRZ":-3.299999999999999,"handLX":1.2370525369535177,"handLY":-3.4701284811140414,"handLZ":-10.10791498024637,"handLRX":-0.15,"handLRY":-1.9499999999999995,"handLRZ":1.7999999999999996};  

HAND_OVERRIDES["Trunk_Flexion:5"] = {"handRX":-5.605231142036321,"handRY":-4.39951378007929,"handRZ":-0.7850697341357136,"handRRX":0.3,"handRRY":1.9499999999999995,"handRRZ":-0.3,"handLX":-5.174812637640705,"handLY":-4.667196098895683,"handLZ":0.3519477070174101,"handLRX":0.7125619212408653,"handLRY":1.7999999999999998,"handLRZ":-0.15};
HAND_OVERRIDES["Trunk_Flexion:4"] = {"handRX":-5.605231142036321,"handRY":-4.34951378007929,"handRZ":-1.185069734135714,"handRRX":0.3,"handRRY":1.9499999999999995,"handRRZ":-0.15,"handLX":-5.174812637640705,"handLY":-4.517196098895684,"handLZ":0.8019477070174104,"handLRX":0.7125619212408653,"handLRY":1.7999999999999998,"handLRZ":-0.44999999999999996};
HAND_OVERRIDES["Trunk_Flexion:3"] = {"handRX":-5.605231142036321,"handRY":-4.39951378007929,"handRZ":-1.4850697341357142,"handRRX":0.3,"handRRY":1.9499999999999995,"handRRZ":-0.15,"handLX":-4.974812637640706,"handLY":-4.567196098895684,"handLZ":1.0019477070174105,"handLRX":0.7125619212408653,"handLRY":1.7999999999999998,"handLRZ":-0.44999999999999996};
HAND_OVERRIDES["Pelvic_Elevation:high"] = {"handRX":-7.4378397521532085,"handRY":-4.926473470143576,"handRZ":0.13170358546132574,"handRRX":0,"handRRY":1.9499999999999995,"handRRZ":-0.29999999999999993,"handLX":-5.373692924476749,"handLY":-4.094147101915407,"handLZ":1.5688246046307086,"handLRX":-5.551115123125783e-17,"handLRY":2.999999999999999,"handLRZ":1.65};



HAND_OVERRIDES["Iliopsoas:high"] = {"handRX":-3.9326457881186947,"handRY":-4.1120690945840135,"handRZ":-0.319781569667101,"handRRX":-0.15,"handRRY":3.299999999999999,"handRRZ":-1.4999999999999998,"handLX":-3.7146681421870085,"handLY":-3.99917002310452,"handLZ":1.2852027502783014,"handLRX":0,"handLRY":1.3499999999999999,"handLRZ":0.44999999999999996};
HAND_OVERRIDES["Glute_Max:high"] = {"handRX":-1.0492222906032285,"handRY":-3.9317900987551058,"handRZ":-3.225569559919459,"handRRX":0,"handRRY":-6.0000000000000036,"handRRZ":-0.75,"handLX":-6.089944693036415,"handLY":-3.7373442625414395,"handLZ":-2.0646569233162997,"handLRX":0,"handLRY":0.3,"handLRZ":0.44999999999999996};  
HAND_OVERRIDES["Glute_Med:high"] = {"handRX":-1.6726498073371963,"handRY":-3.377301120901819,"handRZ":-2.7303176180984496,"handRRX":-0.15,"handRRY":0.44999999999999996,"handRRZ":-0.44999999999999996,"handLX":-6.2778825501880675,"handLY":-3.1536944172301142,"handLZ":-0.9383896619605925,"handLRX":-0.15,"handLRY":0.45000000000000007,"handLRZ":0.3};
HAND_OVERRIDES["TFL:high"] = {"handRX":-1.3254930533285494,"handRY":-3.3403787653235426,"handRZ":-2.9197455309539277,"handRRX":0,"handRRY":0.44999999999999996,"handRRZ":-0.44999999999999996,"handLX":-6.283661835211719,"handLY":-3.2391496969507154,"handLZ":-2.2502019398075968,"handLRX":0,"handLRY":0,"handLRZ":0.3};
HAND_OVERRIDES["Hip_Adduction:high"] = {"handRX":-4.148103530494525,"handRY":-4.282399841198724,"handRZ":-1.9206844995740928,"handRRX":-0.44999999999999996,"handRRY":0.15000000000000005,"handRRZ":-3.449999999999999,"handLX":-3.8075810216930064,"handLY":-4.18435356125032,"handLZ":-1.418252684488651,"handLRX":-0.15,"handLRY":0.3,"handLRZ":0.3};
HAND_OVERRIDES["Sartorius:high"] = {"handRX":-3.2160624885614784,"handRY":-4.593381174292344,"handRZ":1.9236190688009658,"handRRX":0,"handRRY":-2.5499999999999994,"handRRZ":-1.7999999999999998,"handLX":-1.648103452212648,"handLY":-6.3772338187004065,"handLZ":1.7116996998255107,"handLRX":-3.449999999999999,"handLRY":-0.29999999999999993,"handLRZ":-1.9499999999999997};
HAND_OVERRIDES["Hip_ER:high"] = {"handRX":-2.9660624885614792,"handRY":-4.7433811742923435,"handRZ":1.9736190688009658,"handRRX":0,"handRRY":-2.5499999999999994,"handRRZ":-1.7999999999999998,"handLX":-1.9981034522126484,"handLY":-6.827233818700405,"handLZ":1.7116996998255107,"handLRX":-3.449999999999999,"handLRY":-0.29999999999999993,"handLRZ":-1.65};  
HAND_OVERRIDES["Hip_IR:high"] = {"handRX":-2.526837780699485,"handRY":-4.7423509361573375,"handRZ":1.795210648494676,"handRRX":0,"handRRY":-3.149999999999999,"handRRZ":1.3499999999999999,"handLX":-3.441123996720976,"handLY":-6.192053951166784,"handLZ":1.9694116858777588,"handLRX":0,"handLRY":3.449999999999999,"handLRZ":-0.9};
    
HAND_OVERRIDES["Hamstrings:high"] = {"handRX":-3.1010985249645246,"handRY":-4.163765553612232,"handRZ":-2.599523086792104,"handRRX":0,"handRRY":0,"handRRZ":0,"handLX":-5.380289332204698,"handLY":-2.986593834775415,"handLZ":-2.2343355444830006,"handLRX":0,"handLRY":0,"handLRZ":-0.29999999999999993};
HAND_OVERRIDES["Quadriceps:high"] = {"handRX":-3.640244206896882,"handRY":-5.820891199594678,"handRZ":1.7860142361484386,"handRRX":0,"handRRY":2.0999999999999996,"handRRZ":-2.6999999999999993,"handLX":-3.0692490546984215,"handLY":-6.217347412120756,"handLZ":3.0340909282674016,"handLRX":0.15,"handLRY":-4.35,"handLRZ":0.9};

HAND_OVERRIDES["Tibialis_Anterior:high"] = {"handRX":-5.80748270112216,"handRY":-4.9185035044051375,"handRZ":-2.314467880863499,"handRRX":0,"handRRY":0,"handRRZ":2.849999999999999,"handLX":-7.106383225558583,"handLY":-4.362209276108732,"handLZ":-1.1489726589619134,"handLRX":1.9499999999999997,"handLRY":1.65,"handLRZ":5.551115123125783e-17};
HAND_OVERRIDES["Foot_Eversion_PF:high"] = {"handRX":-3.8931711219329053,"handRY":-6.995069099600694,"handRZ":0.9866197339591727,"handRRX":0,"handRRY":-4.5,"handRRZ":-1.7999999999999996,"handLX":-3.453896107733282,"handLY":-7.393379859383754,"handLZ":2.129612311046955,"handLRX":0.15,"handLRY":-3.299999999999999,"handLRZ":-1.2};




/* ==== HAND OVERRIDES (LOW) ==== */

HAND_OVERRIDES["Capital_Extension:low"] = {"handRX":3.299999999999998,"handRY":-4.849999999999992,"handRZ":-3.7499999999999947,"handRRX":4.65,"handRRY":-1.4999999999999998,"handRRZ":0.7500000000000002,"handLX":3.399999999999996,"handLY":-4.749999999999992,"handLZ":-2.9499999999999975,"handLRX":5.551115123125783e-17,"handLRY":-1.2,"handLRZ":3.449999999999999};
HAND_OVERRIDES["Cervical_Extension:low"] = {"handRX":3.299999999999998,"handRY":-4.8999999999999915,"handRZ":-3.7999999999999945,"handRRX":4.65,"handRRY":-1.4999999999999998,"handRRZ":0.30000000000000016,"handLX":3.399999999999996,"handLY":-4.749999999999992,"handLZ":-2.7499999999999982,"handLRX":5.551115123125783e-17,"handLRY":-1.2,"handLRZ":3.449999999999999};
HAND_OVERRIDES["Capital_Flexion:low"] = {"handRX":2.4366607096519464,"handRY":-5.134163299337729,"handRZ":-2.378371050121847,"handRRX":-2.0000166592430553,"handRRY":-0.7510895572089885,"handRRZ":-2.5574762811691976,"handLX":1.0596022397803093,"handLY":-4.8822640230731045,"handLZ":-4.135524403146678,"handLRX":-0.3,"handLRY":0.15,"handLRZ":0.15};
HAND_OVERRIDES["Cervical_Flexion:low"] = {"handRX":2.3984328107860895,"handRY":-4.506607836412489,"handRZ":-1.814492408165255,"handRRX":3.149999999999999,"handRRY":-0.6,"handRRZ":2.6999999999999993,"handLX":1.1220504874828894,"handLY":-4.865783890408162,"handLZ":-4.19722912343906,"handLRX":-0.15,"handLRY":0.15000000000000005,"handLRZ":0.45000000000000007};
HAND_OVERRIDES["Single_SCM:low"] = {"handRX":2.29843281078609,"handRY":-4.506607836412489,"handRZ":-1.7644924081652549,"handRRX":3.149999999999999,"handRRY":-0.6,"handRRZ":2.6999999999999993,"handLX":1.1220504874828894,"handLY":-4.865783890408162,"handLZ":-4.19722912343906,"handLRX":-0.15,"handLRY":0.15000000000000005,"handLRZ":0.45000000000000007};
HAND_OVERRIDES["Cervical_Rotation:low"] = {"handRX":2.002046370115527,"handRY":-2.8738991654704167,"handRZ":-11.248623580618029,"handRRX":0.3,"handRRY":3.149999999999999,"handRRZ":-1.6499999999999997,"handLX":2.8066499482026206,"handLY":-3.1803327115407654,"handLZ":-11.747197366311715,"handLRX":0.3,"handLRY":-2.6999999999999993,"handLRZ":1.9499999999999997};  



HAND_OVERRIDES["Serratus_Anterior:low"] = {"handRX":-4.442741543517701,"handRY":-2.742981837727001,"handRZ":-1.2588276110193035,"handRRX":5.551115123125783e-17,"handRRY":1.7999999999999998,"handRRZ":-1.9499999999999997,"handLX":-3.308416811942803,"handLY":-2.494630337483539,"handLZ":-0.5084034324396827,"handLRX":2.999999999999999,"handLRY":-3.299999999999999,"handLRZ":-5.551115123125783e-17};
HAND_OVERRIDES["Upper_Trapezius:low"] = {"handRX":1.9708211164829013,"handRY":-4.876815300539837,"handRZ":-1.3837057659236518,"handRRX":-0.04295139535482312,"handRRY":-2.7579193214451228,"handRRZ":2.7906739231324473,"handLX":0.8240210794554774,"handLY":-4.269945800178527,"handLZ":-1.6170846832367625,"handLRX":-2.3683220783617727,"handLRY":1.4973266743677451,"handLRZ":2.7799277106967977};
HAND_OVERRIDES["Middle_Trapezius:low"] = {"handRX":0.6569781232474105,"handRY":-3.716058866904209,"handRZ":-2.171639422761188,"handRRX":-0.8306554581133849,"handRRY":1.869369644005189,"handRRZ":0.8457931712498113,"handLX":0.7195068194254799,"handLY":-4.722605334381741,"handLZ":-1.0058618515609672,"handLRX":0,"handLRY":2.5499999999999994,"handLRZ":3.449999999999999};
HAND_OVERRIDES["Scap_Depression_Adduction:low"] = {"handRX":0.06454052664986801,"handRY":-3.381579844085022,"handRZ":-2.3069913790059347,"handRRX":-1.2,"handRRY":2.0999999999999996,"handRRZ":1.05,"handLX":2.4333099522981714,"handLY":-4.436815923742565,"handLZ":-1.0134266287729252,"handLRX":2.8469480519674075,"handLRY":0.22105824305211855,"handLRZ":0.21102025993511156};
HAND_OVERRIDES["Rhomboids:low"] = {"handRX":-3.6023770852164954,"handRY":-3.2386684815652185,"handRZ":-1.9587260081535944,"handRRX":-1.2,"handRRY":0.14999999999999994,"handRRZ":0,"handLX":-4.84567700334918,"handLY":-4.381078640751628,"handLZ":-1.2021177931198224,"handLRX":-0.3,"handLRY":1.7999999999999996,"handLRZ":2.3999999999999995};
HAND_OVERRIDES["Latissimus_Dorsi:low"] = {"handRX":-1.7591083525165192,"handRY":-4.86954673124393,"handRZ":-0.266738805716018,"handRRX":0,"handRRY":2.0999999999999996,"handRRZ":-0.15,"handLX":0.15,"handLY":-3.976074862089879,"handLZ":-0.8282353374471345,"handLRX":-1.7999999999999996,"handLRY":3.7499999999999987,"handLRZ":-0.6000000000000002};


HAND_OVERRIDES["Anterior_Deltoid:low"] = {"handRX":0.5650361344439265,"handRY":-3.080047551962139,"handRZ":-4.452592661783596,"handRRX":0.019930295736958842,"handRRY":0.1768981698877853,"handRRZ":-0.4301825711311744,"handLX":-0.45,"handLY":-3.445953618084854,"handLZ":-1.8525973585573878,"handLRX":-0.14999999999999994,"handLRY":0.9,"handLRZ":2.999999999999999};
HAND_OVERRIDES["Posterior_Deltoid:low"] = {"handRX":-0.9016173379269942,"handRY":-4.806913504250971,"handRZ":-0.8192096230234354,"handRRX":0,"handRRY":2.0999999999999996,"handRRZ":0,"handLX":0.31444638178201334,"handLY":-3.4612943930868694,"handLZ":-1.73843170702607,"handLRX":1.6499999999999997,"handLRY":0.30000000000000004,"handLRZ":-0.15};
HAND_OVERRIDES["Middle_Deltoid:low"] = {"handRX":1.7063356898073319,"handRY":-4.3758650240038515,"handRZ":-2.7882746787425146,"handRRX":0.44999999999999996,"handRRY":0.14999999999999994,"handRRZ":-1.7999999999999996,"handLX":0.11633676165882888,"handLY":-4.943397087868817,"handLZ":-4.411515368683856,"handLRX":0,"handLRY":0.75,"handLRZ":0.15};
HAND_OVERRIDES["Shoulder_Horiz_Abd:low"] = {"handRX":0.1716757590716973,"handRY":-3.1364488103785177,"handRZ":-12.232425150871983,"handRRX":0,"handRRY":1.7999999999999996,"handRRZ":-1.2,"handLX":0.2161610648843359,"handLY":-3.2156307658298497,"handLZ":-11.458850833389315,"handLRX":0,"handLRY":1.4999999999999998,"handLRZ":0.75};
HAND_OVERRIDES["Shoulder_Horiz_Add:low"] = {"handRX":0.7759806479105071,"handRY":-2.1477353033497986,"handRZ":-12.255154854118016,"handRRX":1.05,"handRRY":0.9,"handRRZ":-0.7500000000000001,"handLX":-0.4567760511375165,"handLY":-3.699138188554135,"handLZ":-12.378916419551507,"handLRX":0,"handLRY":0,"handLRZ":0};
HAND_OVERRIDES["Infraspinatus:low"] = {"handRX":-0.01812734836181096,"handRY":-3.731643870234003,"handRZ":-9.948589511522322,"handRRX":0.028233992825408213,"handRRY":1.1957458645768284,"handRRZ":3.112888537145199,"handLX":1.4146650920195978,"handLY":-2.6340093078630287,"handLZ":-12.217605388207359,"handLRX":-0.15,"handLRY":1.9499999999999997,"handLRZ":-1.05};
HAND_OVERRIDES["Subscapularis:low"] = {"handRX":-0.4396874676044647,"handRY":-3.854840181407612,"handRZ":-9.416347791694879,"handRRX":0.15000000000000005,"handRRY":1.7999999999999996,"handRRZ":2.6999999999999993,"handLX":0.5038858353394162,"handLY":-2.821339993415119,"handLZ":-11.348203292508586,"handLRX":1.6499999999999997,"handLRY":0.75,"handLRZ":-0.15000000000000005};
HAND_OVERRIDES["Trunk_Ext_Lumbar:high"] = {"handRX":-5.362418451627426,"handRY":-4.110060467356634,"handRZ":-0.9492513020507023,"handRRX":0.15,"handRRY":1.9499999999999995,"handRRZ":-0.3,"handLX":-4.9455104894906645,"handLY":-4.391506861301159,"handLZ":0.3808244536019736,"handLRX":0.75,"handLRY":1.7999999999999998,"handLRZ":-0.44999999999999996};

HAND_OVERRIDES["Biceps_Brachii:low"] = {"handRX":-0.29681889578849613,"handRY":-2.575690888410152,"handRZ":0.7960566646815974,"handRRX":-0.47237161106042536,"handRRY":-1.6815108001573373,"handRRZ":-3.291592653589793,"handLX":-0.9669968569504992,"handLY":-2.367480151667746,"handLZ":-1.1134438941818656,"handLRX":0.3,"handLRY":-0.75,"handLRZ":0.6};
HAND_OVERRIDES["Brachialis:low"] = {"handRX":-0.29681889578849613,"handRY":-2.575690888410152,"handRZ":0.7960566646815974,"handRRX":-0.47237161106042536,"handRRY":-1.6815108001573373,"handRRZ":-3.291592653589793,"handLX":-0.9669968569504992,"handLY":-2.367480151667746,"handLZ":-1.1134438941818656,"handLRX":0.3,"handLRY":-0.75,"handLRZ":0.6};
HAND_OVERRIDES["Brachioradialis:low"] = {"handRX":-0.29681889578849613,"handRY":-2.575690888410152,"handRZ":0.7960566646815974,"handRRX":-0.47237161106042536,"handRRY":-1.6815108001573373,"handRRZ":-3.291592653589793,"handLX":-0.9669968569504992,"handLY":-2.367480151667746,"handLZ":-1.1134438941818656,"handLRX":0.3,"handLRY":-0.75,"handLRZ":0.6};
HAND_OVERRIDES["Triceps_Brachii:low"] = {"handRX":-4.603352626304395,"handRY":-3.2803356480409347,"handRZ":0.8504981738185555,"handRRX":0,"handRRY":1.9499999999999995,"handRRZ":2.5499999999999994,"handLX":-2.80041863658089,"handLY":-3.2536092259953198,"handLZ":1.2487596402697552,"handLRX":-2.9711837855575562,"handLRY":-0.5981100545064092,"handLRZ":-0.7913700045679833};



HAND_OVERRIDES["ECRL:low"] = {"handRX":0.25000000000000006,"handRY":-3.5082026751821855,"handRZ":-8.163503828048702,"handRRX":0,"handRRY":-2.5499999999999994,"handRRZ":0,"handLX":0.666312323955425,"handLY":-4.055123396276782,"handLZ":-8.833503595568864,"handLRX":0.29999999999999993,"handLRY":-2.6999999999999993,"handLRZ":2.999999999999999};
HAND_OVERRIDES["ECRB:low"] = {"handRX":0.6500000000000001,"handRY":-3.358202675182186,"handRZ":-8.663503828048709,"handRRX":0.14999999999999994,"handRRY":-3.4499999999999993,"handRRZ":0.15000000000000005,"handLX":2.066312323955426,"handLY":-3.005123396276786,"handLZ":-10.433503595568887,"handLRX":0.75,"handLRY":-1.0500000000000003,"handLRZ":0.9000000000000002}; 
HAND_OVERRIDES["ECU:low"] = {"handRX":1.0000000000000004,"handRY":-3.5582026751821854,"handRZ":-8.863503828048712,"handRRX":-5.551115123125783e-17,"handRRY":-3.4499999999999993,"handRRZ":-3.299999999999999,"handLX":1.6663123239554258,"handLY":-2.8551233962767864,"handLZ":-10.283503595568884,"handLRX":-2.0999999999999996,"handLRY":-2.3999999999999995,"handLRZ":-1.6499999999999995};
HAND_OVERRIDES["FCR:low"] = {"handRX":-0.29999999999999993,"handRY":-2.7082026751821884,"handRZ":-10.313503828048733,"handRRX":-1.2,"handRRY":-3.899999999999999,"handRRZ":1.4999999999999998,"handLX":0.36631232395542485,"handLY":-4.055123396276782,"handLZ":-9.683503595568876,"handLRX":0.29999999999999993,"handLRY":-2.6999999999999993,"handLRZ":2.999999999999999};
HAND_OVERRIDES["FCU:low"] = {"handRX":0.6500000000000001,"handRY":-3.708202675182185,"handRZ":-8.0635038280487,"handRRX":0,"handRRY":-2.5499999999999994,"handRRZ":-0.3,"handLX":1.0663123239554253,"handLY":-3.755123396276783,"handLZ":-8.783503595568863,"handLRX":0.14999999999999994,"handLRY":-2.2499999999999996,"handLRZ":3.299999999999999};

HAND_OVERRIDES["Iliopsoas:low"] = {"handRX":-1.6639083975976532,"handRY":-3.3296824229047326,"handRZ":-3.0026486469332454,"handRRX":0,"handRRY":0.44999999999999996,"handRRZ":-0.6,"handLX":-4.150025037893101,"handLY":-3.9603333678452923,"handLZ":-1.857765860397618,"handLRX":-0.15,"handLRY":0.9000000000000001,"handLRZ":-3.149999999999999};
HAND_OVERRIDES["Glute_Max:low"] = {"handRX":-1.6639083975976532,"handRY":-3.3296824229047326,"handRZ":-3.0026486469332454,"handRRX":0,"handRRY":0.44999999999999996,"handRRZ":-0.6,"handLX":-4.150025037893101,"handLY":-3.9603333678452923,"handLZ":-1.857765860397618,"handLRX":-0.15,"handLRY":0.9000000000000001,"handLRZ":-3.149999999999999};
HAND_OVERRIDES["Sartorius:low"] = {"handRX":-1.7161720071623678,"handRY":-2.9725601456958533,"handRZ":-1.6364512897442651,"handRRX":1.4999999999999998,"handRRY":0,"handRRZ":-1.05,"handLX":-3.863585771800382,"handLY":-4.468999765760067,"handLZ":-1.0965559215572183,"handLRX":-0.3,"handLRY":-0.6,"handLRZ":1.4999999999999998};
HAND_OVERRIDES["Glute_Med:low"] = {"handRX":-0.6411201836540872,"handRY":-3.5962378764705853,"handRZ":-1.155600389239867,"handRRX":1.3499999999999999,"handRRY":-0.15,"handRRZ":-6.931183524774663,"handLX":-5.03853285348598,"handLY":-4.7359770929996765,"handLZ":-0.879542803110188,"handLRX":0.30000000000000004,"handLRY":0.15000000000000005,"handLRZ":2.849999999999999};
HAND_OVERRIDES["TFL:low"] = {"handRX":-0.6411201836540872,"handRY":-3.5962378764705853,"handRZ":-1.0056003892398668,"handRRX":1.3499999999999999,"handRRY":-0.15,"handRRZ":-6.931183524774663,"handLX":-4.338532853485982,"handLY":-4.685977092999677,"handLZ":-1.3295428031101884,"handLRX":0.30000000000000004,"handLRY":0.15000000000000005,"handLRZ":3.149999999999999};
HAND_OVERRIDES["Hip_Adduction:low"] = {"handRX":-4.8180373611547465,"handRY":-4.891805628543024,"handRZ":1.4641438441215937,"handRRX":0,"handRRY":-2.849999999999999,"handRRZ":2.6999999999999993,"handLX":-1.127044661660324,"handLY":-3.3791653096094683,"handLZ":-1.1477030391856957,"handLRX":-1.2,"handLRY":-2.849999999999999,"handLRZ":-0.3};
HAND_OVERRIDES["Hip_ER:low"] = {"handRX":-2.7364576761800743,"handRY":-4.1318675457239085,"handRZ":0.431431193240336,"handRRX":0,"handRRY":-2.5499999999999994,"handRRZ":-0.44999999999999996,"handLX":-0.811840826440819,"handLY":-4.138509381081345,"handLZ":-0.3111404160116942,"handLRX":-0.15,"handLRY":-2.849999999999999,"handLRZ":0.44999999999999996};
HAND_OVERRIDES["Hip_IR:low"] = {"handRX":-2.7364576761800743,"handRY":-4.1318675457239085,"handRZ":0.431431193240336,"handRRX":0,"handRRY":-2.5499999999999994,"handRRZ":-0.44999999999999996,"handLX":-0.811840826440819,"handLY":-4.138509381081345,"handLZ":-0.3111404160116942,"handLRX":-0.15,"handLRY":-2.849999999999999,"handLRZ":0.44999999999999996};

HAND_OVERRIDES["Hamstrings:low"] = {"handRX":-4.368494301588642,"handRY":-3.87614344486967,"handRZ":-2.0033459151914887,"handRRX":0,"handRRY":0.44999999999999996,"handRRZ":3.149999999999999,"handLX":-6.1000250378930945,"handLY":-3.5603333678452938,"handLZ":-1.5577658603976177,"handLRX":-0.15,"handLRY":0.9000000000000001,"handLRZ":-2.999999999999999};
HAND_OVERRIDES["Quadriceps:low"] = {"handRX":-4.368494301588642,"handRY":-3.87614344486967,"handRZ":-2.0033459151914887,"handRRX":0,"handRRY":0.44999999999999996,"handRRZ":3.149999999999999,"handLX":-6.1000250378930945,"handLY":-3.5603333678452938,"handLZ":-1.5577658603976177,"handLRX":-0.15,"handLRY":0.9000000000000001,"handLRZ":-2.999999999999999};

HAND_OVERRIDES["Tibialis_Anterior:low"] = {"handRX":-7.916434000474641,"handRY":-4.89174479853295,"handRZ":-1.0843586273392363,"handRRX":0,"handRRY":1.9499999999999995,"handRRZ":-0.44999999999999996,"handLX":-6.180843015670757,"handLY":-4.224920800452511,"handLZ":-0.19552834033567573,"handLRX":-0.45000000000000007,"handLRY":2.999999999999999,"handLRZ":1.6499999999999997};
HAND_OVERRIDES["Foot_Eversion_PF:low"] = {"handRX":-2.3196741521660846,"handRY":-6.553034852376887,"handRZ":1.2998736885076692,"handRRX":0.15,"handRRY":4.199999999999999,"handRRZ":1.35,"handLX":-3.6257738559156634,"handLY":-6.926965807291814,"handLZ":2.0111094374464358,"handLRX":-0.15,"handLRY":-3.5999999999999988,"handLRZ":-1.3499999999999999};


HAND_OVERRIDES["Trunk_Ext_Lumbar:3"] = {"handRX":-1.9535937808442878,"handRY":-3.9919771595448763,"handRZ":-2.719467147555349,"handRRX":0,"handRRY":-4.35,"handRRZ":0,"handLX":-1.4043775968448482,"handLY":-4.09095561678439,"handLZ":-0.36773242463454764,"handLRX":0,"handLRY":1.7999999999999996,"handLRZ":0};
HAND_OVERRIDES["Trunk_Ext_Thoracic:3"] = {"handRX":-1.9535937808442878,"handRY":-3.9919771595448763,"handRZ":-2.719467147555349,"handRRX":0,"handRRY":-4.35,"handRRZ":0,"handLX":-1.4043775968448482,"handLY":-4.09095561678439,"handLZ":-0.36773242463454764,"handLRX":0,"handLRY":1.7999999999999996,"handLRZ":0};

HAND_OVERRIDES["Trunk_Ext_Lumbar:low"] = {"handRX":0.08902575550777321,"handRY":-4.126431649435403,"handRZ":-3.7265573964911587,"handRRX":5.551115123125783e-17,"handRRY":-0.15,"handRRZ":0,"handLX":-5.8388852213570015,"handLY":-4.586415477600457,"handLZ":-2.220092412206168,"handLRX":0,"handLRY":0,"handLRZ":0.75};
HAND_OVERRIDES["Trunk_Ext_Thoracic:low"] = {"handRX":0.08902575550777321,"handRY":-4.126431649435403,"handRZ":-3.7265573964911587,"handRRX":5.551115123125783e-17,"handRRY":-0.15,"handRRZ":0,"handLX":-5.8388852213570015,"handLY":-4.586415477600457,"handLZ":-2.220092412206168,"handLRX":0,"handLRY":0,"handLRZ":0.75};

HAND_OVERRIDES["Trunk_Flexion:low"] = {"handRX":-0.2143785102517738,"handRY":-4.055789024306608,"handRZ":-3.5988138218117696,"handRRX":-0.15,"handRRY":0,"handRRZ":0.15,"handLX":-1.3921394061553993,"handLY":-4.030925433479073,"handLZ":-3.2216262925762704,"handLRX":0,"handLRY":0.3,"handLRZ":0};
HAND_OVERRIDES["Trunk_Rotation:low"] = {"handRX":-0.2143785102517738,"handRY":-4.205789024306608,"handRZ":-3.8488138218117687,"handRRX":-0.15,"handRRY":0,"handRRZ":0.15,"handLX":-1.4421394061553994,"handLY":-4.180925433479072,"handLZ":-3.571626292576269,"handLRX":0,"handLRY":0.3,"handLRZ":0};

HAND_OVERRIDES["Gastrocnemius:low"] = {"handRX":-7.383531337446211,"handRY":-4.9571504628478875,"handRZ":-1.914358515475385,"handRRX":0,"handRRY":0,"handRRZ":-3.149999999999999,"handLX":-7.696797628914324,"handLY":-4.40347524441583,"handLZ":-0.5236859195819348,"handLRX":0,"handLRY":-2.5499999999999994,"handLRZ":-0.9};
HAND_OVERRIDES["Pelvic_Elevation:low"] = {"handRX":-5.754853619553073,"handRY":-4.869965010398946,"handRZ":0.19121767004347306,"handRRX":0.16036124900513804,"handRRY":0.6486223722730297,"handRRZ":2.722603345284929,"handLX":-3.8466801029216757,"handLY":-4.378620145682152,"handLZ":0.05058341200305572,"handLRX":0.7725490400070075,"handLRY":1.2814460881553456,"handLRZ":-0.03667068234389319};



/* ==== NEUTRAL HAND POSITION (New Default) ==== */
const HAND_NEUTRAL_POSE = {
    // Widened X separation (0.45 vs -0.45) for side-by-side viewing
    // Slight Z offset to keep them from overlapping in depth
    handRX: 0.45, handRY: 1.25, handRZ: 0.45,¬†
    handRRX: 0, handRRY: 0, handRRZ: 0,¬† ¬†
    handLX: -0.45, handLY: 1.25, handLZ: 0.55,¬† 
    handLRX: 0, handLRY: 0, handLRZ: 0¬†¬†
};
let CURRENT_BODY_TEST = null;
let CURRENT_BODY_BUCKET = "high"; // "high" or "low"
  
// Decide which pose family to use ("high" = Grades 3‚Äì5 family, "low" = Grades 0‚Äì2 family)
function getGradeBucketForTest(testKey) {
  if (EXCEPTION_TESTS.has(testKey)) {
    if (!gradeExceptions) return "high";
    const g = gradeExceptions.value; // "5", "4", "3", "2", "1"

    // --- Trunk Flexion & Rotation ---
    if (testKey === "Trunk_Flexion" || testKey === "Trunk_Rotation") {
      // If Grade is 2 or 1, return "low" so it reads BONE_OVERRIDES["Trunk_Flexion:low"]
      if (g === "2" || g === "1") return "low";
      // Grades 5, 4, and 3 remain independent numbers
      return g; 
    }

    // --- Trunk Extension: 5 & 4 grouped as "high", 3 Independent, 1-2 Low ---
    if (testKey === "Trunk_Ext_Lumbar" || testKey === "Trunk_Ext_Thoracic") {
      if (g === "5" || g === "4") return "high";
      if (g === "3") return "3";
      return "low";
    }

    // --- Pelvic Elevation & Gastroc: Standard 3-5 high, 0-2 low ---
    return (Number(g) >= 3 ? "high" : "low");
  }

  // Standard Limb Tests
  const gm = Number(gradeMain.value || "3");
  return (gm >= 3 ? "high" : "low");
}

/* ==== MMT Grading Rules Logic ==== */
function shouldResistanceBeDisabled() {
  const testKey = actionSel.value;

  // RULE 1: If no test is selected, resistance is always disabled.
  if (!testKey) return true;

  const isExceptionTest = EXCEPTION_TESTS.has(testKey);

  if (isExceptionTest) {
    // --- A) GRADING EXCEPTIONS MENU (Trunk + Gastroc) ---
    const exceptionGrade = gradeExceptions.value;

    // RULE 2: Disable resistance for Trunk tests (they use body position, not manual resistance)
    if (testKey.startsWith('Trunk')) {
      return true; 
    }

    // RULE 3: Grade 1 or 2 generally disable resistance
    if (exceptionGrade === '1' || exceptionGrade === '2') {
      // EXCEPTION: Grade 2 Plantar Flexion (Gastrocnemius) uses resistance/hold
      if (testKey === 'Gastrocnemius' && exceptionGrade === '2') {
        return false; 
      }
      return true; 
    }
  } else {
    // --- B) MAIN GRADE MENU (All other limb tests) ---
    const mainGradeBucket = gradeMain.value;

    // RULE 4: If 'Grades 0‚Äì2' is selected, disable manual resistance.
    if (mainGradeBucket === '2') {
      return true;
    }
  }

  // Default: Grades 3, 4, 5 (Limb tests) and Grade 2 Gastroc use hold time.
  return false; 
}


/* ========================= BONE TUNER (DEVELOPER TOOL) ========================= */
const RIGGED_BONES = [
  "spine01","spine02","spine03","neck","head",
  "clavicle_L","clavicle_R","upperarm_L","upperarm_R",
  "lowerarm_L","lowerarm_R","hand_L","hand_R",
  "thigh_L","thigh_R","calf_L","calf_R","foot_L","foot_R",
  "toes_L","toes_R",

  // FINGERS ‚Äî LEFT
  "thumb01_L","thumb02_L","thumb03_L",
  "index01_L","index02_L","index03_L",
  "middle01_L","middle02_L","middle03_L",
  "ring01_L","ring02_L","ring03_L",
  "pinky01_L","pinky02_L","pinky03_L",

  // FINGERS ‚Äî RIGHT
  "thumb01_R","thumb02_R","thumb03_R",
  "index01_R","index02_R","index03_R",
  "middle01_R","middle02_R","middle03_R",
  "ring01_R","ring02_R","ring03_R",
  "pinky01_R","pinky02_R","pinky03_R"
];
const MODIFIED_BONES = new Set(); // only bones touched by tuner this session
  
// index (80).html - REPLACEMENT for applyTunerOverrides()
function applyTunerOverrides(testKey, gradeBucket, isResistanceActive = false){
    if (!skeleton) return;
    const key = `${testKey}:${gradeBucket}`;
    
    // 1. Identify if this specific test (e.g., TFL:high) has a custom starting pose.
    const hasStartPose = !!BONE_OVERRIDES_START[key];
    
    let dict = null;
    let poseType = 'Default';

    // A) If a starting pose exists AND resistance is NOT active, use the start pose.
    if (hasStartPose && !isResistanceActive) {
        dict = BONE_OVERRIDES_START[key];
        poseType = 'Start Pose';

    } 
    // B) If a starting pose exists AND resistance IS active, OR if it's any other test, use the regular override.
    // This handles: (TFL switch to end range) AND (All normal tests that have no start pose).
    else if (hasStartPose && isResistanceActive || !hasStartPose) {
        dict = BONE_OVERRIDES[key];
        poseType = 'End Pose/Standard';
    }

    if (!dict) return;

    for (const boneName in dict){
        const bone = getBone(boneName);
        const rot¬† = dict[boneName];
        if (!bone || !rot) continue;

        // Use the stored angles as the FULL local rotation
        const e = new THREE.Euler(
            THREE.MathUtils.degToRad(rot.x || 0),
            THREE.MathUtils.degToRad(rot.y || 0),
            THREE.MathUtils.degToRad(rot.z || 0),
            "XYZ"
        );
        bone.quaternion.setFromEuler(e);¬† ¬† 
    }
    console.log(`‚úÖ Applied Bone Tuner Overrides for ${key} (${poseType}).`);¬†¬†
}


/* === Bone Tuner UI & Logic === */
const boneTunerPanel = document.createElement("div");
boneTunerPanel.id = "boneTuner";
boneTunerPanel.innerHTML = `
  <div class="dragbar">ü¶¥ Bone Tuner <span class="hint">developer</span></div>
  <div class="content">
    <label>Bone</label>
    <select id="boneSel">${RIGGED_BONES.map(b=>`<option value="${b}">${b}</option>`).join("")}</select>
    <label>Rotation (deg)</label>
    <div class="row">
      <button id="xMinus">X‚àí</button><button id="xPlus">X+</button>
      <button id="yMinus">Y‚àí</button><button id="yPlus">Y+</button>
      <button id="zMinus">Z‚àí</button><button id="zPlus">Z+</button>
    </div>
    <button id="saveBoneOverride" class="mini">üíæ Save Override</button>
  </div>`;
boneTunerPanel.className = "panel";
boneTunerPanel.style.left = "430px";
boneTunerPanel.style.top = "12px";
document.body.appendChild(boneTunerPanel);
boneTunerPanel.style.display = 'none'; // <--- Hides the simple bone tuner  (none or block)

function rotateBone(axis, delta){
  const bName = $("boneSel").value;
  const bone = getBone(bName);
  if (!bone) return;

  const r = THREE.MathUtils.degToRad(delta);
  const e = new THREE.Euler();
  e[axis] = r;
  bone.quaternion.multiply(new THREE.Quaternion().setFromEuler(e));

  // mark this bone as explicitly tuned
  MODIFIED_BONES.add(bName);
}


["x","y","z"].forEach(axis => {
  $(axis + "Plus").onclick  = () => rotateBone(axis,  5);
  $(axis + "Minus").onclick = () => rotateBone(axis, -5);
});

$("saveBoneOverride").onclick = () => {
  const testKey = actionSel.value;
  if (!testKey) {
    alert("Select an MMT test first");
    return;
  }

  // Decide high vs low bucket, same logic style as your pose overrides
  const isLowBucket = gradeMain.disabled
    ? ["2", "1", "0"].includes(gradeExceptions.value)
    : (gradeMain.value === "2");
  const gradeBucket = isLowBucket ? "low" : "high";
  const key = `${testKey}:${gradeBucket}`;

  // Build a fresh dictionary from the current tuner state,
  // reading EVERY rigged bone (just like pose saver reads everything at once)
  // Build a dictionary ONLY from bones actually edited with the tuner
  if (MODIFIED_BONES.size === 0) {
    alert("No bones were adjusted with the tuner for this test.");
    return;
  }

  const dict = {};
  MODIFIED_BONES.forEach((boneName) => {
    const bone = getBone(boneName);
    if (!bone) return;

    const e = new THREE.Euler().setFromQuaternion(bone.quaternion, "XYZ");
    const xDeg = THREE.MathUtils.radToDeg(e.x);
    const yDeg = THREE.MathUtils.radToDeg(e.y);
    const zDeg = THREE.MathUtils.radToDeg(e.z);

    dict[boneName] = { x: xDeg, y: yDeg, z: zDeg };
  });

  // Store only tuned bones for this test/bucket
  BONE_OVERRIDES[key] = dict;

  // Reset for the next tuning session
  MODIFIED_BONES.clear();


  // Pretty POSE-style console output
  const parts = Object.keys(dict).sort().map((name) => {
    const r = dict[name];
    return `${name}:{ x:${r.x.toFixed(1)}, y:${r.y.toFixed(1)}, z:${r.z.toFixed(1)} }`;
  });
  console.log(`BONE_OVERRIDES["${key}"] = { ${parts.join(", ")} };`);

  $("msg").textContent = `Saved tuner overrides for ${key}`;
};

 

// Coarse body-mode: align to bed/cabinet but don't set specific joint test angles
function setBodyMode(mode, isResistanceActive = false){ // <-- ADDED isResistanceActive = false
¬† if (!model || !skeleton) return;

¬† // Always start from your standing anatomic baseline
¬† resetAllBones();
  applyAnatomicBaseline();

  // Defaults: your original standing pose in front of bed
  let posX = POSE.x;
  let posY = POSE.y;
  let posZ = POSE.z;
  let rotX = 0;
  let rotY = degToRad(POSE.ryDeg);
  let rotZ = 0;

  if (mode === "seated"){
    // Short sitting at edge of blue table
    const edgeZ = tableTop.position.z + (TABLE_D / 2) - 0.25;
    posX = 0;
    posY = TABLE_HEIGHT + 0.02;
    posZ = edgeZ;
    rotX = 0;
    rotY = degToRad(POSE.ryDeg);
    seatPoseOnlyLegs();

  } else if (mode === "long_sit"){
  // Long sitting at edge of table: hips ~0¬∞, knees ~0¬∞
  const edgeZ = tableTop.position.z + (TABLE_D / 2) - 0.25;
  posX = 0;
  posY = TABLE_HEIGHT + 0.02;
  posZ = edgeZ;
  rotX = 0;
  rotY = degToRad(POSE.ryDeg);

  longSitLegs(); // new helper below

  } else if (mode === "supine"){
    // Supine on bed, centered
    posX = 0;
    posY = TABLE_HEIGHT + TABLE_THICK / 2 + 0.04;
    posZ = tableTop.position.z;
    rotX = Math.PI / 2;
    rotY = degToRad(POSE.ryDeg);

  } else if (mode === "prone"){
    // Prone on bed, centered
    posX = 0;
    posY = TABLE_HEIGHT + TABLE_THICK / 2 + 0.04;
    posZ = tableTop.position.z;
    rotX = Math.PI / 2;
    rotY = degToRad(POSE.ryDeg + 180);
    
  } else if (mode === "gastroc"){
    // Standing by cabinet for heel raises
    const standZ = cabinet.position.z - 0.5;
    posX = cabinet.position.x;
    posY = 0;    // floor
    posZ = standZ;
    rotX = 0;
    rotY = 0;    // face cabinet

  } else {
    // 'anatomic' or unknown ‚Üí your original standing pose
    posX = POSE.x;
    posY = POSE.y;
    posZ = POSE.z;
    rotX = 0;
    rotY = degToRad(POSE.ryDeg);
    rotZ = 0;
  }

// Apply any saved override for this test + family (high/low)
const key = CURRENT_BODY_TEST && CURRENT_BODY_BUCKET
  ? `${CURRENT_BODY_TEST}:${CURRENT_BODY_BUCKET}`
  : null;

if (key && POSE_OVERRIDES[key]){
  const o = POSE_OVERRIDES[key];
  posX = o.x;
  posY = o.y;
  posZ = o.z;
  rotX = o.rx;
  rotY = o.ry;
  rotZ = o.rz;

  // }
}

model.position.set(posX, posY, posZ);
¬† model.rotation.set(rotX, rotY, rotZ);
¬† // NEW: Apply Bone Tuner overrides (patient skeleton) BEFORE therapist hands
¬† if (CURRENT_BODY_TEST && CURRENT_BODY_BUCKET) {
¬† ¬† applyTunerOverrides(CURRENT_BODY_TEST, CURRENT_BODY_BUCKET, isResistanceActive);
¬† }
// === NEW: Therapist Hand Overrides (separate dictionary) ===
¬†
¬†// 1. Determine the key and check if a pose is saved in HAND_OVERRIDES
¬†// NOTE: 'key' is already declared for the patient pose logic above.
¬†let useSavedPose = key && HAND_OVERRIDES[key];

¬†// 2. Default to NEUTRAL pose.
¬†let poseToApply = HAND_NEUTRAL_POSE; 
¬† 
// ------------------------------------
// HAND OVERRIDE LOGIC (FINAL VERSION - CLEAN)
// ------------------------------------
const handKey = (CURRENT_BODY_TEST && CURRENT_BODY_BUCKET) ? `${CURRENT_BODY_TEST}:${CURRENT_BODY_BUCKET}` : null;

if (!handsModel || !rightHandModel || !leftHandModel) return;

// Logic is now strictly automated
if (handKey && HAND_OVERRIDES[handKey]) {
    applyHandOverride(handKey);
} else {
    resetHandsToNeutral();
}

// ‚≠ê Guarantee override on first toggle if test already active
if (CURRENT_BODY_TEST) forceApplyHandOverrideOnce();

// Optional: Fallback logic for neutral positioning
if (handKey && !HAND_OVERRIDES[handKey] && poseToApply) {
    const h = poseToApply;

¬† ¬† if (rightHandModel){
¬† ¬† ¬† ¬† // Apply position 
¬† ¬† ¬† ¬† if (h.handRX¬† != null) rightHandModel.position.x = h.handRX;
¬† ¬† ¬† ¬† if (h.handRY¬† != null) rightHandModel.position.y = h.handRY;
¬† ¬† ¬† ¬† if (h.handRZ¬† != null) rightHandModel.position.z = h.handRZ;
¬† ¬† ¬† ¬† // Apply rotation
¬† ¬† ¬† ¬† if (h.handRRX != null) rightHandModel.rotation.x = h.handRRX;
¬† ¬† ¬† ¬† if (h.handRRY != null) rightHandModel.rotation.y = h.handRRY;
¬† ¬† ¬† ¬† if (h.handRRZ != null) rightHandModel.rotation.z = h.handRRZ;
¬† ¬† }

¬† ¬† if (leftHandModel){
¬† ¬† ¬† ¬† // Apply position
¬† ¬† ¬† ¬† if (h.handLX¬† != null) leftHandModel.position.x = h.handLX;
¬† ¬† ¬† ¬† if (h.handLY¬† != null) leftHandModel.position.y = h.handLY;
¬† ¬† ¬† ¬† if (h.handLZ¬† != null) leftHandModel.position.z = h.handLZ;
¬† ¬† ¬† ¬† // Apply rotation
¬† ¬† ¬† ¬† if (h.handLRX != null) leftHandModel.rotation.x = h.handLRX;
¬† ¬† ¬† ¬† if (h.handLRY != null) leftHandModel.rotation.y = h.handLRY;
¬† ¬† ¬† ¬† if (h.handLRZ != null) leftHandModel.rotation.z = h.handLRZ;
¬† ¬† }
¬†}

   // Wrist tests: add right-arm bias (0¬∞ abd, 0¬∞ flex) in both seated modes
  if (mode === "seatedgravity" || mode === "seatednogravity"){
    const upperR = getBone("upperarm_R");
    const lowerR = getBone("lowerarm_R");

    // Reset just these bones to baseline so angles are absolute (not stacked)
    [upperR, lowerR].forEach(b => {
      if (!b) return;
      const q0 = initialBoneRot.get(b);
      if (q0) b.quaternion.copy(q0);
    });

    if (upperR) upperR.rotateZ(degToRad(-16));  // ¬∞ shoulder abduction
    if (lowerR) lowerR.rotateX(degToRad(25));  // ¬∞ elbow flexion
  }
 
// Wrist tests: right-arm bias for NO-gravity (0‚Äì2) pose
if (mode === "seatednogravity"){
  const upperR = getBone("upperarm_R");
  const lowerR = getBone("lowerarm_R");

  // Reset just these bones to baseline so angles are absolute (not stacked)
  [upperR, lowerR].forEach(b => {
    if (!b) return;
    const q0 = initialBoneRot.get(b);
    if (q0) b.quaternion.copy(q0);
  });

  // Same shoulder, MORE elbow flexion for gravity-eliminated setup
  if (upperR) upperR.rotateZ(degToRad(-12)); // shoulder abduction
  if (lowerR) lowerR.rotateX(degToRad(75));  // more elbow flexion (tweak if needed)
}
}

/* ==== Therapist Hands Model Logic ==== */
let rightHandModel = null;
let leftHandModel = null;

function loadHandsModel() {
    if (handsModel) return;
    $("msg").textContent = "Loading therapist hands model...";

    loader.load(
        HANDS_MODEL_URL,
        (gltf) => {
            handsModel = gltf.scene;
            
            // Identify individual hands
            rightHandModel = handsModel.getObjectByName("Hand_R") || handsModel.getObjectByName("hand_R");
            leftHandModel  = handsModel.getObjectByName("Hand_L") || handsModel.getObjectByName("hand_L");

            if (!rightHandModel || !leftHandModel) {
                const possible = [];
                handsModel.traverse(o => {
                    if (o.isMesh && o.parent !== handsModel) {
                        possible.push(o.parent);
                    }
                });
                const roots = [...new Set(possible)];
                if (roots.length === 2) {
                    roots.sort((a, b) => {
                        a.updateWorldMatrix(true, false);
                        b.updateWorldMatrix(true, false);
                        return a.getWorldPosition(new THREE.Vector3()).x - b.getWorldPosition(new THREE.Vector3()).x;
                    });
                    leftHandModel  = roots[0];
                    rightHandModel = roots[1];
                }
            }

            handsModel.visible = true;
            handsModel.scale.set(0.20, 0.20, 0.20);
            handsModel.position.set(0, 1.7, 0.5);
            scene.add(handsModel);

            // Removed resetHandsToNeutral fallback
            // Apply body position and force override immediately upon load finish
            applyBodyPositionFromSelection();
            forceApplyHandOverrideOnce();

            $("msg").textContent = "‚úÖ Hands model ready.";
            $("toggleHandsBtn").classList.add('lockOn');
        },
        (xhr) => {
            const pct = xhr.lengthComputable ? Math.min(100, Math.round(100 * xhr.loaded / xhr.total)) : null;
            $("msg").textContent = pct !== null ? `Loading Hands ${pct}%` : "Loading Hands...";
        },
        (error) => {
            console.error("Failed to load Hands model:", error);
            $("msg").textContent = "‚ö†Ô∏è Failed to load therapist hands.";
        }
    );
}

function applyHandOverride(key) {
    const h = HAND_OVERRIDES[key];
    if (!h) return;

    if (rightHandModel) {
        rightHandModel.position.set(h.handRX, h.handRY, h.handRZ);
        rightHandModel.rotation.set(h.handRRX, h.handRRY, h.handRRZ);
    }
    if (leftHandModel) {
        leftHandModel.position.set(h.handLX, h.handLY, h.handLZ);
        leftHandModel.rotation.set(h.handLRX, h.handLRY, h.handLRZ);
    }
}

function forceApplyHandOverrideOnce() {
    if (!actionSel?.value) return;
    if (!handsModel || !rightHandModel || !leftHandModel) return;

    const test = actionSel.value;
    const bucket = getGradeBucketForTest(test);
    const key = `${test}:${bucket}`;

    if (HAND_OVERRIDES[key]) {
        // Force engine update to ensure first-click accuracy
        handsModel.updateMatrixWorld(true);
        applyHandOverride(key);
    }
}

function toggleHands() {
    const btn = $("toggleHandsBtn");

    if (!handsModel) {
        loadHandsModel();
    } else {
        handsModel.visible = !handsModel.visible;

        if (handsModel.visible) {
            btn.classList.add('lockOn');
            forceApplyHandOverrideOnce();
        } else {
            btn.classList.remove('lockOn');
        }
    }
}
 // ========================================================== 

function degToRad(d){ return d * Math.PI / 180; }
function seatPoseOnlyLegs(){
  if(!skeleton) return;
  const get = (n)=> skeleton.bones.find(b => b.name === n);
  const thighL = get("thigh_L"), thighR = get("thigh_R"), calfL = get("calf_L"), calfR = get("calf_R");
  [thighL,thighR,calfL,calfR].forEach(b=>{
    if(!b) return;
    const q0 = initialBoneRot.get(b);
    if (q0) b.quaternion.copy(q0);
  });
  const rad = THREE.MathUtils.degToRad;
  if (thighL) thighL.rotateX(rad(85));
  if (thighR) thighR.rotateX(rad(85));
  if (calfL)  calfL.rotateX(rad(-90));
  if (calfR)  calfR.rotateX(rad(-90));
}

function longSitLegs(){
  if (!skeleton) return;
  const get = (n)=> skeleton.bones.find(b => b.name === n);

  const thighL = get("thigh_L");
  const thighR = get("thigh_R");
  const calfL  = get("calf_L");
  const calfR  = get("calf_R");

  // Reset to baseline first
  [thighL, thighR, calfL, calfR].forEach(b => {
    if (!b) return;
    const q0 = initialBoneRot.get(b);
    if (q0) b.quaternion.copy(q0);
  });

  const r = THREE.MathUtils.degToRad;

  // Hips flexed ~0¬∞
  if (thighL) thighL.rotateX(r(80));
  if (thighR) thighR.rotateX(r(80));

  // Knees almost straight (small flex so it doesn't lock/look weird)
  if (calfL)  calfL.rotateX(r(-5));
  if (calfR)  calfR.rotateX(r(-5));
}
  
// Side-lying limb preset:
// - Hips: add_L = 12¬∞, add_R = -12¬∞
// - Feet: R inversion 20¬∞, L eversion 20¬∞ (Z axis, foot_R / foot_L)
// - Neck: left lateral flexion 10¬∞ (Z axis, "neck")
// - Arms: adduction ¬±52¬∞ + flexion 30¬∞ (this part was already working)
function applySideLyingLimbs(){
  if (!skeleton) return;

  const thighL = getBone("thigh_L");
  const thighR = getBone("thigh_R");
  const upperL = getBone("upperarm_L");
  const upperR = getBone("upperarm_R");
  const footL  = getBone("foot_L");
  const footR  = getBone("foot_R");
  const neck   = getBone("neck");

  /* --- HIPS: explicit adduction angles from tuner --- */
  const SIDE_HIP_ADD_L_DEG = -12;   // Left hip adduction angle
  const SIDE_HIP_ADD_R_DEG = 12;   // Right hip adduction angle

  // Z axis = abduction/adduction for thighs
  setDegAxis(thighL, "z", SIDE_HIP_ADD_L_DEG);
  setDegAxis(thighR, "z", SIDE_HIP_ADD_R_DEG);

  /* --- FEET: frontal plane (inversion/eversion) on Z axis --- */
  // Right: inversion 20¬∞, Left: eversion 20¬∞
  // If either goes the wrong way, just flip that sign.
  const SIDE_FOOT_INV_R_DEG  = 20;   // right foot inversion
  const SIDE_FOOT_EVER_L_DEG = 20;  // left foot eversion

  setDegAxis(footR, "z", SIDE_FOOT_INV_R_DEG);
  setDegAxis(footL, "z", SIDE_FOOT_EVER_L_DEG);

  /* --- NECK: left lateral flexion 10¬∞ on Z axis --- */
  const SIDE_NECK_LAT_L_DEG = -20;
  setDegAxis(neck, "z", SIDE_NECK_LAT_L_DEG);

  /* --- ARMS: keep your working values (adduction ¬±52¬∞ + flex 30¬∞) --- */
  // Reset shoulders to baseline so these are absolute, not stacked
  [upperL, upperR].forEach(b => {
    if (!b) return;
    const q0 = initialBoneRot.get(b);
    if (q0) b.quaternion.copy(q0);
  });

  const SHO_FLEX_DEG = 30;  // flexion
  const SHO_ADD_DEG  = 52;  // adduction magnitude

  // Left arm: ‚àí52¬∞ add + 30¬∞ flex
  if (upperL){
    upperL.rotateZ(degToRad(-SHO_ADD_DEG));
    upperL.rotateX(degToRad(SHO_FLEX_DEG));
  }
  // Right arm: +52¬∞ add + 30¬∞ flex (mirror)
  if (upperR){
    upperR.rotateZ(degToRad(SHO_ADD_DEG));
    upperR.rotateX(degToRad(SHO_FLEX_DEG));
  }
}


/* ==== Load model ==== */
function addModel(gltf){
  model = gltf.scene;
  model.traverse(o=>{
    if (o.isMesh){ o.castShadow=true; o.receiveShadow=true; }
    if (o.isSkinnedMesh && !skeleton) skeleton = o.skeleton;
  });

  // store baseline bone rotations
  if (skeleton){
    skeleton.bones.forEach(b => initialBoneRot.set(b, b.quaternion.clone()));
    applyAnatomicBaseline();
  }

  // Apply hard-wired numeric transform (no saving, no snapping)
  model.scale.set(POSE.s, POSE.s, POSE.s);
  model.position.set(POSE.x, POSE.y, POSE.z);
  model.rotation.set(0, degToRad(POSE.ryDeg), 0);
  if (POSE.seated) seatPoseOnlyLegs();

  scene.add(model);
  $("msg").textContent = "‚úÖ Model loaded";
}

const MODEL_CANDIDATES = [
  window.ROMETRICS_MODEL_URL,
  "assets/Roma_ROMetrics.glb",
  new URL("assets/Roma_ROMetrics.glb", document.baseURI).href
].filter(Boolean);

function tryNextModelUrl(index){
  if(index >= MODEL_CANDIDATES.length){
    $("msg").textContent = "‚ö†Ô∏è Could not load model from any path.";
    return;
  }
  const url = MODEL_CANDIDATES[index];
  $("msg").textContent = "Loading model‚Ä¶ " + url;
  loader.load(
    url,
    (gltf)=> addModel(gltf),
    (xhr)=>{
      const pct = xhr.lengthComputable ? Math.min(100, Math.round(100*xhr.loaded/xhr.total)) : null;
      $("msg").textContent = pct!==null ? `Loading ${pct}%` : "Loading‚Ä¶";
    },
    ()=> tryNextModelUrl(index+1)
  );
}

tryNextModelUrl(0);  
// ============= NEW CLEAN HAND TUNER LOGIC =============
const handTunerPanel = document.getElementById("handTuner");
const handSideSel = document.getElementById("handSideSel");

function showHandTuner(){
  handTunerPanel.style.display = "none";
}

function hideHandTuner(){
  handTunerPanel.style.display = "none";
}

// Attach +/‚Äì button actions
document.querySelectorAll(".handStep").forEach(btn => {
  btn.addEventListener("click", () => {

    const side = handSideSel.value;  
    const hand = (side === "R") ? rightHandModel : leftHandModel;
    if (!hand) return;

    const mode = btn.dataset.mode;     // pos | rot
    const axis = btn.dataset.axis;     // x | y | z
    const dir  = btn.dataset.dir === "+" ? 1 : -1;

    if (mode === "pos") {
      hand.position[axis] += 0.05 * dir;
    } else {
      hand.rotation[axis] += 0.15 * dir;
    }
  });
});

document.getElementById("handSaveBtn").addEventListener("click", () => {

    const test   = window.currentMMTtest;
    const bucket = window.currentMMTgradeBucket; // "high" or "low"

    if (!test || !bucket){
        alert("‚ö†Ô∏è Select a test + grade first.");
        return;
    }

    if (!rightHandModel || !leftHandModel){
        alert("‚ö†Ô∏è Hands not loaded.");
        return;
    }

    const key = `${test}:${bucket}`;

const out = {
        // --- POSITION (X, Y, Z) ---
        handRX:  rightHandModel.position.x,
        handRY:  rightHandModel.position.y,
        handRZ:  rightHandModel.position.z,

        // --- ROTATION (RRX, RRY, RRZ) ---
        handRRX: rightHandModel.rotation.x,
        handRRY: rightHandModel.rotation.y,
        handRRZ: rightHandModel.rotation.z,

        // --- POSITION (X, Y, Z) ---
        handLX:  leftHandModel.position.x,
        handLY:  leftHandModel.position.y,
        handLZ:  leftHandModel.position.z,

        // --- ROTATION (LRX, LRY, LRZ) ---
        handLRX: leftHandModel.rotation.x,
        handLRY: leftHandModel.rotation.y,
        handLRZ: leftHandModel.rotation.z
    };

    console.log(`HAND_OVERRIDES["${key}"] = ${JSON.stringify(out)};`);
    alert("Hand pose saved ‚Äî check console.");
});


function applyBodyPositionFromSelection(){
  if (!model || !skeleton) return;
  
  const test = actionSel?.value;
  if (!test) return;

  const bucket = getGradeBucketForTest(test);

  // ‚òÖ REQUIRED FOR HAND TUNER ‚òÖ
  window.currentMMTtest = test;
  window.currentMMTgradeBucket = bucket;
  // ‚òÖ END REQUIRED ‚òÖ

  const family = TEST_POSITION[test] || { high:"anatomic", low:"anatomic" };
  const mode = bucket === "low"
      ? (family.low  || "anatomic")
      : (family.high || "anatomic");

  CURRENT_BODY_TEST = test;
  CURRENT_BODY_BUCKET = bucket;

  // Pass the current timer state to setBodyMode
  const isResistanceActive = !!resistanceTimer; 
  setBodyMode(mode, isResistanceActive); 

  if (poseTunerEl && poseTunerEl.updateLabels){
    poseTunerEl.updateLabels();
  }
}
/* ==== Wire UI ==== */
const toggleHandsBtn = $("toggleHandsBtn");

// Initial state: locked
toggleHandsBtn.disabled = true;
toggleHandsBtn.classList.add("lockOn");

// Keep only ONE definition of toggleHands - Ensure any other 'function toggleHands' is deleted
if (toggleHandsBtn) {
  toggleHandsBtn.onclick = () => {
    if (!handsModel) {
        loadHandsModel();
        return;
    }
    handsModel.visible = !handsModel.visible;
    if (handsModel.visible) {
        toggleHandsBtn.classList.add('lockOn');
        const test = actionSel.value;
        const bucket = getGradeBucketForTest(test);
        const key = `${test}:${bucket}`;
        if (HAND_OVERRIDES[key]) applyHandOverride(key);
    } else {
        toggleHandsBtn.classList.remove('lockOn');
    }
  };
}

// When a test is selected, unlock buttons and apply pose
actionSel.addEventListener("change", () => {
    const testKey = actionSel.value;
    const isTestSelected = !!testKey;
    const isDisabled = shouldResistanceBeDisabled();
    const bucket = getGradeBucketForTest(testKey);
    const key = `${testKey}:${bucket}`;

    // Check if hand override exists for this specific selection
    const hasHandData = isTestSelected && !!HAND_OVERRIDES[key];

    // --- 1. VECTOR CLEARING ---
    if (areVectorsVisible) hideVectors();
    vectorOverlayBtn.classList.remove('lockOn');
    const isLowBucket = bucket === "low";
    const isException = EXCEPTION_TESTS.has(testKey);
    vectorOverlayBtn.disabled = !isTestSelected || isException || isLowBucket;

    // --- 2. HANDS BUTTON LOGIC ---
    toggleHandsBtn.disabled = !hasHandData;
    if (!hasHandData) {
        toggleHandsBtn.classList.add("lockOn");
        if (handsModel) handsModel.visible = false;
    } else {
        toggleHandsBtn.classList.remove("lockOn");
    }

    // --- 3. RESISTANCE BUTTON LOGIC ---
    testButton.disabled = isDisabled; 
    if (isDisabled) {
        resistanceText.textContent = 'Manual Resistance N/A (Grade 0‚Äì2)';
        $("msg").textContent = "Test set. Resistance is disabled for gravity-eliminated grades.";
    } else {
        resistanceText.textContent = 'Hold to Apply Resistance (Grade 3, 4, 5)';
        $("msg").textContent = "Test selected. **Hold resistance button to execute MMT.**";
    }
    
    // --- 4. Model Setup ---
    window.currentMMTtest = testKey;
    window.currentMMTgradeBucket = bucket;
    updateGradeDropdownsForSelection();
    applyBodyPositionFromSelection();
    forceApplyHandOverrideOnce();
    
    if (isVectorTunerVisible) updateVectorTunerLabels();
    if (poseTunerEl && poseTunerEl.updateLabels) poseTunerEl.updateLabels();
});

// Normal Grade 3‚Äì0 menu: used for all NON-exception tests
gradeMain.addEventListener("change", () => {
    const testKey = actionSel.value;
    if (testKey && !EXCEPTION_TESTS.has(testKey)){
        const bucket = getGradeBucketForTest(testKey);
        const key = `${testKey}:${bucket}`;
        const hasHandData = !!HAND_OVERRIDES[key];
        const isDisabled = shouldResistanceBeDisabled();

        toggleHandsBtn.disabled = !hasHandData;
        if (!hasHandData && handsModel) handsModel.visible = false;
        toggleHandsBtn.classList.toggle("lockOn", !hasHandData);

        testButton.disabled = isDisabled;
        resistanceText.textContent = isDisabled ? 'Manual Resistance N/A (Grade 0‚Äì2)' : 'Hold to Apply Resistance (Grade 3, 4, 5)';

        window.currentMMTgradeBucket = bucket;
        applyBodyPositionFromSelection();
        forceApplyHandOverrideOnce();

        if (bucket === "low" && areVectorsVisible) hideVectors();
        vectorOverlayBtn.disabled = (bucket === "low");

        if (poseTunerEl && poseTunerEl.updateLabels) poseTunerEl.updateLabels();
    }
});

// Grading Exceptions 5‚Äì1 menu: used ONLY for exception tests (trunk + gastroc)
if (gradeExceptions){
  gradeExceptions.addEventListener("change", () => {
    const testKey = actionSel.value;
    if (testKey && EXCEPTION_TESTS.has(testKey)){
        const bucket = getGradeBucketForTest(testKey);
        const key = `${testKey}:${bucket}`;
        const hasHandData = !!HAND_OVERRIDES[key];
        const isDisabled = shouldResistanceBeDisabled();

        toggleHandsBtn.disabled = !hasHandData;
        if (!hasHandData && handsModel) handsModel.visible = false;
        toggleHandsBtn.classList.toggle("lockOn", !hasHandData);

        testButton.disabled = isDisabled;
        resistanceText.textContent = isDisabled ? 'Manual Resistance N/A (Grade 0‚Äì2)' : 'Hold to Apply Resistance (Grade 3, 4, 5)';

        window.currentMMTgradeBucket = bucket;
        applyBodyPositionFromSelection();
        forceApplyHandOverrideOnce();

        if (poseTunerEl && poseTunerEl.updateLabels) poseTunerEl.updateLabels();
    }
  });
}

// Initialize menus on first load
updateGradeDropdownsForSelection();


/* ==== Side panel + Markdown loading ==== */
const notePanel = document.getElementById('notePanel');
const noteTitle = document.getElementById('noteTitle');
const noteBody  = document.getElementById('noteBody');
const tabHigh   = document.getElementById('tabHigh'); // 3‚Äì5
const tabLow    = document.getElementById('tabLow');  // 0‚Äì2
const closeNote = document.getElementById('closeNote');

// GitHub RAW URLs for the two docs
const MD_HIGH = "/mmt/rometrics_mmt_threetofive.md";
const MD_LOW  = "/mmt/rometrics_mmt_zerototwo.md";


// Map select values to readable headings to find in MD
const TEST_TO_HEADING = {
  Single_SCM: "Anterolateral Flexion",  // Single SCM ‚Äî Anterolateral Flexion
  Serratus_Anterior: "Scapular Abduction & Upward Rotation",
  Upper_Trapezius: "Scapular Elevation",
  Middle_Trapezius: "Scapular Adduction / Retraction",
  Scap_Depression_Adduction: "Scapular Depression + Adduction",
  Rhomboids: "Scapular Adduction + Downward Rotation",
  Latissimus_Dorsi: "Latissimus Dorsi",
  Anterior_Deltoid: "Shoulder Flexion",
  Posterior_Deltoid: "Shoulder Extension ‚Äî Posterior Deltoid",
  Middle_Deltoid: "Shoulder Abduction",
  Shoulder_Horiz_Abd: "Shoulder Horizontal Abduction ‚Äî Posterior Deltoid",
  Shoulder_Horiz_Add: "Shoulder Horizontal Adduction ‚Äî Pectoralis Major",
  Infraspinatus: "Shoulder External Rotation",
  Subscapularis: "Shoulder Internal Rotation",
  Biceps_Brachii:    "Elbow Flexion",
  Brachialis:        "Elbow Flexion",
  Brachioradialis:   "Elbow Flexion",
  Triceps_Brachii: "Elbow Extension",
  Trunk_Ext_Lumbar:   "Trunk Extension ‚Äî Lumbar",
  Trunk_Ext_Thoracic: "Trunk Extension ‚Äî Thoracic",
  ECRL: "Wrist Extension ‚Äî ECRL, ECRB, ECU",
  ECRB: "Wrist Extension ‚Äî ECRL, ECRB, ECU",
  ECU:  "Wrist Extension ‚Äî ECRL, ECRB, ECU",
  FCR: "Wrist Flexion ‚Äî Flexor Carpi Radialis",
  FCU: "Wrist Flexion ‚Äî Flexor Carpi Ulnaris",
  Iliopsoas: "Hip Flexion",
  Glute_Max: "Hip Extension",
  Glute_Med: "Hip Abduction",
  Hip_ER: "Hip External Rotation",
  Hip_IR: "Hip Internal Rotation",
  Glute_Max: "Hip Extension ‚Äî Gluteus Maximus",
  TFL: "Hip Abduction from Flexed Position ‚Äî Tensor Fasciae Latae (TFL)",
  Hip_Adduction: "Hip Adduction ‚Äî Adductor Group",
  Sartorius: "Hip Flexion, Abduction, External Rotation with Knee Flexion ‚Äî Sartorius",
  Hamstrings: "Knee Flexion (Hamstrings)",
  Quadriceps: "Knee Extension",
  Tibialis_Anterior: "Foot Dorsiflexion + Inversion",
  Foot_Eversion_PF: "Plantar Flexion + Foot Eversion ‚Äî Fibularis Longus & Brevis",
  Gastrocnemius: "Ankle Plantar Flexion"
};

function mdToHtml(md){
  // Tiny converter for headings/lists/bold/paragraphs
  return md
    .replace(/^### (.*)$/gm, "<h3>$1</h3>")
    .replace(/^## (.*)$/gm, "<h2>$1</h2>")
    .replace(/^\* (.*)$/gm, "<li>$1</li>")
    .replace(/^- (.*)$/gm, "<li>$1</li>")
    .replace(/(\n<li>.*<\/li>)+/g, m => `<ul>${m}</ul>`)
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
    .replace(/\n{2,}/g, "</p><p>")
    .replace(/^([^<\n].*)$/gm, "<p>$1</p>");
}

function extractSection(md, queryHeading){
  const norm = s => s.toLowerCase().replace(/[^a-z0-9]+/g, " ").trim();
  const target = norm(queryHeading);

  const lines = md.split(/\r?\n/);
  let start = -1;

  // Find the matching "## ..." test heading
  for (let i = 0; i < lines.length; i++){
    const line = lines[i];
    if (line.startsWith("## ") && norm(line).includes(target)){
      start = i;
      break;
    }
  }

  if (start === -1){
    return md; // fallback: whole doc if we can't find it
  }

  // End at the next "## ..." (ignore ###, #### etc. so sub-headings stay inside)
  let end = lines.length;
  for (let j = start + 1; j < lines.length; j++){
    const line = lines[j];
    if (line.startsWith("## ")){
      end = j;
      break;
    }
  }

  return lines.slice(start, end).join("\n");
}



async function loadNoteFile(which){
  const muscleKey = actionSel.value;
  if (!muscleKey){
    noteBody.innerHTML = "<p>Select a test first.</p>";
    return;
  }
  const heading = TEST_TO_HEADING[muscleKey] || muscleKey.replaceAll("_"," ");
  noteTitle.textContent = heading + " ‚Äî MMT Instructions";
  const url = (which === 'high') ? MD_HIGH : MD_LOW;
  noteBody.innerHTML = "Loading‚Ä¶";
  try{
    const res = await fetch(url);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    const section = extractSection(text, heading);
    noteBody.innerHTML = mdToHtml(section);
  }catch(e){
    noteBody.textContent = "Failed to load instructions.";
  }
}

function openNote(which='high'){
  tabHigh.classList.toggle('active', which==='high');
  tabLow.classList.toggle('active', which!=='high');
  notePanel.classList.remove('hide');
  notePanel.style.display = "flex";
  loadNoteFile(which);
}

showMMT.addEventListener('click', () => {
  const gm = Number(gradeMain.value || "3");
  openNote(gm >= 3 ? 'high' : 'low');
});
tabHigh.addEventListener('click', ()=> openNote('high'));
tabLow.addEventListener('click', ()=> openNote('low'));
closeNote.addEventListener('click', ()=> notePanel.classList.add('hide'));

 /* ===== Pose Tuner (dev) ‚Äî per-test high/low body transforms ===== */
let poseTunerEl = null;
let poseTunerVisible = false; // show on load so you can tune positions

function ensurePoseTuner(){
  if (poseTunerEl) return poseTunerEl;

  poseTunerEl = document.createElement('div');
  Object.assign(poseTunerEl.style, {
    position: 'fixed',
    right: '16px',
    top: '16px',
    zIndex: 50,
    background: 'rgba(8,13,26,.96)',
    border: '1px solid #334155',
    borderRadius: '12px',
    padding: '10px',
    width: '300px',
    color: '#e2e8f0',
    font: '12px/1.3 system-ui,Segoe UI,Roboto',
    boxShadow: '0 8px 28px rgba(0,0,0,.4)',
    display: 'none'
  });

  poseTunerEl.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
      <strong style="font-size:13px;">Pose Tuner (High / Low)</strong>
      <button id="poseTunerClose" title="Close" style="margin-left:auto;background:transparent;border:0;color:#9fb0c9;font-size:16px;cursor:pointer;">‚úï</button>
    </div>
    <div style="font-size:11px;margin-bottom:6px;">
      <div><strong>Test:</strong> <span id="poseTunerTestLabel">(none)</span></div>
      <div><strong>Family:</strong> <span id="poseTunerBucketLabel">high</span></div>
    </div>

    <div style="border-top:1px solid #1f2933;margin:6px 0 8px 0;"></div>

    <label style="display:block;opacity:.85;">Position (meters)</label>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-bottom:4px;">
      <div>
        <div style="opacity:.7;">X (left/right)</div>
        <div style="display:flex;gap:4px;">
          <button data-axis="x" data-delta="-0.02" class="mini">‚àí</button>
          <button data-axis="x" data-delta="0.02" class="mini">+</button>
        </div>
      </div>
      <div>
        <div style="opacity:.7;">Y (up/down)</div>
        <div style="display:flex;gap:4px;">
          <button data-axis="y" data-delta="-0.02" class="mini">‚àí</button>
          <button data-axis="y" data-delta="0.02" class="mini">+</button>
        </div>
      </div>
      <div>
        <div style="opacity:.7;">Z (front/back)</div>
        <div style="display:flex;gap:4px;">
          <button data-axis="z" data-delta="-0.02" class="mini">‚àí</button>
          <button data-axis="z" data-delta="0.02" class="mini">+</button>
        </div>
      </div>
    </div>

    <label style="display:block;opacity:.85;margin-top:4px;">Rotation (degrees)</label>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:4px;">
      <div>
        <div style="opacity:.7;">Yaw (turn left/right)</div>
        <div style="display:flex;gap:4px;">
          <button data-rot="y" data-delta="-5" class="mini">‚ü≤</button>
          <button data-rot="y" data-delta="5" class="mini">‚ü≥</button>
        </div>
      </div>
      <div>
        <div style="opacity:.7;">Pitch/Roll (face up/down/side)</div>
        <div style="display:flex;gap:4px;flex-wrap:wrap;">
          <button data-rot="x" data-delta="-5" class="mini">Pitch ‚àí</button>
          <button data-rot="x" data-delta="5" class="mini">Pitch +</button>
          <button data-rot="z" data-delta="-5" class="mini">Roll ‚àí</button>
          <button data-rot="z" data-delta="5" class="mini">Roll +</button>
        </div>
      </div>
    </div>

   <div style="display:flex;gap:8px;margin-top:8px;">
      <button id="poseTunerSnapBase" class="mini" style="flex:1;">Reset to Base Mode</button>
      <button id="poseTunerSave" class="mini" style="flex:1;background:#0f766e;border-color:#0f766e;color:#fff;">Save for Test</button>
    </div>

    <div style="margin-top:6px;font-size:10px;opacity:.7;">
      Uses current dropdown + grade to decide <em>which</em> pose (high vs low) you‚Äôre tuning.
    </div>
  `; 

  document.body.appendChild(poseTunerEl);

  const labelTest   = poseTunerEl.querySelector('#poseTunerTestLabel');
  const labelBucket = poseTunerEl.querySelector('#poseTunerBucketLabel');
  const btnClose    = poseTunerEl.querySelector('#poseTunerClose');
  const btnSave     = poseTunerEl.querySelector('#poseTunerSave');
  const btnSnapBase = poseTunerEl.querySelector('#poseTunerSnapBase');

  function updateLabels(){
    if (!actionSel) return;
    const opt = actionSel.selectedOptions?.[0];
    labelTest.textContent = opt ? opt.textContent.trim() : '(none)';
    labelBucket.textContent = CURRENT_BODY_BUCKET || 'high';
  }

  // Helper: read rotation in degrees vs baseline, around a single axis
  function extractAxisDeg(boneName, axis) {
    if (!skeleton) return 0;
    const bone = getBone(boneName);
    if (!bone) return 0;
    const base = initialBoneRot.get(bone);
    if (!base) return 0;

    // delta = current * inverse(base)
    const qDelta = bone.quaternion.clone().multiply(base.clone().invert());
    const e = new THREE.Euler().setFromQuaternion(qDelta, 'XYZ');

    let rad = 0;
    if (axis === 'x') rad = e.x;
    else if (axis === 'y') rad = e.y;
    else rad = e.z;

    return THREE.MathUtils.radToDeg(rad);
  }


  // Helper: get or create override object for current test+bucket
  function getCurrentOverrideKey(){
    if (!CURRENT_BODY_TEST || !CURRENT_BODY_BUCKET) return null;
    return `${CURRENT_BODY_TEST}:${CURRENT_BODY_BUCKET}`;
  }

  function ensureOverrideFromCurrentPose(){
    const key = getCurrentOverrideKey();
    if (!key || !model) return null;
    if (!POSE_OVERRIDES[key]){
      const euler = new THREE.Euler().copy(model.rotation);
      POSE_OVERRIDES[key] = {
        x: model.position.x,
        y: model.position.y,
        z: model.position.z,
        rx: euler.x,
        ry: euler.y,
        rz: euler.z
      };
    }
    return key;
  }

  function applyOverride(key){
    const o = key && POSE_OVERRIDES[key];
    if (!o || !model) return;
    model.position.set(o.x, o.y, o.z);
    model.rotation.set(o.rx, o.ry, o.rz);
  }

  // Position buttons
  poseTunerEl.querySelectorAll('button[data-axis]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = ensureOverrideFromCurrentPose();
      if (!key) return;
      const axis = btn.getAttribute('data-axis');
      const delta = parseFloat(btn.getAttribute('data-delta') || '0');
      const o = POSE_OVERRIDES[key];
      if (axis === 'x') o.x += delta;
      if (axis === 'y') o.y += delta;
      if (axis === 'z') o.z += delta;
      applyOverride(key);
    });
  });

// Rotation buttons (deg)
poseTunerEl.querySelectorAll('button[data-rot]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const key = ensureOverrideFromCurrentPose();
    if (!key) return;
    const axis = btn.getAttribute('data-rot');
    const deltaDeg = parseFloat(btn.getAttribute('data-delta') || '0');
    const deltaRad = THREE.MathUtils.degToRad(deltaDeg);
    const o = POSE_OVERRIDES[key];
    if (axis === 'x') o.rx += deltaRad;
    if (axis === 'y') o.ry += deltaRad;
    if (axis === 'z') o.rz += deltaRad;
    applyOverride(key);
  }); // <--- Closing the click event listener
}); // <--- Closing the forEach loop

  // Reset to base (throw away override & re-apply base mode)
  btnSnapBase.onclick = () => {
    const key = getCurrentOverrideKey();
    if (key && POSE_OVERRIDES[key]) delete POSE_OVERRIDES[key];
    applyBodyPositionFromSelection();
    updateLabels();
  };

// Save button logs config INCLUDING plantarflexion + side-lying angles
btnSave.onclick = () => {
  const key = ensureOverrideFromCurrentPose();
  if (!key) return;
  const o = POSE_OVERRIDES[key];

  // Only logging x, y, z, rx, ry, rz as requested
  console.log(
    `POSE_OVERRIDES["${key}"] = { ` +
    `x:${o.x.toFixed(3)}, y:${o.y.toFixed(3)}, z:${o.z.toFixed(3)}, ` +
    `rx:${o.rx.toFixed(3)}, ry:${o.ry.toFixed(3)}, rz:${o.rz.toFixed(3)} };`
  );

  labelTest.style.color = '#22c55e';
  setTimeout(()=>labelTest.style.color='#e2e8f0', 600);
};



  // Close
  btnClose.onclick = () => {
    poseTunerVisible = false;
    poseTunerEl.style.display = 'none';
  };

  // Public helper so other code can refresh labels when test/grade changes
  poseTunerEl.updateLabels = updateLabels;

  return poseTunerEl;
}

function showPoseTuner(show){
  ensurePoseTuner();
  poseTunerVisible = (show === undefined) ? !poseTunerVisible : !!show;
  poseTunerEl.style.display = poseTunerVisible ? 'block' : 'none';
  if (poseTunerVisible && poseTunerEl.updateLabels) poseTunerEl.updateLabels();
}
// Init the Pose Tuner once the module + DOM are ready
window.addEventListener("load", () => {
¬† try {
¬† ¬† ensurePoseTuner();
¬† ¬† showPoseTuner(false); // dev: show on first load¬† 
¬† } catch (e) {
¬† ¬† const m = document.getElementById("msg");
¬† ¬† if (m) m.textContent = "‚ö†Ô∏è Pose tuner init failed: " + e.message;
¬† ¬† console.error(e);
¬† }
});
/* ==== Vector Tuner Logic ==== */
const vectorTunerEl = $("vectorTuner");
const vectorTunerClose = $("vectorTunerClose");
const vectorTypeSel = $("vectorTypeSel");
const vectorTunerTestLabel = $("vectorTunerTestLabel");
const vectorTunerSaveBtn = $("vectorTunerSaveBtn");
const toggleVectorTunerBtn = $("toggleVectorTunerBtn");

let isVectorTunerVisible = false;

function getCurrentVectorData() {
    const testKey = actionSel.value;
    if (!testKey) return null;
    return VECTOR_GUIDES[testKey];
}

function updateVectorTunerLabels() {
    const testKey = actionSel.value;
    vectorTunerTestLabel.textContent = testKey || "(No Test Selected)";

    // Force vector overlay to show while tuning
    if (!areVectorsVisible) {
        toggleVectorOverlay();
    }
}

function showVectorTuner(show) {
    if (show === undefined) show = !isVectorTunerVisible;
    isVectorTunerVisible = show;

    if (isVectorTunerVisible) {
        vectorTunerEl.style.display = 'none';
        updateVectorTunerLabels();
        // Force initial update of vectors to show them correctly positioned
        if (!areVectorsVisible) toggleVectorOverlay(); 
        
        // Ensure only the selected test is displayed
        if (!actionSel.value) {
            $("msg").textContent = "Select an MMT test to use the Vector Tuner.";
        }
    } else {
        vectorTunerEl.style.display = 'none';
        // Hide vectors when tuner closes
        if (areVectorsVisible) toggleVectorOverlay(); 
    }
}

// ----------------------------------------------------
// A P P L Y   T U N E R   C H A N G E S
// index (80).html - REPLACEMENT for the vectorTunerEl.querySelectorAll('.vectorStep').forEach(btn => {...}); block (Around line 2360)

vectorTunerEl.querySelectorAll('.vectorStep').forEach(btn => {
    btn.addEventListener('click', () => {
        const testKey = actionSel.value;
        const data = getCurrentVectorData();
        if (!data) return;

        const type = vectorTypeSel.value; // E, R, E_DIR, R_DIR
        const axis = btn.dataset.axis;
        const delta = parseFloat(btn.dataset.delta);
        const mode = btn.dataset.mode; // 'rot' or undefined (for position/magnitude)
        
        let targetObject;

        if (mode !== 'rot') {
            // --- POSITION / MAGNITUDE ADJUSTMENT (Existing Logic) ---
            if (type === 'E') targetObject = data.E_startPos;
            else if (type === 'R') targetObject = data.R_startPos;
            else if (type === 'E_DIR') targetObject = data.E_direction;
            else if (type === 'R_DIR') targetObject = data.R_direction;

            if (targetObject) {
                targetObject[axis] += delta;
            }

        } else {
            // --- ROTATION ADJUSTMENT (NEW Logic) ---
            // Only apply rotation if 'Direction' is selected
            if (type === 'E_DIR' || type === 'R_DIR') {
                targetObject = (type === 'E_DIR') ? data.E_direction : data.R_direction;
                
                // 1. Convert targetObject to a THREE.Vector3
                const vector = new THREE.Vector3(targetObject.x, targetObject.y, targetObject.z);
                const rotationMatrix = new THREE.Matrix4();
                const deltaRad = THREE.MathUtils.degToRad(delta);
                
                // 2. Create rotation matrix around the specified axis
                if (axis === 'x') rotationMatrix.makeRotationX(deltaRad);
                else if (axis === 'y') rotationMatrix.makeRotationY(deltaRad);
                else if (axis === 'z') rotationMatrix.makeRotationZ(deltaRad);

                // 3. Apply rotation to the vector
                vector.applyMatrix4(rotationMatrix);
                
                // 4. Update the targetObject back to plain JavaScript object (needed for saving to console)
                targetObject.x = vector.x;
                targetObject.y = vector.y;
                targetObject.z = vector.z;
            }
        }

        // Re-apply the vector overlay immediately to see the change
        if (areVectorsVisible) {
            toggleVectorOverlay();
            toggleVectorOverlay();
        }
    });
});

// ----------------------------------------------------
// S A V E   T O   C O N S O L E
// ----------------------------------------------------
vectorTunerSaveBtn.addEventListener('click', () => {
    const testKey = actionSel.value;
    const data = getCurrentVectorData();
    if (!testKey || !data) {
        alert("Select an MMT test first.");
        return;
    }

    const output = `
    // ${testKey}: (Aligned Vectors)
    ${testKey}: {
        E_startPos: { x: ${data.E_startPos.x.toFixed(3)}, y: ${data.E_startPos.y.toFixed(3)}, z: ${data.E_startPos.z.toFixed(3)} },
        E_direction: { x: ${data.E_direction.x.toFixed(3)}, y: ${data.E_direction.y.toFixed(3)}, z: ${data.E_direction.z.toFixed(3)} },
        R_startPos: { x: ${data.R_startPos.x.toFixed(3)}, y: ${data.R_startPos.y.toFixed(3)}, z: ${data.R_startPos.z.toFixed(3)} },
        R_direction: { x: ${data.R_direction.x.toFixed(3)}, y: ${data.R_direction.y.toFixed(3)}, z: ${data.R_direction.z.toFixed(3)} }
    },`;

    console.log(output);
    $("msg").textContent = `Vector configuration saved to console for ${testKey}. Copy and paste into VECTOR_GUIDES.`;
});


/* ==== Wiring & Initial State for Vector Tuner ==== */
if (vectorTunerClose) vectorTunerClose.addEventListener('click', () => showVectorTuner(false));
if (toggleVectorTunerBtn) toggleVectorTunerBtn.addEventListener('click', () => showVectorTuner());

// Update logic when a new test is selected (Need to modify existing listener)
// You need to add these lines inside your existing actionSel.addEventListener("change", ...);
/*
if (isVectorTunerVisible) updateVectorTunerLabels();
if (areVectorsVisible) {
    // Force vector update on test change if visible
    toggleVectorOverlay();
    toggleVectorOverlay();
}
*/ 
/* ==== Loop & resize ==== */
addEventListener("resize", ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

// --- Interaction Logic Removed (Practice Mode Obsolete) ---
function onPointerDownTransformControls(event) {
    // This function is now empty as Practice Placement and Switch Hand modes have been removed.
    // TransformControls are no longer active during standard MMT assessment.
}
// --- END: Interaction Logic ---
  
(function loop(){
  controls.update();
  renderer.render(scene, camera);
  requestAnimationFrame(loop);
})();

</script>
<!-- ================= HAND TUNER PANEL (NEW CLEAN VERSION) ================= -->
<div id="handTuner" style="
  position:fixed; right:12px; top:80px; width:240px;
  background:#ffffffdd; padding:12px; border-radius:10px;
  font-family:system-ui; display:none; z-index:9999; box-shadow:0 0 10px #0003;
">
  <div style="font-weight:600; margin-bottom:8px;">Therapist Hand Tuner</div>

  <label>Side:</label>
  <select id="handSideSel">
    <option value="R">Right</option>
    <option value="L">Left</option>
  </select>

  <div style="margin-top:10px; font-weight:600;">Position</div>
  <div class="row"><span>X</span>
    <button class="handStep" data-mode="pos" data-axis="x" data-dir="-">‚Äì</button>
    <button class="handStep" data-mode="pos" data-axis="x" data-dir="+">+</button>
  </div>
  <div class="row"><span>Y</span>
    <button class="handStep" data-mode="pos" data-axis="y" data-dir="-">‚Äì</button>
    <button class="handStep" data-mode="pos" data-axis="y" data-dir="+">+</button>
  </div>
  <div class="row"><span>Z</span>
    <button class="handStep" data-mode="pos" data-axis="z" data-dir="-">‚Äì</button>
    <button class="handStep" data-mode="pos" data-axis="z" data-dir="+">+</button>
  </div>

  <div style="margin-top:10px; font-weight:600;">Rotation</div>
  <div class="row"><span>RX</span>
    <button class="handStep" data-mode="rot" data-axis="x" data-dir="-">‚Äì</button>
    <button class="handStep" data-mode="rot" data-axis="x" data-dir="+">+</button>
  </div>
  <div class="row"><span>RY</span>
    <button class="handStep" data-mode="rot" data-axis="y" data-dir="-">‚Äì</button>
    <button class="handStep" data-mode="rot" data-axis="y" data-dir="+">+</button>
  </div>
  <div class="row"><span>RZ</span>
    <button class="handStep" data-mode="rot" data-axis="z" data-dir="-">‚Äì</button>
    <button class="handStep" data-mode="rot" data-axis="z" data-dir="+">+</button>
  </div>
  <button id="handSaveBtn" style="margin-top:12px;width:100%;background:#10b981;color:white;">
  Save Hand Pose
</button>
//VECTOR TUNER//
</div>
<div id="vectorTuner" style="
  position:fixed; right:12px; top:80px; width:300px; max-height: 90vh; overflow-y: auto;
  background:rgba(8,13,26,.96); border:1px solid #334155; border-radius:12px;
  padding:10px; z-index:9999; box-shadow:0 8px 28px rgba(0,0,0,.4);
  color:#e2e8f0; font:12px/1.3 system-ui,Segoe UI,Roboto; display:none;
">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
    <strong style="font-size:13px;">Vector Tuner (MMT Guide)</strong>
    <button id="vectorTunerClose" title="Close" style="margin-left:auto;background:transparent;border:0;color:#9fb0c9;font-size:16px;cursor:pointer;">‚úï</button>
  </div>
  <div style="font-size:11px;margin-bottom:6px;">
    <div><strong>Test:</strong> <span id="vectorTunerTestLabel">(none)</span></div>
  </div>

  <div style="border-top:1px solid #1f2933;margin:6px 0 8px 0;"></div>

  <label style="display:block;opacity:.85;margin-bottom:4px;">Active Vector:</label>
  <select id="vectorTypeSel" style="width:100%;margin-bottom:8px;background:#334155;color:#e2e8f0;border-color:#475569;">
    <option value="E">Effort (Blue) - Start Position</option>
    <option value="R">Resistance (Green) - Start Position</option>
    <option value="E_DIR">Effort (Blue) - Direction</option>
    <option value="R_DIR">Resistance (Green) - Direction</option>
  </select>
  
  <p style="font-size:10px; margin: 4px 0 8px; opacity: 0.7;">
    Note: Direction tuning changes the vector's rotation/end point.
  </p>

  <label style="display:block;opacity:.85;">Adjust Coordinates (meters / Directional Magnitude)</label>
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-bottom:8px;">
    <div>
      <div style="opacity:.7;font-size:10px;">X</div>
      <div class="row">
        <button data-axis="x" data-delta="-0.04" class="vectorStep mini">‚àí</button>
        <button data-axis="x" data-delta="0.04" class="vectorStep mini">+</button>
      </div>
    </div>
    <div>
      <div style="opacity:.7;font-size:10px;">Y</div>
      <div class="row">
        <button data-axis="y" data-delta="-0.04" class="vectorStep mini">‚àí</button>
        <button data-axis="y" data-delta="0.04" class="vectorStep mini">+</button>
      </div>
    </div>
    <div>
      <div style="opacity:.7;font-size:10px;">Z</div>
      <div class="row">
        <button data-axis="z" data-delta="-0.04" class="vectorStep mini">‚àí</button>
        <button data-axis="z" data-delta="0.04" class="vectorStep mini">+</button>
      </div>
    </div>
  </div>
  
<div style="border-top:1px solid #1f2933;margin:8px 0 8px 0;"></div>

  <label style="display:block;opacity:.85;">Rotation Adjustment (degrees)</label>
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-bottom:8px;">
    <div>
      <div style="opacity:.7;font-size:10px;">X (Pitch)</div>
      <div class="row">
        <button data-axis="x" data-delta="-5" data-mode="rot" class="vectorStep mini">‚àí5¬∞</button>
        <button data-axis="x" data-delta="5" data-mode="rot" class="vectorStep mini">+5¬∞</button>
      </div>
    </div>
    <div>
      <div style="opacity:.7;font-size:10px;">Y (Yaw)</div>
      <div class="row">
        <button data-axis="y" data-delta="-5" data-mode="rot" class="vectorStep mini">‚àí5¬∞</button>
        <button data-axis="y" data-delta="5" data-mode="rot" class="vectorStep mini">+5¬∞</button>
      </div>
    </div>
    <div>
      <div style="opacity:.7;font-size:10px;">Z (Roll)</div>
      <div class="row">
        <button data-axis="z" data-delta="-5" data-mode="rot" class="vectorStep mini">‚àí5¬∞</button>
        <button data-axis="z" data-delta="5" data-mode="rot" class="vectorStep mini">+5¬∞</button>
      </div>
    </div>
  </div>
  <div style="margin-top:10px;">
    <button id="vectorTunerSaveBtn" style="width:100%;background:#0f766e;border-color:#0f766e;color:#fff;">Save Vector Config</button>
  </div>
</div>
  <script>

</script>
</body>
</html>

