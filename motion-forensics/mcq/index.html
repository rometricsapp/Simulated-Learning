<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ROMetrics ‚Äî Forensic Assessment Hub</title>
  <style>
    body { background:#07101b; color:#e5eefc; font-family:system-ui,-apple-system,sans-serif; margin:0; padding:40px 20px; display:flex; flex-direction:column; align-items:center; }
    #hub { max-width:800px; width:100%; }
    .header { text-align:center; margin-bottom:40px; }
    .header h1 { color:#38bdf8; font-size:32px; margin:0; }
    
    .module-row { background:rgba(15,23,42,.78); border:1px solid rgba(148,163,184,.2); border-radius:16px; margin-bottom:12px; overflow:hidden; transition: 0.3s; }
    .module-header { padding:20px 24px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; user-select:none; }
    
    /* Locked State */
    .module-row.locked { opacity: 0.5; cursor: not-allowed; border-style: dashed; }
    .module-row.locked .module-header { cursor: not-allowed; }
    
    .module-title { font-weight:800; font-size:18px; }
    .status-badge { font-size:12px; font-weight:900; padding:4px 10px; border-radius:99px; }
    .status-pending { background:rgba(148,163,184,0.1); color:#a8c0da; }
    .status-done { background:rgba(74,222,128,0.1); color:#4ade80; border:1px solid rgba(74,222,128,0.2); }
    .status-locked { background:rgba(248,113,113,0.1); color:#f87171; }

    .module-content { display:none; padding:0 32px 32px 32px; border-top:1px solid rgba(148,163,184,.1); }
    .module-row.active { border-color:#38bdf8; box-shadow:0 10px 30px rgba(0,0,0,0.4); }
    .module-row.active .module-content { display:block; }

    .q-block { margin-top:30px; }
    .q-text { font-weight:700; font-size:16px; margin-bottom:15px; color:#cfe3ff; }
    .opt { display:block; border:1px solid rgba(148,163,184,.15); background:rgba(7,16,27,.3); padding:12px 16px; border-radius:12px; margin-bottom:8px; cursor:pointer; font-size:14px; }
    .opt.selected { border-color:#38bdf8; background:rgba(56,189,248,.1); }
    .opt.correct-review { border-color:#4ade80; background:rgba(74,222,128,0.05); color:#4ade80; }
    
    .btn { background:#38bdf8; color:#07101b; border:none; padding:14px; border-radius:12px; font-weight:900; cursor:pointer; width:100%; margin-top:20px; }
    .btn-outline { background:transparent; border:1px solid #38bdf8; color:#38bdf8; }
    #returnBtn { margin-bottom:20px; max-width:250px; align-self: flex-start;}
  </style>
</head>
<body>

<div id="hub">
  <button id="returnBtn" class="btn btn-outline" onclick="window.location.href='https://kingto89.github.io/ROMetrics.com/motion-forensics/'">‚Üê Back to Motion Forensics</button>
  <div class="header">
    <h1>Forensic Assessment Hub</h1>
    <p style="color:#a8c0da">Validate forensic findings for each completed lab section.</p>
  </div>
  <div id="accordionContainer"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-functions.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDgGxWE5p61STS5nORS_LnWC07QjJMfz1k",
    authDomain: "rometrics-labs-v1.firebaseapp.com",
    projectId: "rometrics-labs-v1",
    storageBucket: "rometrics-labs-v1.firebasestorage.app",
    messagingSenderId: "201479625260",
    appId: "1:201479625260:web:1a06b496f22f52e8cdcf89"
  };

  const app = initializeApp(firebaseConfig);
  const functions = getFunctions(app);
  const getMCQ = httpsCallable(functions, 'get_mcq_data');

  let MODULE_DATA = {};
  let TOTAL_LABS = 21; // Total physical labs in the curriculum

  async function startAssessment() {
    try {
      // Fetching all data to populate the hub
      const response = await getMCQ({ moduleId: "ALL" });
      MODULE_DATA = response.data.data; 
      
      console.log("Vault Connection Successful");
      initHub();
    } catch (err) {
      console.error("Vault Connection Failed:", err);
      document.getElementById('accordionContainer').innerHTML = '<p style="color:#f87171">Error connecting to secure vault. Please refresh.</p>';
    }
  }

  function initHub() {
    const container = document.getElementById('accordionContainer');
    container.innerHTML = '';
    
    for (let i = 1; i <= TOTAL_LABS; i++) {
      const id = `FL-${String(i).padStart(3, '0')}`;
      const hasData = !!(MODULE_DATA && MODULE_DATA[id]);
      const isDone = localStorage.getItem(`${id}_Status`) === 'completed';
      
      const prevId = `FL-${String(i-1).padStart(3, '0')}`;
      const prevDone = i === 1 || localStorage.getItem(`${prevId}_Status`) === 'completed';
      
      const isLocked = !prevDone || !hasData;
      
      const row = document.createElement('div');
      row.className = `module-row ${isLocked ? 'locked' : ''}`;
      row.id = `row-${id}`;
      
      const titleText = hasData ? MODULE_DATA[id].title : "Under Development (Lab Section Pending)";
      const badgeClass = isDone ? 'status-done' : (isLocked ? 'status-locked' : 'status-pending');
      const badgeText = isDone ? '‚úì VALIDATED' : (isLocked ? 'LOCKED' : 'READY');

      row.innerHTML = `
        <div class="module-header" onclick="handleToggle('${id}', ${isLocked}, ${hasData})">
          <div class="module-title">${isLocked ? 'üîí ' : ''}${id}: ${titleText}</div>
          <div class="status-badge ${badgeClass}">${badgeText}</div>
        </div>
        <div class="module-content" id="content-${id}"></div>
      `;
      
      container.appendChild(row);
      if (hasData) renderQuiz(id);
    }
  }

  window.handleToggle = function(id, isLocked, hasData) {
    if (!hasData) {
      alert("This module is currently under development.");
      return;
    }
    if (isLocked) {
      alert("Validation Locked: Complete the previous lab section first.");
      return;
    }
    const target = document.getElementById(`row-${id}`);
    const isActive = target.classList.contains('active');
    document.querySelectorAll('.module-row').forEach(r => r.classList.remove('active'));
    if (!isActive) target.classList.add('active');
  };

  function renderQuiz(modId) {
    const contentDiv = document.getElementById(`content-${modId}`);
    const isDone = localStorage.getItem(`${modId}_Status`) === 'completed';
    const questions = MODULE_DATA[modId].questions;
    
    questions.forEach((item, qIdx) => {
      const qBlock = document.createElement('div');
      qBlock.className = 'q-block';
      qBlock.innerHTML = `<div class="q-text">${qIdx + 1}. ${item.q}</div>`;
      
      item.opts.forEach(opt => {
        const letter = opt.trim().charAt(0);
        const div = document.createElement('div');
        div.className = 'opt' + (isDone && letter === item.correct ? ' correct-review' : '');
        div.textContent = opt;
        
        if (!isDone) {
          div.onclick = () => {
            qBlock.querySelectorAll('.opt').forEach(el => el.classList.remove('selected'));
            div.classList.add('selected');
            item.userAnswer = letter;
          };
        }
        qBlock.appendChild(div);
      });
      contentDiv.appendChild(qBlock);
    });

    if (!isDone) {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = 'Validate Findings';
      btn.onclick = () => {
        if (!questions.every(q => q.userAnswer)) return alert("Please record all answers before validating.");
        
        const correctCount = questions.filter(q => q.userAnswer === q.correct).length;
        
        if (correctCount === questions.length) {
          localStorage.setItem(`${modId}_Status`, 'completed');
          alert("Findings Validated! Access to next module granted.");
          location.reload();
        } else {
          alert("Inaccurate findings detected. Review lab data and re-assess.");
        }
      };
      contentDiv.appendChild(btn);
    }
  }

  // Execute
  startAssessment();
</script>
</body>
</html>
